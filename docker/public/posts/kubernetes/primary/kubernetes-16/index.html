<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>实战案例-Cert-Manager 实现 K8s 服务域名证书自动化续签 (十六) - Ryan&#39;s Notebook</title><meta name="author" content="Ryan">
<meta name="author-link" content="https://github.com/ryanxin7">
<meta name="description" content="前言 说到免费的SSL证书，大家首先想到的肯定是Let’s Encrypt，而使用过Let’s Encrypt的同学应该也知道，其有效期只有三个月" /><meta name="keywords" content='k8s进阶训练营' /><meta itemprop="name" content="实战案例-Cert-Manager 实现 K8s 服务域名证书自动化续签 (十六)">
<meta itemprop="description" content="前言 说到免费的SSL证书，大家首先想到的肯定是Let’s Encrypt，而使用过Let’s Encrypt的同学应该也知道，其有效期只有三个月"><meta itemprop="datePublished" content="2023-02-21T00:00:00+00:00" />
<meta itemprop="dateModified" content="2023-02-21T00:00:00+00:00" />
<meta itemprop="wordCount" content="4586"><meta itemprop="image" content="https://hg-xnlog.github.io/logo.png"/>
<meta itemprop="keywords" content="k8s进阶训练营," /><meta property="og:title" content="实战案例-Cert-Manager 实现 K8s 服务域名证书自动化续签 (十六)" />
<meta property="og:description" content="前言 说到免费的SSL证书，大家首先想到的肯定是Let’s Encrypt，而使用过Let’s Encrypt的同学应该也知道，其有效期只有三个月" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hg-xnlog.github.io/posts/kubernetes/primary/kubernetes-16/" /><meta property="og:image" content="https://hg-xnlog.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-21T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-02-21T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://hg-xnlog.github.io/logo.png"/>

<meta name="twitter:title" content="实战案例-Cert-Manager 实现 K8s 服务域名证书自动化续签 (十六)"/>
<meta name="twitter:description" content="前言 说到免费的SSL证书，大家首先想到的肯定是Let’s Encrypt，而使用过Let’s Encrypt的同学应该也知道，其有效期只有三个月"/>
<meta name="application-name" content="Ryan’s Notebook">
<meta name="apple-mobile-web-app-title" content="Ryan’s Notebook"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://hg-xnlog.github.io/posts/kubernetes/primary/kubernetes-16/" /><link rel="prev" href="https://hg-xnlog.github.io/posts/kubernetes/primary/kubernetes-14/" /><link rel="next" href="https://hg-xnlog.github.io/posts/kubernetes/primary/kubernetes-17/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "实战案例-Cert-Manager 实现 K8s 服务域名证书自动化续签 (十六)",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/hg-xnlog.github.io\/posts\/kubernetes\/primary\/kubernetes-16\/"
    },"genre": "posts","keywords": "k8s进阶训练营","wordcount":  4586 ,
    "url": "https:\/\/hg-xnlog.github.io\/posts\/kubernetes\/primary\/kubernetes-16\/","datePublished": "2023-02-21T00:00:00+00:00","dateModified": "2023-02-21T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Ryan"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="wide"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper" data-github-corner="right">
    <div class="header-title">
      <a href="/" title="Ryan&#39;s Notebook"><img loading="lazy" src="/images/pow.png" srcset="/images/pow.png, /images/pow.png 1.5x, /images/pow.png 2x" sizes="auto" data-title="Ryan&#39;s Notebook" data-alt="Ryan&#39;s Notebook" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/><span class="header-title-text">Ryan’s Notebook</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 所有文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/friends/"
                title="友情链接"
                
              ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-solid fa-user-tie fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Ryan&#39;s Notebook"><img loading="lazy" src="/images/pow.png" srcset="/images/pow.png, /images/pow.png 1.5x, /images/pow.png 2x" sizes="auto" data-title="/images/pow.png" data-alt="/images/pow.png" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/><span class="header-title-text">Ryan’s Notebook</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 所有文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/friends/"
                  title="友情链接"
                  
                ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-solid fa-user-tie fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li
              class="menu-item text-center"
            ><a
                  class="menu-link"
                  href="https://github.com/ryanxin7/hg-xnlog"
                  title="GitHub"
                  rel="noopener noreferrer" target="_blank"
                ><i class='fa-brands fa-github fa-fw' aria-hidden='true'></i> </a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>实战案例-Cert-Manager 实现 K8s 服务域名证书自动化续签 (十六)</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="https://github.com/ryanxin7" title="作者"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><img loading="lazy" src="/images/avatar.png" srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x" sizes="auto" data-title="Ryan" data-alt="Ryan" class="avatar" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/>&nbsp;Ryan</a></span>
          <span class="post-category">收录于 <a href="/categories/kubernetes/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Kubernetes</a></span></div>
      <div class="post-meta-line"><span title="发布于 2023-02-21 00:00:00"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden="true"></i><time datetime="2023-02-21">2023-02-21</time></span>&nbsp;<span title="更新于 2023-02-21 00:00:00"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden="true"></i><time datetime="2023-02-21">2023-02-21</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 4586 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 10 分钟</span>&nbsp;<span id="busuanzi_container_page_pv" class="busuanzi_visitors comment-visitors" data-flag-title="实战案例-Cert-Manager 实现 K8s 服务域名证书自动化续签 (十六)">
            <i class="fa-regular fa-eye fa-fw me-1" aria-hidden="true"></i><span id="busuanzi_value_page_pv">-</span>&nbsp;次阅读
          </span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#什么是cert-manager-">什么是cert-manager ?</a>
      <ul>
        <li><a href="#1简介">1.简介</a></li>
        <li><a href="#2-设计理念">2. 设计理念</a></li>
        <li><a href="#3架构设计">3.架构设计</a></li>
        <li><a href="#4签发流程">4.签发流程</a></li>
      </ul>
    </li>
    <li><a href="#一安装cert-manager">一、安装cert-manager</a>
      <ul>
        <li><a href="#1替换镜像文件">1.替换镜像文件</a></li>
        <li><a href="#2执行yaml文件安装">2.执行yaml文件安装</a></li>
        <li><a href="#3查看pod运行情况">3.查看pod运行情况</a></li>
      </ul>
    </li>
    <li><a href="#二创建-cert-manager-的证书颁发实体对象">二、创建 cert-manager 的证书颁发实体对象</a>
      <ul>
        <li><a href="#1创建-staging-环境的证书颁发者-issuer">1.创建 staging 环境的证书颁发者 issuer</a></li>
        <li><a href="#2创建-prod-环境的证书颁发者-issuer">2.创建 prod 环境的证书颁发者 issuer</a></li>
        <li><a href="#3创建-staging-环境的证书颁发者-clusterissuer">3.创建 staging 环境的证书颁发者 ClusterIssuer</a></li>
        <li><a href="#4创建-prod-环境的证书颁发者-clusterissuer">4.创建 Prod 环境的证书颁发者 ClusterIssuer</a></li>
      </ul>
    </li>
    <li><a href="#三应用实践测试">三、应用实践测试</a>
      <ul>
        <li><a href="#1创建一个集群级的签发机构">1.创建一个集群级的签发机构</a></li>
        <li><a href="#2配置dns域名解析">2.配置dns域名解析</a></li>
        <li><a href="#3-创建证书资源">3. 创建证书资源</a></li>
        <li><a href="#4-查看cert-manager运行情况">4. 查看cert-manager运行情况</a></li>
        <li><a href="#5问题排查">5.问题排查</a></li>
        <li><a href="#6部署一个服务测试证书">6.部署一个服务测试证书</a></li>
        <li><a href="#7通过域名访问测试">7.通过域名访问测试</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><div class="details admonition warning open">
      <div class="details-summary admonition-title">
        <i class="icon fa-solid fa-exclamation-triangle fa-fw" aria-hidden="true"></i>警告<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
      </div>
      <div class="details-content">
        <div class="admonition-content">本文最后更新于 2023-02-21，文中内容可能已过时。</div>
      </div>
    </div><h2 id="前言">前言</h2>
<p>说到免费的SSL证书，大家首先想到的肯定是Let’s Encrypt，而使用过Let’s Encrypt的同学应该也知道，其有效期只有三个月，三个月后要重新续期。github上也有类似的脚本可以做到自动续期。那如果是在k8s上使用该免费证书，又如何操作的呢？这里cert-manager就派上用场了。</p>
<h2 id="什么是cert-manager-">什么是cert-manager ?</h2>
<h3 id="1简介">1.简介</h3>
<p>cert-manager 是一个云原生证书管理开源项目，它简化了在 Kubernetes 集群中web服务管理Https证书的过程。</p>
<p>支持从多种证书签发机构申请证书，包括 Let&rsquo;s Encrypt、HashiCorp Vault 和 Venafi。</p>
<p>它将证书和证书颁发机构添加为 Kubernetes  资源类型，并且简化获取、更新和使用这些证书，并在证书到期前的尝试续订证书，确保证书有效并及时更新。</p>
<p>在Kubernetes集群中使用 HTTPS 协议，需要一个证书管理器、一个证书自动签发服务，主要通过 Ingress 来发布 HTTPS 服务，因此需要Ingress Controller并进行配置，启用 HTTPS 及其路由。</p>
<p><img loading="lazy" src="http://cdn1.ryanxin.live/high-level-overview.svg" srcset="http://cdn1.ryanxin.live/high-level-overview.svg, http://cdn1.ryanxin.live/high-level-overview.svg 1.5x, http://cdn1.ryanxin.live/high-level-overview.svg 2x" sizes="auto" data-title="http://cdn1.ryanxin.live/high-level-overview.svg" data-alt="http://cdn1.ryanxin.live/high-level-overview.svg" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>角色</p>
<ul>
<li><strong>Issuer/ClusterIssuer</strong>: 用于指示 cert-manager 用什么方式签发证书，本文主要讲解签发免费证书的 ACME 方式。ClusterIssuer 与 Issuer 的唯一区别就是 Issuer 只能用来签发自己所在 namespace 下的证书，ClusterIssuer 可以签发任意 namespace 下的证书。</li>
<li><strong>Certificate</strong>: 用于告诉 cert-manager 我们想要什么域名的证书以及签发证书所需要的一些配置，包括对 Issuer/ClusterIssuer 的引用。</li>
</ul>
<h3 id="2-设计理念">2. 设计理念</h3>
<p>Cert-Manager 是将 TLS 证书视为一种资源，就像 Pod、Service 和 Deployment 一样，可以使用 Kubernetes API 进行管理。它使用了自定义资源定义（CRD）机制，通过扩展 Kubernetes API，为证书的生命周期提供了标准化的管理方式。</p>
<h3 id="3架构设计">3.架构设计</h3>
<p>Cert-Manager 的架构分为两层：控制层和数据层。</p>
<ul>
<li>
<p>控制层: 负责证书的管理，包括证书的创建、更新和删除等；</p>
</li>
<li>
<p>数据层: 负责存储证书相关的数据，包括证书的私钥、证书请求、证书颁发机构等。</p>
</li>
<li>
<p>Cert-Manager 支持多种证书颁发机构，包括<strong>自签名证书selfSigned</strong>、Let&rsquo;s Encrypt、HashiCorp Vault、Venafi 等。它还支持多种验证方式，包括 HTTP 验证、DNS 验证和 TLS-SNI 验证等。这些验证方式可以帮助确保证书的颁发机构是可信的，并且确保证书的私钥不会泄露。</p>
</li>
</ul>
<h3 id="4签发流程">4.签发流程</h3>
<p>在 Kubernetes 中，cert-manager 通过以下流程创建资源对象以签发证书：</p>
<ol>
<li>创建一个 <strong>CertificateRequest</strong> 对象，包含证书的相关信息，例如证书名称、域名等。该对象指定了使用的 <strong>Issuer 或 ClusterIssuer</strong>，以及证书签发完成后，需要存储的 <strong>Secret</strong> 的名称。</li>
<li>Issuer 或 ClusterIssuer 会根据证书请求的相关信息，创建一个 Order 对象，表示需要签发一个证书。该对象包含了签发证书所需的域名列表、证书签发机构的名称等信息。</li>
<li>证书签发机构根据 Order 对象中的信息创建一个或多个 <strong>Challenge</strong> 对象，用于验证证书申请者对该域名的控制权。Challenge 对象包含一个 DNS 记录或 HTTP 服务，证明域名的所有权。</li>
<li>cert-manager 接收到 Challenge 对象的回应ChallengeResponse后，会将其更新为已解决状态。证书签发机构会检查所有的 Challenge 对象，如果全部通过验证，则会签发证书。</li>
<li>签发证书完成后，证书签发机构会将证书信息写入 Secret 对象，同时将 Order 对象标记为已完成。证书信息现在可以被其他部署对象使用。</li>
</ol>
<div class="highlight" id="id-1"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">+-------------+
</span></span><span class="line"><span class="cl">              <span class="p">|</span>             <span class="p">|</span>
</span></span><span class="line"><span class="cl">              <span class="p">|</span>   Ingress/  <span class="p">|</span>
</span></span><span class="line"><span class="cl">              <span class="p">|</span> annotations <span class="p">|</span>
</span></span><span class="line"><span class="cl">              <span class="p">|</span>             <span class="p">|</span>
</span></span><span class="line"><span class="cl">              +------+------+
</span></span><span class="line"><span class="cl">                     <span class="p">|</span>
</span></span><span class="line"><span class="cl">                     <span class="p">|</span> watch ingress change
</span></span><span class="line"><span class="cl">                     <span class="p">|</span>
</span></span><span class="line"><span class="cl">                     v
</span></span><span class="line"><span class="cl">              +-------------+
</span></span><span class="line"><span class="cl">              <span class="p">|</span>             <span class="p">|</span>
</span></span><span class="line"><span class="cl">              <span class="p">|</span>   Issuer/   <span class="p">|</span>
</span></span><span class="line"><span class="cl">              <span class="p">|</span> ClusterIssuer <span class="p">|</span>
</span></span><span class="line"><span class="cl">              <span class="p">|</span>             <span class="p">|</span>
</span></span><span class="line"><span class="cl">              +------+------+
</span></span><span class="line"><span class="cl">                     <span class="p">|</span>
</span></span><span class="line"><span class="cl">                     <span class="p">|</span> Create CertificateRequest
</span></span><span class="line"><span class="cl">                     <span class="p">|</span>
</span></span><span class="line"><span class="cl">                     v
</span></span><span class="line"><span class="cl">              +------+------+
</span></span><span class="line"><span class="cl">              <span class="p">|</span>             <span class="p">|</span>
</span></span><span class="line"><span class="cl">              <span class="p">|</span>CertificateRequest<span class="p">|</span>
</span></span><span class="line"><span class="cl">              <span class="p">|</span>             <span class="p">|</span>
</span></span><span class="line"><span class="cl">              +------+------+
</span></span><span class="line"><span class="cl">                     <span class="p">|</span>
</span></span><span class="line"><span class="cl">                     <span class="p">|</span> Create Order
</span></span><span class="line"><span class="cl">                     <span class="p">|</span>
</span></span><span class="line"><span class="cl">                     v
</span></span><span class="line"><span class="cl">              +------+------+
</span></span><span class="line"><span class="cl">              <span class="p">|</span>             <span class="p">|</span>
</span></span><span class="line"><span class="cl">              <span class="p">|</span>      Order  <span class="p">|</span>
</span></span><span class="line"><span class="cl">              <span class="p">|</span>             <span class="p">|</span>
</span></span><span class="line"><span class="cl">              +------+------+
</span></span><span class="line"><span class="cl">                     <span class="p">|</span>
</span></span><span class="line"><span class="cl">                     <span class="p">|</span> Create Challenges
</span></span><span class="line"><span class="cl">                     <span class="p">|</span>
</span></span><span class="line"><span class="cl">                     v
</span></span><span class="line"><span class="cl">              +------+------+
</span></span><span class="line"><span class="cl">              <span class="p">|</span>             <span class="p">|</span>
</span></span><span class="line"><span class="cl">              <span class="p">|</span>  Challenge  <span class="p">|</span>
</span></span><span class="line"><span class="cl">              <span class="p">|</span>             <span class="p">|</span>
</span></span><span class="line"><span class="cl">              +------+------+
</span></span><span class="line"><span class="cl">                     <span class="p">|</span>
</span></span><span class="line"><span class="cl">                     <span class="p">|</span> Respond to Challenge
</span></span><span class="line"><span class="cl">                     <span class="p">|</span>
</span></span><span class="line"><span class="cl">                     v
</span></span><span class="line"><span class="cl">              +------+------+
</span></span><span class="line"><span class="cl">              <span class="p">|</span>             <span class="p">|</span>
</span></span><span class="line"><span class="cl">              <span class="p">|</span>ChallengeResponse<span class="p">|</span>
</span></span><span class="line"><span class="cl">              <span class="p">|</span>             <span class="p">|</span>
</span></span><span class="line"><span class="cl">              +------+------+
</span></span><span class="line"><span class="cl">                     <span class="p">|</span>
</span></span><span class="line"><span class="cl">                     <span class="p">|</span> Issue Certificate
</span></span><span class="line"><span class="cl">                     <span class="p">|</span>
</span></span><span class="line"><span class="cl">                     v
</span></span><span class="line"><span class="cl">              +------+------+
</span></span><span class="line"><span class="cl">              <span class="p">|</span>             <span class="p">|</span>
</span></span><span class="line"><span class="cl">              <span class="p">|</span>     Secret  <span class="p">|</span>
</span></span><span class="line"><span class="cl">              <span class="p">|</span>             <span class="p">|</span>
</span></span><span class="line"><span class="cl">              +------+------+</span></span></code></pre></div><h2 id="一安装cert-manager">一、安装cert-manager</h2>
<p><a href="https://cert-manager.io/docs/installation/"target="_blank" rel="external nofollow noopener noreferrer">https://cert-manager.io/docs/installation/</a></p>
<div class="highlight" id="id-2"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">wget https://github.com/cert-manager/cert-manager/releases/download/v1.12.0/cert-manager.yaml</span></span></code></pre></div><p>查看yaml文件中的镜像</p>
<div class="highlight" id="id-3"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">quay.io/jetstack/cert-manager-cainjector:v1.12.0
</span></span><span class="line"><span class="cl">quay.io/jetstack/cert-manager-webhook:v1.12.0
</span></span><span class="line"><span class="cl">quay.io/jetstack/cert-manager-controller:v1.12.0
</span></span><span class="line"><span class="cl">quay.io/jetstack/cert-manager-acmesolver:v1.12.0</span></span></code></pre></div><h3 id="1替换镜像文件">1.替换镜像文件</h3>
<div class="highlight" id="id-4"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sed -i <span class="s1">&#39;s#quay.io\/jetstack#harbor.ceamg.com\/baseimages#g&#39;</span> /yaml/cert-manager/cert-manager.yaml</span></span></code></pre></div><h3 id="2执行yaml文件安装">2.执行yaml文件安装</h3>
<pre tabindex="0"><code>kubectl apply -f cert-manager.yaml</code></pre><h3 id="3查看pod运行情况">3.查看pod运行情况</h3>
<div class="highlight" id="id-6"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@k8s-made-01-32:/yaml/cert-manager# kubectl get pod -n cert-manager
</span></span><span class="line"><span class="cl">NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">cert-manager-5c458b9858-gkxzv              1/1     Running   <span class="m">0</span>          21s
</span></span><span class="line"><span class="cl">cert-manager-cainjector-6fd86f6d9d-w4vhv   1/1     Running   <span class="m">0</span>          21s
</span></span><span class="line"><span class="cl">cert-manager-webhook-5f6c479b6b-mcs4r      1/1     Running   <span class="m">0</span>          21s</span></span></code></pre></div><h2 id="二创建-cert-manager-的证书颁发实体对象">二、创建 cert-manager 的证书颁发实体对象</h2>
<p>cert-manager 的 <code>Issuer</code> 和 <code>ClusterIssuer</code> 都是用来定义证书颁发的实体的资源对象。</p>
<ul>
<li><code>Issuer</code> 是命名空间级别的资源，用于在命名空间内颁发证书。例如，当您需要使用自签名证书来保护您的服务，或者使用 Let&rsquo;s Encrypt 等公共证书颁发机构来颁发证书时，可以使用 Issuer。</li>
<li><code>ClusterIssuer</code> 是集群级别的资源，用于在整个集群内颁发证书。例如，当您需要使用公司的内部 CA 来颁发证书时，可以使用 ClusterIssuer。</li>
</ul>
<p>知道两者之间的区别之后，你就可以根据自己的使用情况来决定自己的 issuer 的类型。</p>
<p>这里列出几种常用的 issuer 使用模板：</p>
<h3 id="1创建-staging-环境的证书颁发者-issuer">1.创建 staging 环境的证书颁发者 issuer</h3>
<div class="highlight" id="id-7"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># The ACME server URL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-staging-v02.api.letsencrypt.org/directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Email address used for ACME registration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">xxx@qq.com</span><span class="w"> </span><span class="c">#此处填写你的邮箱地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Name of a secret used to store the ACME account private key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Enable the HTTP-01 challenge provider</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">http01</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">class</span><span class="p">:</span><span class="w">  </span><span class="l">nginx</span></span></span></code></pre></div><blockquote>
<p>使用 staging 环境颁发的证书无法正常在公网使用，需要本地添加受信任根证书</p>
</blockquote>
<h3 id="2创建-prod-环境的证书颁发者-issuer">2.创建 prod 环境的证书颁发者 issuer</h3>
<div class="highlight" id="id-8"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># The ACME server URL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-v02.api.letsencrypt.org/directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Email address used for ACME registration 欢迎关注·云原生生态圈</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">xxx@qq.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Name of a secret used to store the ACME account private key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Enable the HTTP-01 challenge provider</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">http01</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span></span></span></code></pre></div><h3 id="3创建-staging-环境的证书颁发者-clusterissuer">3.创建 staging 环境的证书颁发者 ClusterIssuer</h3>
<div class="highlight" id="id-9"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># The ACME server URL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-staging-v02.api.letsencrypt.org/directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Email address used for ACME registration 欢迎关注·云原生生态圈</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">xxx@qq.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Name of a secret used to store the ACME account private key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-staging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Enable the HTTP-01 challenge provider</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">http01</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">class</span><span class="p">:</span><span class="w">  </span><span class="l">nginx</span></span></span></code></pre></div><h3 id="4创建-prod-环境的证书颁发者-clusterissuer">4.创建 Prod 环境的证书颁发者 ClusterIssuer</h3>
<div class="highlight" id="id-10"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># The ACME server URL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-v02.api.letsencrypt.org/directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Email address used for ACME registration 欢迎关注·云原生生态圈</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">xxx@qq.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Name of a secret used to store the ACME account private key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Enable the HTTP-01 challenge provider</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">http01</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span></span></span></code></pre></div><h2 id="三应用实践测试">三、应用实践测试</h2>
<h3 id="1创建一个集群级的签发机构">1.创建一个集群级的签发机构</h3>
<div class="highlight" id="id-11"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod1234</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">acme</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">https://acme-v02.api.letsencrypt.org/directory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l">zxx@ceamg.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod1234</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">http01</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span></span></span></code></pre></div><p><strong>说明</strong>：</p>
<ul>
<li><code>metadata.name</code> 是我们创建的签发机构的名称，后面我们创建证书的时候会引用它</li>
<li><code>spec.acme.email</code> 是你自己的邮箱，证书快过期的时候会有邮件提醒，不过 cert-manager 会利用 acme 协议自动给我们重新颁发证书来续期</li>
<li><code>spec.acme.server</code> 是 acme 协议的服务端，我们这里用 Let’s Encrypt，这个地址就写死成这样就行</li>
<li><code>spec.acme.privateKeySecretRef</code> 指示此签发机构的私钥将要存储到哪个 Secret 对象中，名称不重要</li>
<li><code>spec.acme.http01</code> 这里指示签发机构使用 HTTP-01 的方式进行 acme 协议 (还可以用 DNS 方式，acme 协议的目的是证明这台机器和域名都是属于你的，然后才准许给你颁发证书)</li>
</ul>
<p><strong>执行发布命令</strong></p>
<div class="highlight" id="id-12"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl apply -f cluster-issuer.yaml</span></span></code></pre></div><h3 id="2配置dns域名解析">2.配置dns域名解析</h3>
<p><img loading="lazy" src="http://cdn1.ryanxin.live/image-20230616164228233.png" srcset="http://cdn1.ryanxin.live/image-20230616164228233.png, http://cdn1.ryanxin.live/image-20230616164228233.png 1.5x, http://cdn1.ryanxin.live/image-20230616164228233.png 2x" sizes="auto" data-title="image-20230616164228233" data-alt="image-20230616164228233" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h3 id="3-创建证书资源">3. 创建证书资源</h3>
<div class="highlight" id="id-13"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-ceamg-com-cert</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cert-manager.io/issue-temporary-certificate</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-ceamg-com-tls</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod1234</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIssuer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="l">2160h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">renewBefore</span><span class="p">:</span><span class="w"> </span><span class="l">360h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">k8s.ceamg.com</span></span></span></code></pre></div><p><strong>说明</strong>：</p>
<ul>
<li>
<p><code>spec.secretName</code> 指示证书最终存到哪个 Secret 中</p>
</li>
<li>
<p><code>spec.issuerRef.kind</code> 值为 ClusterIssuer 说明签发机构不在本 namespace 下，而是在全局</p>
</li>
<li>
<p><code>spec.issuerRef.name</code> 我们创建的签发机构的名称 (ClusterIssuer.metadata.name)</p>
</li>
<li>
<p><code>spec.dnsNames</code> 指示该证书的可以用于哪些域名,与域名解析的一致</p>
</li>
<li>
<p><code>renewBefore</code> 字段来控制证书到期前多久会被更新</p>
</li>
<li>
<p><code>duration</code>字段来指定自签名证书的期限</p>
<div class="highlight" id="id-14"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl apply -f Certificate.yaml</span></span></code></pre></div></li>
</ul>
<h3 id="4-查看cert-manager运行情况">4. 查看cert-manager运行情况</h3>
<div class="highlight" id="id-15"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl logs -f <span class="k">$(</span>kubectl get pods -n cert-manager <span class="p">|</span> grep cert-manager <span class="p">|</span> grep -v <span class="s1">&#39;cainjector\|webhook&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span> -n cert-manager</span></span></code></pre></div><p><strong>当然，也可以查看临时生成的专门验证证书的 Ingress 对象的运行情况</strong></p>
<p>临时对象<code>cm-acme-http-solver-xxxx</code>从创建到消亡的过程</p>
<pre tabindex="0"><code>kubectl get pod -A | grep &#34;cm*&#34;</code></pre><p><strong>查看certificate创建结果</strong></p>
<div class="highlight" id="id-17"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@k8s-made-01-32:/etc/kubeasz/clusters/xx-prod# kubectl get certificate
</span></span><span class="line"><span class="cl">NAME                 READY   SECRET              AGE
</span></span><span class="line"><span class="cl">k8s-ceamg-com-cert   True    k8s-ceamg-com-tls   1h</span></span></code></pre></div><p>当READY为True时即为成功，详细可看cert-manager运行日志。</p>
<h3 id="5问题排查">5.问题排查</h3>
<h4 id="问题1"><strong>问题1：</strong></h4>
<div class="highlight" id="id-18"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl logs -n cert-manager cert-manager-webhook-5f6c479b6b-mcs4r
</span></span><span class="line"><span class="cl">I0616 06:12:56.720433       <span class="m">1</span> logs.go:59<span class="o">]</span> http: TLS handshake error from 10.48.87.0:34244: EOF</span></span></code></pre></div><p><strong>解决方法</strong></p>
<p>在Ingress 或 Certificate resource 添加声明</p>
<div class="highlight" id="id-19"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">cert-manager.io/issue-temporary-certificate</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">acme.cert-manager.io/http01-edit-in-place</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#颁发一个临时的自签名证书在，供ingress controller 在颁发实际证书之前使用</span></span></span></code></pre></div><h4 id="问题2"><strong>问题2：</strong></h4>
<pre tabindex="0"><code>kubectl logs -n cert-manager cert-manager-5c458b9858-gkxzv
E0616 06:12:27.072543       1 sync.go:190] &#34;cert-manager/challenges: propagation check failed&#34; err=&#34;failed to perform self check GET request &#39;http://k8s.ceamg.com/.well-known/acme-challenge/OvQFFmEAO5016nAu1YC20RcgDtU2CsCPuoporE13ekw&#39;: Get \&#34;http://k8s.ceamg.com/.well-known/acme-challenge/OvQFFmEAO5016nAu1YC20RcgDtU2CsCPuoporE13ekw\&#34;: dial tcp 10.1.0.32:80: connect: connection refused&#34; resource_name=&#34;k8s-ceamg-com-cert-9rw4s-2953330747-2092136088&#34; resource_namespace=&#34;default&#34; resource_kind=&#34;Challenge&#34; resource_version=&#34;v1&#34; dnsName=&#34;k8s.ceamg.com&#34; type=HTTP-01</code></pre><p><strong>解决方法</strong></p>
<p>1.排查DNS解析</p>
<p><img loading="lazy" src="http://cdn1.ryanxin.live/image-20230616173738013.png" srcset="http://cdn1.ryanxin.live/image-20230616173738013.png, http://cdn1.ryanxin.live/image-20230616173738013.png 1.5x, http://cdn1.ryanxin.live/image-20230616173738013.png 2x" sizes="auto" data-title="http://cdn1.ryanxin.live/image-20230616173738013.png" data-alt="http://cdn1.ryanxin.live/image-20230616173738013.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>2.排查容器内DNS是否可以解析到域名</p>
<pre tabindex="0"><code>#启用一个busybox pod 测试pod环境内是否可以解析到域名
kubectl run --image=busybox:1.28.1 --rm -it -- sh
/ # ping k8s.ceamg.com
PING k8s.ceamg.com (10.1.0.91): 56 data bytes
64 bytes from 10.1.0.91: seq=0 ttl=63 time=0.377 ms
64 bytes from 10.1.0.91: seq=1 ttl=63 time=0.366 ms</code></pre><p>3.排查外网防火墙NAT地址转换策略</p>
<p><img loading="lazy" src="http://cdn1.ryanxin.live/image-20230616173901963.png" srcset="http://cdn1.ryanxin.live/image-20230616173901963.png, http://cdn1.ryanxin.live/image-20230616173901963.png 1.5x, http://cdn1.ryanxin.live/image-20230616173901963.png 2x" sizes="auto" data-title="image-20230616173901963" data-alt="image-20230616173901963" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>将公网地址转发到后端Haproxy代理节点，且有匹配数。</p>
<p>4.排查WAF防火墙端口策略</p>
<p><img loading="lazy" src="http://cdn1.ryanxin.live/image-20230616174217817.png" srcset="http://cdn1.ryanxin.live/image-20230616174217817.png, http://cdn1.ryanxin.live/image-20230616174217817.png 1.5x, http://cdn1.ryanxin.live/image-20230616174217817.png 2x" sizes="auto" data-title="http://cdn1.ryanxin.live/image-20230616174217817.png" data-alt="http://cdn1.ryanxin.live/image-20230616174217817.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>ACME 认证只需要放通80和443端口即可</p>
<p>5.依次检查certificate、challenges、certificaterequests</p>
<pre tabindex="0"><code> kubectl describe certificate k8s-ceamg-com-cert</code></pre><pre tabindex="0"><code>kubectl describe challenges.acme.cert-manager.io</code></pre><pre tabindex="0"><code>kubectl describe certificaterequests.cert-manager.io</code></pre><h3 id="6部署一个服务测试证书">6.部署一个服务测试证书</h3>
<h4 id="1安装ingress-nginx">1.安装ingress-nginx</h4>
<p><a href="http://www.ryanxin.live/k8s/log/kubernetes-12.html"target="_blank" rel="external nofollow noopener noreferrer">Ingress-nginx详细安装过程</a></p>
<p>这里因为k8s版本为1.26.2所以选择 V1.71版本</p>
<p><img loading="lazy" src="http://cdn1.ryanxin.live/xxlog/image-20230619104014430.png" srcset="http://cdn1.ryanxin.live/xxlog/image-20230619104014430.png, http://cdn1.ryanxin.live/xxlog/image-20230619104014430.png 1.5x, http://cdn1.ryanxin.live/xxlog/image-20230619104014430.png 2x" sizes="auto" data-title="image-20230619104014430" data-alt="image-20230619104014430" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<div class="highlight" id="id-25"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">wget https://github.com/kubernetes/ingress-nginx/archive/refs/tag/controller-v1.7.1.tar.gz
</span></span><span class="line"><span class="cl">tar xvf controller-v1.7.1.tar.gz
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ingress-nginx-controller-v1.7.1/deploy/static/provider/baremetal/
</span></span><span class="line"><span class="cl"><span class="c1">#修改当前目录下的deploy.yaml，将镜像修改未国内镜像源</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat deploy.yaml <span class="p">|</span>grep image
</span></span><span class="line"><span class="cl">        image: harbor.ceamg.com/k8s-base/ingress-nginx-controller:v1.7.1
</span></span><span class="line"><span class="cl">        image: harbor.ceamg.com/k8s-base/kube-webhook-certgen:v20230312
</span></span><span class="line"><span class="cl">        image: harbor.ceamg.com/k8s-base/kube-webhook-certgen:v20230312</span></span></code></pre></div><h5 id="11-指定控制器nodeport地址">1.1 指定控制器NodePort地址</h5>
<div class="highlight" id="id-26"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">vim deploy.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/component</span><span class="p">:</span><span class="w"> </span><span class="l">controller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/instance</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/part-of</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/version</span><span class="p">:</span><span class="w"> </span><span class="m">1.7.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-nginx-controller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ipFamilies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">IPv4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ipFamilyPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">SingleStack</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">appProtocol</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">30020</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">appProtocol</span><span class="p">:</span><span class="w"> </span><span class="l">https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l">https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">30021</span></span></span></code></pre></div><h5 id="12-执行安装">1.2 执行安装</h5>
<div class="highlight" id="id-27"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl apply -f deploy.yaml
</span></span><span class="line"><span class="cl">amespace/ingress-nginx created
</span></span><span class="line"><span class="cl">serviceaccount/ingress-nginx created
</span></span><span class="line"><span class="cl">serviceaccount/ingress-nginx-admission created
</span></span><span class="line"><span class="cl">role.rbac.authorization.k8s.io/ingress-nginx created
</span></span><span class="line"><span class="cl">role.rbac.authorization.k8s.io/ingress-nginx-admission created
</span></span><span class="line"><span class="cl">clusterrole.rbac.authorization.k8s.io/ingress-nginx created
</span></span><span class="line"><span class="cl">clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission created
</span></span><span class="line"><span class="cl">rolebinding.rbac.authorization.k8s.io/ingress-nginx created
</span></span><span class="line"><span class="cl">rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
</span></span><span class="line"><span class="cl">clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created
</span></span><span class="line"><span class="cl">clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
</span></span><span class="line"><span class="cl">configmap/ingress-nginx-controller created
</span></span><span class="line"><span class="cl">service/ingress-nginx-controller created
</span></span><span class="line"><span class="cl">service/ingress-nginx-controller-admission created
</span></span><span class="line"><span class="cl">deployment.apps/ingress-nginx-controller created
</span></span><span class="line"><span class="cl">job.batch/ingress-nginx-admission-create created
</span></span><span class="line"><span class="cl">job.batch/ingress-nginx-admission-patch created
</span></span><span class="line"><span class="cl">ingressclass.networking.k8s.io/nginx created
</span></span><span class="line"><span class="cl">validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created</span></span></code></pre></div><h5 id="13-查看pod状态">1.3 查看pod状态</h5>
<div class="highlight" id="id-28"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">root@k8s-made-01-32:/etc/kubeasz/clusters/xx-prod# kubectl get pod -n ingress-nginx
</span></span><span class="line"><span class="cl">NAME                                        READY   STATUS      RESTARTS   AGE
</span></span><span class="line"><span class="cl">ingress-nginx-admission-create-qhk5g        0/1     Completed   <span class="m">0</span>          12s
</span></span><span class="line"><span class="cl">ingress-nginx-admission-patch-qn9kc         0/1     Completed   <span class="m">0</span>          12s
</span></span><span class="line"><span class="cl">ingress-nginx-controller-589f4f6875-drvlp   1/1     Running     <span class="m">0</span>          12s</span></span></code></pre></div><div class="highlight" id="id-29"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">root@k8s-made-01-32:/etc/kubeasz/clusters/xx-prod# kubectl get svc -n ingress-nginx
</span></span><span class="line"><span class="cl">NAME                                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
</span></span><span class="line"><span class="cl">ingress-nginx-controller             NodePort    10.68.201.220   &lt;none&gt;        80:30020/TCP,443:30021/TCP   15s
</span></span><span class="line"><span class="cl">ingress-nginx-controller-admission   ClusterIP   10.68.72.129    &lt;none&gt;        443/TCP                      15s</span></span></code></pre></div><h5 id="14-调整controller-副本数">1.4 调整controller 副本数</h5>
<p>默认情况下，ingress-nginx-controller只有一个副本，可以按需调整。</p>
<div class="highlight" id="id-30"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl scale -n ingress-nginx deployment ingress-nginx-controller --replicas<span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl">deployment.apps/ingress-nginx-controller scaled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--------------------------------------------------
</span></span><span class="line"><span class="cl">kubectl get pod -n ingress-nginx
</span></span><span class="line"><span class="cl">NAME                                        READY   STATUS      RESTARTS   AGE
</span></span><span class="line"><span class="cl">ingress-nginx-admission-create-qhk5g        0/1     Completed   <span class="m">0</span>          74s
</span></span><span class="line"><span class="cl">ingress-nginx-admission-patch-qn9kc         0/1     Completed   <span class="m">0</span>          74s
</span></span><span class="line"><span class="cl">ingress-nginx-controller-589f4f6875-drvlp   1/1     Running     <span class="m">0</span>          74s
</span></span><span class="line"><span class="cl">ingress-nginx-controller-589f4f6875-kw5t6   1/1     Running     <span class="m">0</span>          34s
</span></span><span class="line"><span class="cl">ingress-nginx-controller-589f4f6875-pj6g2   1/1     Running     <span class="m">0</span>          74s</span></span></code></pre></div><p><strong>查看pod 运行位置分布情况</strong></p>
<div class="highlight" id="id-31"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get pod -n ingress-nginx -o wide
</span></span><span class="line"><span class="cl">NAME                                        READY   STATUS      RESTARTS   AGE     IP             NODE        NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">ingress-nginx-admission-create-qhk5g        0/1     Completed   <span class="m">0</span>          3d12h   10.48.150.71   10.1.0.37   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">ingress-nginx-admission-patch-qn9kc         0/1     Completed   <span class="m">0</span>          3d12h   10.48.245.19   10.1.0.35   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">ingress-nginx-controller-589f4f6875-drvlp   1/1     Running     <span class="m">0</span>          2d22h   10.48.150.72   10.1.0.37   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">ingress-nginx-controller-589f4f6875-kw5t6   1/1     Running     <span class="m">0</span>          5m22s   10.48.245.21   10.1.0.35   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">ingress-nginx-controller-589f4f6875-pj6g2   1/1     Running     <span class="m">0</span>          3d12h   10.48.35.142   10.1.0.34   &lt;none&gt;           &lt;none&gt;</span></span></code></pre></div><p><strong>ingress-nginx-controller</strong> 服务分布在 10.1.0.34 、10.1.0.35 、10.1.0.37 这三个节点上</p>
<h5 id="15-在负载均衡器中添加后端节点">1.5 在负载均衡器中添加后端节点</h5>
<p>在负载均衡器中添加ingress-nginx-controller后端，以haproxy为例。</p>
<p>详见 <a href="http://www.ryanxin.live/haproxy/log/Haproxy-1.html"target="_blank" rel="external nofollow noopener noreferrer">Haproxy 安装及配置讲解</a></p>
<p>haproxy使用子配置文件保存配置</p>
<p>当业务众多时，将所有配置都放在一个配置文件中，会造成维护困难。可以考虑按业务分类，将配置信息拆分，放在不同的子配置文件中，从而达到方便维护的目的。</p>
<div class="highlight" id="id-32"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1">#创建子配置目录</span>
</span></span><span class="line"><span class="cl">mkdir /etc/haproxy/conf.d/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#创建子配置文件，注意：必须为cfg后缀</span>
</span></span><span class="line"><span class="cl">vim  /etc/haproxy/conf.d/cert-test.cfg
</span></span><span class="line"><span class="cl">listen ingress-nginx-controller-80
</span></span><span class="line"><span class="cl">       <span class="nb">bind</span> 10.1.0.91:80
</span></span><span class="line"><span class="cl">       option  tcplog
</span></span><span class="line"><span class="cl">       mode tcp
</span></span><span class="line"><span class="cl">       balance <span class="nb">source</span> <span class="c1">#后端节点</span>
</span></span><span class="line"><span class="cl">       server ingress-controller-server1 10.1.0.34:30020 check inter <span class="m">2000</span> fall <span class="m">3</span> rise <span class="m">5</span>
</span></span><span class="line"><span class="cl">       server ingress-controller-server2 10.1.0.35:30020 check inter <span class="m">2000</span> fall <span class="m">3</span> rise <span class="m">5</span>
</span></span><span class="line"><span class="cl">       server ingress-controller-server3 10.1.0.37:30020 check inter <span class="m">2000</span> fall <span class="m">3</span> rise <span class="m">5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">listen ingress-nginx-controller-443
</span></span><span class="line"><span class="cl">       <span class="nb">bind</span> 10.1.0.91:443
</span></span><span class="line"><span class="cl">       option  tcplog
</span></span><span class="line"><span class="cl">       mode tcp
</span></span><span class="line"><span class="cl">       balance <span class="nb">source</span> <span class="c1">#后端节点</span>
</span></span><span class="line"><span class="cl">       server ingress-controller-server1 10.1.0.34:30021 check inter <span class="m">2000</span> fall <span class="m">3</span> rise <span class="m">5</span>
</span></span><span class="line"><span class="cl">       server ingress-controller-server2 10.1.0.35:30021 check inter <span class="m">2000</span> fall <span class="m">3</span> rise <span class="m">5</span>
</span></span><span class="line"><span class="cl">       server ingress-controller-server3 10.1.0.37:30021 check inter <span class="m">2000</span> fall <span class="m">3</span> rise <span class="m">5</span></span></span></code></pre></div><p><strong>添加子配置目录到unit文件中</strong></p>
<div class="highlight" id="id-33"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>Unit<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Description</span><span class="o">=</span>HAProxy Load Balancer
</span></span><span class="line"><span class="cl"><span class="nv">Documentation</span><span class="o">=</span>man:haproxy<span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">Documentation</span><span class="o">=</span>file:/usr/share/doc/haproxy/configuration.txt.gz
</span></span><span class="line"><span class="cl"><span class="nv">After</span><span class="o">=</span>network-online.target rsyslog.service
</span></span><span class="line"><span class="cl"><span class="nv">Wants</span><span class="o">=</span>network-online.target
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Service<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/default/haproxy
</span></span><span class="line"><span class="cl"><span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/sysconfig/haproxy
</span></span><span class="line"><span class="cl"><span class="nv">BindReadOnlyPaths</span><span class="o">=</span>/dev/log:/var/lib/haproxy/dev/log
</span></span><span class="line"><span class="cl"><span class="nv">Environment</span><span class="o">=</span><span class="s2">&#34;CONFIG=/etc/haproxy/haproxy.cfg&#34;</span> <span class="s2">&#34;CONFIGDIR=/etc/haproxy/conf.d/&#34;</span> <span class="s2">&#34;PIDFILE=/run/haproxy.pid&#34;</span> <span class="s2">&#34;EXTRAOPTS=-S /run/haproxy-master.sock&#34;</span> <span class="c1">#声明了一下子配置文件路径</span>
</span></span><span class="line"><span class="cl"><span class="nv">ExecStart</span><span class="o">=</span>/usr/sbin/haproxy -Ws -f <span class="nv">$CONFIG</span> -f <span class="nv">$CONFIGDIR</span> -p <span class="nv">$PIDFILE</span> <span class="nv">$EXTRAOPTS</span> <span class="c1">#添加变量</span>
</span></span><span class="line"><span class="cl"><span class="nv">ExecReload</span><span class="o">=</span>/usr/sbin/haproxy -Ws -f <span class="nv">$CONFIG</span> -c -q <span class="nv">$EXTRAOPTS</span>
</span></span><span class="line"><span class="cl"><span class="nv">ExecReload</span><span class="o">=</span>/bin/kill -USR2 <span class="nv">$MAINPID</span>
</span></span><span class="line"><span class="cl"><span class="nv">KillMode</span><span class="o">=</span>mixed
</span></span><span class="line"><span class="cl"><span class="nv">Restart</span><span class="o">=</span>always
</span></span><span class="line"><span class="cl"><span class="nv">SuccessExitStatus</span><span class="o">=</span><span class="m">143</span>
</span></span><span class="line"><span class="cl"><span class="nv">Type</span><span class="o">=</span>notify
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The following lines leverage SystemD&#39;s sandboxing options to provide</span>
</span></span><span class="line"><span class="cl"><span class="c1"># defense in depth protection at the expense of restricting some flexibility</span>
</span></span><span class="line"><span class="cl"><span class="c1"># in your setup (e.g. placement of your configuration files) or possibly</span>
</span></span><span class="line"><span class="cl"><span class="c1"># reduced performance. See systemd.service(5) and systemd.exec(5) for further</span>
</span></span><span class="line"><span class="cl"><span class="c1"># information.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># NoNewPrivileges=true</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ProtectHome=true</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If you want to use &#39;ProtectSystem=strict&#39; you should whitelist the PIDFILE,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># any state files and any other files written using &#39;ReadWritePaths&#39; or</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &#39;RuntimeDirectory&#39;.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ProtectSystem=true</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ProtectKernelTunables=true</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ProtectKernelModules=true</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ProtectControlGroups=true</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If your SystemD version supports them, you can add: @reboot, @swap, @sync</span>
</span></span><span class="line"><span class="cl"><span class="c1"># SystemCallFilter=~@cpu-emulation @keyring @module @obsolete @raw-io</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Install<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target</span></span></code></pre></div><h5 id="16-测试访问ingress控制器">1.6 测试访问ingress控制器</h5>
<p>80端口</p>
<p><img loading="lazy" src="http://cdn1.ryanxin.live/xxlog/image-20230619110149057.png" srcset="http://cdn1.ryanxin.live/xxlog/image-20230619110149057.png, http://cdn1.ryanxin.live/xxlog/image-20230619110149057.png 1.5x, http://cdn1.ryanxin.live/xxlog/image-20230619110149057.png 2x" sizes="auto" data-title="http://cdn1.ryanxin.live/xxlog/image-20230619110149057.png" data-alt="http://cdn1.ryanxin.live/xxlog/image-20230619110149057.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>443端口</p>
<p><img loading="lazy" src="http://cdn1.ryanxin.live/xxlog/image-20230619110233665.png" srcset="http://cdn1.ryanxin.live/xxlog/image-20230619110233665.png, http://cdn1.ryanxin.live/xxlog/image-20230619110233665.png 1.5x, http://cdn1.ryanxin.live/xxlog/image-20230619110233665.png 2x" sizes="auto" data-title="http://cdn1.ryanxin.live/xxlog/image-20230619110233665.png" data-alt="http://cdn1.ryanxin.live/xxlog/image-20230619110233665.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h4 id="2发布一个nginx服务验证证书"><strong>2.发布一个nginx服务验证证书</strong></h4>
<h5 id="21-创建nginx服务deploy文件">2.1 创建nginx服务deploy文件</h5>
<div class="highlight" id="id-34"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cert-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">cert-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">cert-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">harbor.ceamg.com/baseimages/nginx:1.21.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cert-nginx-svc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">cert-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span></span></span></code></pre></div><h5 id="22-创建ingress-yaml文件">2.2 创建ingress yaml文件</h5>
<div class="highlight" id="id-35"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tls-cert-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nginx&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/use-regex</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/proxy-connect-timeout</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;600&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/proxy-send-timeout</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;600&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/proxy-read-timeout</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;600&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/proxy-body-size</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;50m&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c">#nginx.ingress.kubernetes.io/rewrite-target: /</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/app-root</span><span class="p">:</span><span class="w"> </span><span class="l">/index.html</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">k8s.ceamg.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-ceamg-com-tls</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">k8s.ceamg.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l">Prefix</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cert-nginx-svc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">80</span></span></span></code></pre></div><h5 id="23-查看服务运行情况">2.3 查看服务运行情况</h5>
<div class="highlight" id="id-36"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1">#nginx服务运行情况</span>
</span></span><span class="line"><span class="cl">kubectl get pod
</span></span><span class="line"><span class="cl">NAME                                 READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">busybox                              1/1     Running   <span class="m">0</span>          4d16h
</span></span><span class="line"><span class="cl">cert-nginx-deploy-59449496d7-jpztj   1/1     Running   <span class="m">0</span>          14s</span></span></code></pre></div><div class="highlight" id="id-37"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1">#svc运行情况</span>
</span></span><span class="line"><span class="cl">kubectl get svc  -o wide
</span></span><span class="line"><span class="cl">NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE     SELECTOR
</span></span><span class="line"><span class="cl">cert-nginx-svc   ClusterIP   10.68.149.26   &lt;none&gt;        80/TCP    30s   <span class="nv">app</span><span class="o">=</span>cert-nginx</span></span></code></pre></div><div class="highlight" id="id-38"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1">#ingress运行情况</span>
</span></span><span class="line"><span class="cl">kubectl get ingress -o wide
</span></span><span class="line"><span class="cl">NAME               CLASS    HOSTS           ADDRESS                         PORTS     AGE
</span></span><span class="line"><span class="cl">tls-cert-ingress   &lt;none&gt;   k8s.ceamg.com   10.1.0.34,10.1.0.35,10.1.0.37   80, <span class="m">443</span>   20s</span></span></code></pre></div><h3 id="7通过域名访问测试">7.通过域名访问测试</h3>
<p><img loading="lazy" src="http://cdn1.ryanxin.live/xxlog/image-20230619111343825.png" srcset="http://cdn1.ryanxin.live/xxlog/image-20230619111343825.png, http://cdn1.ryanxin.live/xxlog/image-20230619111343825.png 1.5x, http://cdn1.ryanxin.live/xxlog/image-20230619111343825.png 2x" sizes="auto" data-title="http://cdn1.ryanxin.live/xxlog/image-20230619111343825.png" data-alt="http://cdn1.ryanxin.live/xxlog/image-20230619111343825.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2023-02-21 00:00:00">更新于 2023-02-21&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"><span><a href="/posts/kubernetes/primary/kubernetes-16/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://hg-xnlog.github.io/posts/kubernetes/primary/kubernetes-16/" data-title="实战案例-Cert-Manager 实现 K8s 服务域名证书自动化续签 (十六)" data-hashtags="k8s进阶训练营"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://hg-xnlog.github.io/posts/kubernetes/primary/kubernetes-16/" data-hashtag="k8s进阶训练营"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="https://hg-xnlog.github.io/posts/kubernetes/primary/kubernetes-16/" data-title="实战案例-Cert-Manager 实现 K8s 服务域名证书自动化续签 (十六)" data-web><i class="fa-brands fa-whatsapp fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://hg-xnlog.github.io/posts/kubernetes/primary/kubernetes-16/" data-title="实战案例-Cert-Manager 实现 K8s 服务域名证书自动化续签 (十六)"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://hg-xnlog.github.io/posts/kubernetes/primary/kubernetes-16/" data-title="实战案例-Cert-Manager 实现 K8s 服务域名证书自动化续签 (十六)"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Myspace" data-sharer="myspace" data-url="https://hg-xnlog.github.io/posts/kubernetes/primary/kubernetes-16/" data-title="实战案例-Cert-Manager 实现 K8s 服务域名证书自动化续签 (十六)" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Blogger" data-sharer="blogger" data-url="https://hg-xnlog.github.io/posts/kubernetes/primary/kubernetes-16/" data-title="实战案例-Cert-Manager 实现 K8s 服务域名证书自动化续签 (十六)" data-description=""><i class="fa-brands fa-blogger fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://hg-xnlog.github.io/posts/kubernetes/primary/kubernetes-16/" data-title="实战案例-Cert-Manager 实现 K8s 服务域名证书自动化续签 (十六)"><i class="fa-brands fa-evernote fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/k8s%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/' class="post-tag">k8s进阶训练营</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/kubernetes/primary/kubernetes-14/" class="post-nav-item" rel="prev" title="K8S 持续集成与部署 (十四)"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>K8S 持续集成与部署 (十四)</a>
      <a href="/posts/kubernetes/primary/kubernetes-17/" class="post-nav-item" rel="next" title="Harbor 使用自签证书支持 Https 访问 (十七)">Harbor 使用自签证书支持 Https 访问 (十七)<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2021 - 2023</span><span class="author" itemprop="copyrightHolder">
              <a href="https://github.com/ryanxin7"target="_blank" rel="external nofollow noopener noreferrer">Ryan</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"><span class="site-time" title='网站运行中……'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden="true"></i><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><a href="https://github.com/ryanxin7" title="在 GitHub 上查看源代码"target="_blank" rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/algoliasearch/algoliasearch-lite.umd.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"enablePWA":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"HFAFNY4NX2","algoliaIndex":"xn-log","algoliaSearchKey":"bd08388586b2f88b20753c17c60ba92f","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"siteTime":"2021-09-09T09:09:09+09:00"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
