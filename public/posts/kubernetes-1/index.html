<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Kubernetes 二进制部署 - Ryan&#39;s Notebook</title><meta name="author" content="Ryan">
<meta name="author-link" content="https://github.com/ryanxin7">
<meta name="description" content="前言 Kubernetes二进制部署相对于使用自动化工具（如kubeadm）而言，涉及更多的手动步骤和配置过程。然而，这种部署方式在一些情境下" /><meta name="keywords" content='k8s进阶训练营' /><meta itemprop="name" content="Kubernetes 二进制部署">
<meta itemprop="description" content="前言 Kubernetes二进制部署相对于使用自动化工具（如kubeadm）而言，涉及更多的手动步骤和配置过程。然而，这种部署方式在一些情境下"><meta itemprop="datePublished" content="2023-04-28T21:23:22+00:00" />
<meta itemprop="dateModified" content="2023-08-14T00:00:00+00:00" />
<meta itemprop="wordCount" content="11807"><meta itemprop="image" content="https://hg-xnlog.github.io/logo.png"/>
<meta itemprop="keywords" content="k8s进阶训练营," /><meta property="og:title" content="Kubernetes 二进制部署" />
<meta property="og:description" content="前言 Kubernetes二进制部署相对于使用自动化工具（如kubeadm）而言，涉及更多的手动步骤和配置过程。然而，这种部署方式在一些情境下" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hg-xnlog.github.io/posts/kubernetes-1/" /><meta property="og:image" content="https://hg-xnlog.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-28T21:23:22+00:00" />
<meta property="article:modified_time" content="2023-08-14T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://hg-xnlog.github.io/logo.png"/>

<meta name="twitter:title" content="Kubernetes 二进制部署"/>
<meta name="twitter:description" content="前言 Kubernetes二进制部署相对于使用自动化工具（如kubeadm）而言，涉及更多的手动步骤和配置过程。然而，这种部署方式在一些情境下"/>
<meta name="application-name" content="Ryan’s Notebook">
<meta name="apple-mobile-web-app-title" content="Ryan’s Notebook"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://hg-xnlog.github.io/posts/kubernetes-1/" /><link rel="prev" href="https://hg-xnlog.github.io/posts/1.kubernetes%E5%9F%BA%E7%A1%80/" /><link rel="next" href="https://hg-xnlog.github.io/posts/%E4%BD%BF%E7%94%A8algolia%E5%AE%9E%E7%8E%B0hugo%E6%9C%AC%E5%9C%B0%E6%99%BA%E8%83%BD%E6%90%9C%E7%B4%A2/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Kubernetes 二进制部署",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/hg-xnlog.github.io\/posts\/kubernetes-1\/"
    },"genre": "posts","keywords": "k8s进阶训练营","wordcount":  11807 ,
    "url": "https:\/\/hg-xnlog.github.io\/posts\/kubernetes-1\/","datePublished": "2023-04-28T21:23:22+00:00","dateModified": "2023-08-14T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Ryan"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="wide"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper" data-github-corner="right">
    <div class="header-title">
      <a href="/" title="Ryan&#39;s Notebook"><img loading="lazy" src="/images/pow.png" srcset="/images/pow.png, /images/pow.png 1.5x, /images/pow.png 2x" sizes="auto" data-title="Ryan&#39;s Notebook" data-alt="Ryan&#39;s Notebook" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/><span class="header-title-text">Ryan’s Notebook</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 所有文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/friends/"
                title="友情链接"
                
              ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/guestbook/"
                
                
              ><i class="fa-solid fa-comments fa-fw fa-sm" aria-hidden="true"></i> 留言</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-solid fa-user-tie fa-fw fa-sm" aria-hidden="true"></i> 關於</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Ryan&#39;s Notebook"><img loading="lazy" src="/images/pow.png" srcset="/images/pow.png, /images/pow.png 1.5x, /images/pow.png 2x" sizes="auto" data-title="/images/pow.png" data-alt="/images/pow.png" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/><span class="header-title-text">Ryan’s Notebook</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 所有文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/friends/"
                  title="友情链接"
                  
                ><i class="fa-solid fa-users fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/guestbook/"
                  
                  
                ><i class="fa-solid fa-comments fa-fw fa-sm" aria-hidden="true"></i> 留言</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-solid fa-user-tie fa-fw fa-sm" aria-hidden="true"></i> 關於</a></li><li
              class="menu-item text-center"
            ><a
                  class="menu-link"
                  href="https://github.com/ryanxin7/hg-xnlog"
                  title="GitHub"
                  rel="noopener noreferrer" target="_blank"
                ><i class='fa-brands fa-github fa-fw' aria-hidden='true'></i> </a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Kubernetes 二进制部署</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="https://github.com/ryanxin7" title="作者"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><img loading="lazy" src="/images/avatar.png" srcset="/images/avatar.png, /images/avatar.png 1.5x, /images/avatar.png 2x" sizes="auto" data-title="Ryan" data-alt="Ryan" class="avatar" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/>&nbsp;Ryan</a></span>
          <span class="post-category">收录于 <a href="/categories/kubernetes/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Kubernetes</a></span></div>
      <div class="post-meta-line"><span title="发布于 2023-04-28 21:23:22"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden="true"></i><time datetime="2023-04-28">2023-04-28</time></span>&nbsp;<span title="更新于 2023-08-14 00:00:00"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden="true"></i><time datetime="2023-08-14">2023-08-14</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 11807 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 24 分钟</span>&nbsp;<span id="busuanzi_container_page_pv" class="busuanzi_visitors comment-visitors" data-flag-title="Kubernetes 二进制部署">
            <i class="fa-regular fa-eye fa-fw me-1" aria-hidden="true"></i><span id="busuanzi_value_page_pv">-</span>&nbsp;次阅读
          </span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#1基础环境配置">1.基础环境配置</a>
      <ul>
        <li><a href="#11-时间同步">1.1 时间同步</a></li>
        <li><a href="#12--安裝docker">1.2  安裝docker</a></li>
        <li><a href="#13-安装ansible">1.3 安装ansible</a></li>
        <li><a href="#14-配置集群免秘钥登录">1.4 配置集群免秘钥登录</a></li>
        <li><a href="#15-部署节点下载kubeasz部署项及组件">1.5 部署节点下载kubeasz部署项⽬及组件</a></li>
      </ul>
    </li>
    <li><a href="#2部署-harbor-镜像仓库">2.部署 harbor 镜像仓库</a>
      <ul>
        <li><a href="#21-创建自签ssl证书">2.1 创建自签ssl证书</a></li>
        <li><a href="#22-修改harbor配置">2.2 修改harbor配置</a></li>
        <li><a href="#23-安装harbor">2.3 安装harbor</a></li>
        <li><a href="#24-harbor-调试">2.4 harbor 调试</a></li>
      </ul>
    </li>
    <li><a href="#3创建集群配置实例">3.创建集群配置实例</a>
      <ul>
        <li><a href="#31-成k8s集群-hosts件">3.1 ⽣成k8s集群 hosts⽂件</a></li>
        <li><a href="#31-成k8s集群-config-件">3.1 ⽣成k8s集群 config ⽂件</a></li>
      </ul>
    </li>
    <li><a href="#4步骤1-基础环境初始化">4.步骤1-基础环境初始化</a></li>
    <li><a href="#5步骤2-部署etcd集群">5.步骤2-部署etcd集群</a></li>
    <li><a href="#6步骤3-部署运行时环境">6.步骤3-部署运行时环境</a>
      <ul>
        <li><a href="#61-kubeasz-集成安装-containerd">6.1 kubeasz 集成安装 containerd</a></li>
        <li><a href="#62-配置containerd-对接私有harbor仓库">6.2 配置containerd 对接私有harbor仓库</a></li>
        <li><a href="#63-containerd-使用证书对接harbor实现上传下载">6.3 containerd 使用证书对接harbor实现上传下载</a></li>
      </ul>
    </li>
    <li><a href="#7步骤4-部署master">7.步骤4-部署master</a></li>
    <li><a href="#8步骤5-部署node节点">8.步骤5-部署node节点</a></li>
    <li><a href="#9步骤6-部署网络组件">9.步骤6-部署网络组件</a>
      <ul>
        <li><a href="#91-使calico络组件">9.1 使⽤calico⽹络组件</a></li>
        <li><a href="#92-验证calico网络">9.2 验证calico网络</a></li>
        <li><a href="#93-查看所有calico节点状态">9.3 查看所有calico节点状态</a></li>
        <li><a href="#94-创建容器测试网络通信">9.4 创建容器测试网络通信</a></li>
      </ul>
    </li>
    <li><a href="#10步骤7-安装集群插件-coredns">10.步骤7-安装集群插件-coredns</a>
      <ul>
        <li><a href="#101-下载二进制包">10.1 下载二进制包</a></li>
        <li><a href="#102-修改配置文件">10.2 修改配置文件</a></li>
        <li><a href="#103-下载镜像并推送到harbor">10.3 下载镜像并推送到harbor</a></li>
        <li><a href="#104-安装coredns">10.4 安装coredns</a></li>
        <li><a href="#105-启动容器测试域名解析">10.5 启动容器测试域名解析</a></li>
        <li><a href="#106-测试-prometheus-监控项">10.6 测试 prometheus 监控项</a></li>
      </ul>
    </li>
    <li><a href="#11-步骤8-安装集群插件-dashboard">11. 步骤8-安装集群插件-dashboard</a>
      <ul>
        <li><a href="#111-下载对应kubernetes版本的dashboard">11.1 下载对应kubernetes版本的dashboard</a></li>
        <li><a href="#112-修改service暴露方式">11.2 修改service暴露方式</a></li>
        <li><a href="#113-下载镜像推送到harbor">11.3 下载镜像推送到harbor</a></li>
        <li><a href="#114-修改镜像地址">11.4 修改镜像地址</a></li>
        <li><a href="#115-安装dashboard组件">11.5 安装dashboard组件</a></li>
        <li><a href="#116-查看组件运行状态">11.6 查看组件运行状态</a></li>
        <li><a href="#117-获取登陆-token">11.7 获取登陆 token</a></li>
        <li><a href="#118-登录测试">11.8 登录测试</a></li>
      </ul>
    </li>
    <li><a href="#12-集群管理">12. 集群管理</a>
      <ul>
        <li><a href="#121-添加node节点">12.1 添加node节点</a></li>
        <li><a href="#122-添加master-节点">12.2 添加master 节点</a></li>
        <li><a href="#123-验证当前节点">12.3 验证当前节点</a></li>
      </ul>
    </li>
    <li><a href="#13-集群升级">13. 集群升级</a>
      <ul>
        <li><a href="#131-升级master节点">13.1 升级master节点</a></li>
        <li><a href="#132-升级node节点">13.2 升级node节点</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 id="前言">前言</h2>
<p>Kubernetes二进制部署相对于使用自动化工具（如kubeadm）而言，涉及更多的手动步骤和配置过程。然而，这种部署方式在一些情境下具有显著的优势。通过手动下载、配置和启动Kubernetes的各个组件，用户能够获得更高程度的定制性和精细控制权，以便根据特定需求进行调整。这种灵活性使用户能够选择所需的Kubernetes版本、特定的组件配置，以及自定义的网络和存储方案。</p>
<p>同时，通过深入参与每个部署步骤，用户可以更加深入地理解Kubernetes的内部工作机制和组件之间的关系。这种深入了解对于排查问题、优化性能以及实现定制的集群架构至关重要。此外，二进制部署还允许用户在没有网络连接的环境中进行部署，这在某些限制性网络环境下非常有用。对于特殊场景，如需要定制化的认证、授权和网络设置，手动部署能够更好地满足需求。</p>
<p>然而，需要注意的是，Kubernetes的二进制部署需要更多的时间、技术知识和资源投入。相较于自动化工具，它可能增加了出错的风险，需要更多的监控和维护工作。因此，在选择部署方式时，应该根据自身的技能水平、时间成本和项目需求来选择适合自己的部署方式。</p>
<p><a href="https://www.yuque.com/attachments/yuque/0/2023/pdf/33538388/1672721011349-4455b094-61ee-4956-a375-07ad6fc387a1.pdf"target="_blank" rel="external nofollow noopener noreferrer">k8s-实战案例_v1.21.x-部署.pdf</a></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="1基础环境配置">1.基础环境配置</h2>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="11-时间同步">1.1 时间同步</h3>
<div class="highlight" id="id-1"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat /etc/default/locale
</span></span><span class="line"><span class="cl"><span class="nv">LANG</span><span class="o">=</span>en_US.UTF-8
</span></span><span class="line"><span class="cl"><span class="nv">LC_TIME</span><span class="o">=</span>en_DK.UTF-8 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*/5 * * * * /usr/sbin/ntpdate time1.aliyun.com <span class="p">&amp;</span>&gt; /dev/null <span class="o">&amp;&amp;</span> hwclock -w/usr/sbin/ntpdate</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="12--安裝docker">1.2  安裝docker</h3>
<div class="highlight" id="id-2"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/home/ceamg# <span class="nb">cd</span> /apps/docker/
</span></span><span class="line"><span class="cl">root@master01:/apps/docker# tar xvf docker-19.03.15-binary-install.tar.gz
</span></span><span class="line"><span class="cl">root@master01:/apps/docker# ll
</span></span><span class="line"><span class="cl">total <span class="m">153128</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root root     <span class="m">4096</span> Apr <span class="m">11</span>  <span class="m">2021</span> ./
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">3</span> root root     <span class="m">4096</span> Jan  <span class="m">2</span> 03:52 ../
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root      <span class="m">647</span> Apr <span class="m">11</span>  <span class="m">2021</span> containerd.service
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root <span class="m">78156440</span> Jan  <span class="m">2</span> 03:57 docker-19.03.15-binary-install.tar.gz
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root <span class="m">62436240</span> Feb  <span class="m">5</span>  <span class="m">2021</span> docker-19.03.15.tgz
</span></span><span class="line"><span class="cl">-rwxr-xr-x <span class="m">1</span> root root <span class="m">16168192</span> Jun <span class="m">24</span>  <span class="m">2019</span> docker-compose-Linux-x86_64_1.24.1*
</span></span><span class="line"><span class="cl">-rwxr-xr-x <span class="m">1</span> root root     <span class="m">2708</span> Apr <span class="m">11</span>  <span class="m">2021</span> docker-install.sh*
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root     <span class="m">1683</span> Apr <span class="m">11</span>  <span class="m">2021</span> docker.service
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root      <span class="m">197</span> Apr <span class="m">11</span>  <span class="m">2021</span> docker.socket
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root      <span class="m">454</span> Apr <span class="m">11</span>  <span class="m">2021</span> limits.conf
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root      <span class="m">257</span> Apr <span class="m">11</span>  <span class="m">2021</span> sysctl.conf</span></span></code></pre></div><div class="highlight" id="id-3"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nv">DIR</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nv">PACKAGE_NAME</span><span class="o">=</span><span class="s2">&#34;docker-19.03.15.tgz&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">DOCKER_FILE</span><span class="o">=</span><span class="si">${</span><span class="nv">DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">PACKAGE_NAME</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">centos_install_docker<span class="o">(){</span>
</span></span><span class="line"><span class="cl">  grep <span class="s2">&#34;Kernel&#34;</span> /etc/issue <span class="p">&amp;</span>&gt; /dev/null
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">    /bin/echo  <span class="s2">&#34;当前系统是`cat /etc/redhat-release`,即将开始系统初始化、配置docker-compose与安装docker&#34;</span> <span class="o">&amp;&amp;</span> sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">    systemctl stop firewalld <span class="o">&amp;&amp;</span> systemctl disable firewalld <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;防火墙已关闭&#34;</span> <span class="o">&amp;&amp;</span> sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">    systemctl stop NetworkManager <span class="o">&amp;&amp;</span> systemctl disable NetworkManager <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;NetworkManager&#34;</span> <span class="o">&amp;&amp;</span> sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">    sed -i <span class="s1">&#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39;</span> /etc/sysconfig/selinux <span class="o">&amp;&amp;</span> setenforce  <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;selinux 已关闭&#34;</span> <span class="o">&amp;&amp;</span> sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="se">\c</span>p <span class="si">${</span><span class="nv">DIR</span><span class="si">}</span>/limits.conf /etc/security/limits.conf
</span></span><span class="line"><span class="cl">    <span class="se">\c</span>p <span class="si">${</span><span class="nv">DIR</span><span class="si">}</span>/sysctl.conf /etc/sysctl.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    /bin/tar xvf <span class="si">${</span><span class="nv">DOCKER_FILE</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">    <span class="se">\c</span>p docker/*  /usr/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="se">\c</span>p containerd.service /lib/systemd/system/containerd.service
</span></span><span class="line"><span class="cl">    <span class="se">\c</span>p docker.service  /lib/systemd/system/docker.service
</span></span><span class="line"><span class="cl">    <span class="se">\c</span>p docker.socket /lib/systemd/system/docker.socket
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="se">\c</span>p <span class="si">${</span><span class="nv">DIR</span><span class="si">}</span>/docker-compose-Linux-x86_64_1.24.1 /usr/bin/docker-compose
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    groupadd docker <span class="o">&amp;&amp;</span> useradd docker -g docker
</span></span><span class="line"><span class="cl">    id -u  magedu <span class="p">&amp;</span>&gt; /dev/null
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">      useradd magedu
</span></span><span class="line"><span class="cl">      usermod magedu -G docker
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    systemctl  <span class="nb">enable</span> containerd.service <span class="o">&amp;&amp;</span> systemctl  restart containerd.service
</span></span><span class="line"><span class="cl">    systemctl  <span class="nb">enable</span> docker.service <span class="o">&amp;&amp;</span> systemctl  restart docker.service
</span></span><span class="line"><span class="cl">    systemctl  <span class="nb">enable</span> docker.socket <span class="o">&amp;&amp;</span> systemctl  restart docker.socket
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ubuntu_install_docker<span class="o">(){</span>
</span></span><span class="line"><span class="cl">  grep <span class="s2">&#34;Ubuntu&#34;</span> /etc/issue <span class="p">&amp;</span>&gt; /dev/null
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">    /bin/echo  <span class="s2">&#34;当前系统是`cat /etc/issue`,即将开始系统初始化、配置docker-compose与安装docker&#34;</span> <span class="o">&amp;&amp;</span> sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="se">\c</span>p <span class="si">${</span><span class="nv">DIR</span><span class="si">}</span>/limits.conf /etc/security/limits.conf
</span></span><span class="line"><span class="cl">    <span class="se">\c</span>p <span class="si">${</span><span class="nv">DIR</span><span class="si">}</span>/sysctl.conf /etc/sysctl.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    /bin/tar xvf <span class="si">${</span><span class="nv">DOCKER_FILE</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">    <span class="se">\c</span>p docker/*  /usr/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="se">\c</span>p containerd.service /lib/systemd/system/containerd.service
</span></span><span class="line"><span class="cl">    <span class="se">\c</span>p docker.service  /lib/systemd/system/docker.service
</span></span><span class="line"><span class="cl">    <span class="se">\c</span>p docker.socket /lib/systemd/system/docker.socket
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="se">\c</span>p <span class="si">${</span><span class="nv">DIR</span><span class="si">}</span>/docker-compose-Linux-x86_64_1.24.1 /usr/bin/docker-compose
</span></span><span class="line"><span class="cl">    <span class="nb">ulimit</span>  -n <span class="m">1000000</span>
</span></span><span class="line"><span class="cl">    /bin/su -c -  ceamg <span class="s2">&#34;ulimit -n 1000000&#34;</span>
</span></span><span class="line"><span class="cl">    /bin/echo <span class="s2">&#34;docker 安装完成!&#34;</span> <span class="o">&amp;&amp;</span> sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">    id -u  magedu <span class="p">&amp;</span>&gt; /dev/null
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">      groupadd  -r docker
</span></span><span class="line"><span class="cl">      useradd -r -m -g docker docker
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    systemctl  <span class="nb">enable</span> containerd.service <span class="o">&amp;&amp;</span> systemctl  restart containerd.service
</span></span><span class="line"><span class="cl">    systemctl  <span class="nb">enable</span> docker.service <span class="o">&amp;&amp;</span> systemctl  restart docker.service
</span></span><span class="line"><span class="cl">    systemctl  <span class="nb">enable</span> docker.socket <span class="o">&amp;&amp;</span> systemctl  restart docker.socket
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">main<span class="o">(){</span>
</span></span><span class="line"><span class="cl">  centos_install_docker
</span></span><span class="line"><span class="cl">  ubuntu_install_docker
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">main</span></span></code></pre></div><div class="highlight" id="id-4"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo tee /etc/docker/daemon.json <span class="s">&lt;&lt;-&#39;EOF&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">{
</span></span></span><span class="line"><span class="cl"><span class="s">  &#34;registry-mirrors&#34;: [&#34;https://lc2kkql3.mirror.aliyuncs.com&#34;],
</span></span></span><span class="line"><span class="cl"><span class="s">   &#34;storage-driver&#34;: &#34;overlay&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">   &#34;data-root&#34;: &#34;/data/docker&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">sudo systemctl daemon-reload
</span></span><span class="line"><span class="cl">sudo systemctl restart docker</span></span></code></pre></div><div class="highlight" id="id-5"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:~# cat /etc/sysctl.conf 
</span></span><span class="line"><span class="cl">net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">vm.max_map_count<span class="o">=</span><span class="m">262144</span>
</span></span><span class="line"><span class="cl">kernel.pid_max<span class="o">=</span><span class="m">4194303</span>
</span></span><span class="line"><span class="cl">fs.file-max<span class="o">=</span><span class="m">1000000</span>
</span></span><span class="line"><span class="cl">net.ipv4.tcp_max_tw_buckets<span class="o">=</span><span class="m">6000</span>
</span></span><span class="line"><span class="cl">net.netfilter.nf_conntrack_max<span class="o">=</span><span class="m">2097152</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">net.bridge.bridge-nf-call-ip6tables <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">net.bridge.bridge-nf-call-iptables <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">vm.swappiness<span class="o">=</span><span class="m">0</span></span></span></code></pre></div><div class="highlight" id="id-6"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/apps/docker# bash docker-install.sh 
</span></span><span class="line"><span class="cl">当前系统是Ubuntu 20.04.3 LTS <span class="se">\n</span> <span class="se">\l</span>,即将开始系统初始化、配置docker-compose与安装docker
</span></span><span class="line"><span class="cl">docker/
</span></span><span class="line"><span class="cl">docker/dockerd
</span></span><span class="line"><span class="cl">docker/docker-proxy
</span></span><span class="line"><span class="cl">docker/containerd-shim
</span></span><span class="line"><span class="cl">docker/docker-init
</span></span><span class="line"><span class="cl">docker/docker
</span></span><span class="line"><span class="cl">docker/runc
</span></span><span class="line"><span class="cl">docker/ctr
</span></span><span class="line"><span class="cl">docker/containerd
</span></span><span class="line"><span class="cl">su: user jack does not exist
</span></span><span class="line"><span class="cl">docker 安装完成!
</span></span><span class="line"><span class="cl">Created symlink /etc/systemd/system/multi-user.target.wants/containerd.service → /lib/systemd/system/containerd.service.
</span></span><span class="line"><span class="cl">Created symlink /etc/systemd/system/multi-user.target.wants/docker.service → /lib/systemd/system/docker.service.
</span></span><span class="line"><span class="cl">Created symlink /etc/systemd/system/sockets.target.wants/docker.socket → /lib/systemd/system/docker.socket.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">reboot</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="13-安装ansible">1.3 安装ansible</h3>
<div class="highlight" id="id-7"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#部署节点安装ansible</span>
</span></span><span class="line"><span class="cl">root@master01:~# apt  install python3-pip git
</span></span><span class="line"><span class="cl">root@master01:~# pip3 install ansible -i https://mirrors.aliyun.com/pypi/simple/
</span></span><span class="line"><span class="cl">root@master01:~# ansible --version
</span></span><span class="line"><span class="cl">ansible <span class="o">[</span>core 2.13.7<span class="o">]</span>
</span></span><span class="line"><span class="cl">  config <span class="nv">file</span> <span class="o">=</span> None
</span></span><span class="line"><span class="cl">  configured module search <span class="nv">path</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;/root/.ansible/plugins/modules&#39;</span>, <span class="s1">&#39;/usr/share/ansible/plugins/modules&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">  ansible python module <span class="nv">location</span> <span class="o">=</span> /usr/local/lib/python3.8/dist-packages/ansible
</span></span><span class="line"><span class="cl">  ansible collection <span class="nv">location</span> <span class="o">=</span> /root/.ansible/collections:/usr/share/ansible/collections
</span></span><span class="line"><span class="cl">  executable <span class="nv">location</span> <span class="o">=</span> /usr/local/bin/ansible
</span></span><span class="line"><span class="cl">  python <span class="nv">version</span> <span class="o">=</span> 3.8.10 <span class="o">(</span>default, Nov <span class="m">14</span> 2022, 12:59:47<span class="o">)</span> <span class="o">[</span>GCC 9.4.0<span class="o">]</span>
</span></span><span class="line"><span class="cl">  jinja <span class="nv">version</span> <span class="o">=</span> 3.1.2
</span></span><span class="line"><span class="cl">  <span class="nv">libyaml</span> <span class="o">=</span> True</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="14-配置集群免秘钥登录">1.4 配置集群免秘钥登录</h3>
<div class="highlight" id="id-8"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#⽣成密钥对</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@k8s-master1:~# ssh-keygen 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#安装sshpass命令⽤于同步公钥到各k8s服务器</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># apt-get install sshpass </span>
</span></span><span class="line"><span class="cl"><span class="c1">#分发公钥脚本：</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@k8s-master1:~# cat scp-key.sh </span></span></code></pre></div><div class="highlight" id="id-9"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">#⽬标主机列表</span>
</span></span><span class="line"><span class="cl"><span class="nv">IP</span><span class="o">=</span><span class="s2">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">10.1.0.32
</span></span></span><span class="line"><span class="cl"><span class="s2">10.1.0.33
</span></span></span><span class="line"><span class="cl"><span class="s2">10.1.0.34
</span></span></span><span class="line"><span class="cl"><span class="s2">10.1.0.35
</span></span></span><span class="line"><span class="cl"><span class="s2">10.1.0.38
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> node in <span class="si">${</span><span class="nv">IP</span><span class="si">}</span><span class="p">;</span><span class="k">do</span>
</span></span><span class="line"><span class="cl">  sshpass -p ceamg.com ssh-copy-id <span class="si">${</span><span class="nv">node</span><span class="si">}</span> -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">   <span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">node</span><span class="si">}</span><span class="s2"> 秘钥copy完成&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">   <span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">node</span><span class="si">}</span><span class="s2"> 秘钥copy失败&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span></span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="15-部署节点下载kubeasz部署项及组件">1.5 部署节点下载kubeasz部署项⽬及组件</h3>
<p>使⽤ **master01 **作为部署节点<!-- raw HTML omitted --><a href="https://github.com/easzlab/kubeasz"target="_blank" rel="external nofollow noopener noreferrer">GitHub - easzlab/kubeasz: 使用Ansible脚本安装K8S集群，介绍组件交互原理，方便直接，不受国内网络环境影响</a></p>
<div class="highlight" id="id-10"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@k8s-master1:~# <span class="nb">export</span> <span class="nv">release</span><span class="o">=</span>3.3.1
</span></span><span class="line"><span class="cl">root@k8s-master1:~# curl -C- -fLO --retry <span class="m">3</span> https://github.com/easzlab/kubeasz/releases/download/<span class="si">${</span><span class="nv">release</span><span class="si">}</span>/ezdown</span></span></code></pre></div><div class="highlight" id="id-11"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:~# chmod a+x ezdown 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@master01:~# ./ezdown -D
</span></span><span class="line"><span class="cl">2023-01-02 13:28:24 INFO Action begin: download_all
</span></span><span class="line"><span class="cl">2023-01-02 13:28:24 INFO downloading docker binaries, version 19.03.15
</span></span><span class="line"><span class="cl">--2023-01-02 13:28:24--  https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/static/stable/x86_64/docker-19.03.15.tgz
</span></span><span class="line"><span class="cl">Resolving mirrors.tuna.tsinghua.edu.cn <span class="o">(</span>mirrors.tuna.tsinghua.edu.cn<span class="o">)</span>... 101.6.15.130, 2402:f000:1:400::2
</span></span><span class="line"><span class="cl">Connecting to mirrors.tuna.tsinghua.edu.cn <span class="o">(</span>mirrors.tuna.tsinghua.edu.cn<span class="o">)</span><span class="p">|</span>101.6.15.130<span class="p">|</span>:443... connected.
</span></span><span class="line"><span class="cl">HTTP request sent, awaiting response... <span class="m">200</span> OK
</span></span><span class="line"><span class="cl">Length: <span class="m">62436240</span> <span class="o">(</span>60M<span class="o">)</span> <span class="o">[</span>application/octet-stream<span class="o">]</span>
</span></span><span class="line"><span class="cl">Saving to: ‘docker-19.03.15.tgz’
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">docker-19.03.15.tgz                                   100%<span class="o">[========================================================================================================================</span>&gt;<span class="o">]</span>  59.54M  11.2MB/s    in 5.5s    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2023-01-02 13:28:29 <span class="o">(</span>10.9 MB/s<span class="o">)</span> - ‘docker-19.03.15.tgz’ saved <span class="o">[</span>62436240/62436240<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2023-01-02 13:28:31 WARN docker is already running.
</span></span><span class="line"><span class="cl">2023-01-02 13:28:31 INFO downloading kubeasz: 3.3.1
</span></span><span class="line"><span class="cl">2023-01-02 13:28:31 DEBUG  run a temporary container
</span></span><span class="line"><span class="cl">Unable to find image <span class="s1">&#39;easzlab/kubeasz:3.3.1&#39;</span> locally
</span></span><span class="line"><span class="cl">3.3.1: Pulling from easzlab/kubeasz
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Status: Image is up to date <span class="k">for</span> easzlab/kubeasz:3.3.1
</span></span><span class="line"><span class="cl">docker.io/easzlab/kubeasz:3.3.1
</span></span><span class="line"><span class="cl">2023-01-02 13:41:44 INFO Action successed: download_all
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@master01:~# <span class="nb">cd</span> /etc/kubeasz/
</span></span><span class="line"><span class="cl">root@master01:/etc/kubeasz/down# ll
</span></span><span class="line"><span class="cl">total <span class="m">1136932</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root      <span class="m">4096</span> Jan  <span class="m">2</span> 13:41 ./
</span></span><span class="line"><span class="cl">drwxrwxr-x <span class="m">12</span> root root      <span class="m">4096</span> Jan  <span class="m">2</span> 13:32 ../
</span></span><span class="line"><span class="cl">-rw-------  <span class="m">1</span> root root <span class="m">383673856</span> Jan  <span class="m">2</span> 13:35 calico_v3.19.4.tar
</span></span><span class="line"><span class="cl">-rw-------  <span class="m">1</span> root root  <span class="m">48941568</span> Jan  <span class="m">2</span> 13:36 coredns_1.9.3.tar
</span></span><span class="line"><span class="cl">-rw-------  <span class="m">1</span> root root <span class="m">246784000</span> Jan  <span class="m">2</span> 13:39 dashboard_v2.5.1.tar
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root  <span class="m">62436240</span> Feb  <span class="m">1</span>  <span class="m">2021</span> docker-19.03.15.tgz
</span></span><span class="line"><span class="cl">-rw-------  <span class="m">1</span> root root <span class="m">106171392</span> Jan  <span class="m">2</span> 13:37 k8s-dns-node-cache_1.21.1.tar
</span></span><span class="line"><span class="cl">-rw-------  <span class="m">1</span> root root <span class="m">179129856</span> Jan  <span class="m">2</span> 13:41 kubeasz_3.3.1.tar
</span></span><span class="line"><span class="cl">-rw-------  <span class="m">1</span> root root  <span class="m">43832320</span> Jan  <span class="m">2</span> 13:40 metrics-scraper_v1.0.8.tar
</span></span><span class="line"><span class="cl">-rw-------  <span class="m">1</span> root root  <span class="m">65683968</span> Jan  <span class="m">2</span> 13:41 metrics-server_v0.5.2.tar
</span></span><span class="line"><span class="cl">-rw-------  <span class="m">1</span> root root    <span class="m">721408</span> Jan  <span class="m">2</span> 13:41 pause_3.7.tar
</span></span><span class="line"><span class="cl">-rw-------  <span class="m">1</span> root root  <span class="m">26815488</span> Jan  <span class="m">2</span> 13:32 registry-2.tar</span></span></code></pre></div><p>上述脚本运行成功后，所有文件（kubeasz代码、二进制、离线镜像）均已整理好放入目录/etc/kubeasz</p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="2部署-harbor-镜像仓库">2.部署 harbor 镜像仓库</h2>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="21-创建自签ssl证书">2.1 创建自签ssl证书</h3>
<div class="highlight" id="id-12"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#本地解析</span>
</span></span><span class="line"><span class="cl">root@harbor01:~# <span class="nb">echo</span> <span class="s2">&#34;10.1.0.38 harbor.ceamg.com &gt;&gt; /etc/hosts&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mkdir -p /data/cert
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /data/cert
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#创建ca和harbor证书请求</span>
</span></span><span class="line"><span class="cl">openssl genrsa -out ca.key <span class="m">4096</span>
</span></span><span class="line"><span class="cl">openssl req -x509 -new -nodes -sha512 -days <span class="m">7300</span> -subj <span class="s2">&#34;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.ceamg.com&#34;</span> -key ca.key -out ca.crt
</span></span><span class="line"><span class="cl">openssl genrsa -out harbor.ceamg.com.key <span class="m">4096</span>
</span></span><span class="line"><span class="cl">openssl req -sha512 -new -subj <span class="s2">&#34;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.ceamg.com&#34;</span> -key harbor.ceamg.com.key -out harbor.ceamg.com.csr
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#创建v3文件</span>
</span></span><span class="line"><span class="cl">cat &gt; v3.ext <span class="s">&lt;&lt;-EOF
</span></span></span><span class="line"><span class="cl"><span class="s">authorityKeyIdentifier=keyid,issuer
</span></span></span><span class="line"><span class="cl"><span class="s">basicConstraints=CA:FALSE
</span></span></span><span class="line"><span class="cl"><span class="s">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
</span></span></span><span class="line"><span class="cl"><span class="s">extendedKeyUsage = serverAuth
</span></span></span><span class="line"><span class="cl"><span class="s">subjectAltName = @alt_names
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[alt_names]
</span></span></span><span class="line"><span class="cl"><span class="s">DNS.1=harbor.ceamg.com
</span></span></span><span class="line"><span class="cl"><span class="s">DNS.2=harbor
</span></span></span><span class="line"><span class="cl"><span class="s">DNS.3=ks-allinone
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#使用v3文件签发harbor证书</span>
</span></span><span class="line"><span class="cl">openssl x509 -req -sha512 -days <span class="m">7300</span> -extfile v3.ext -CA ca.crt -CAkey ca.key -CAcreateserial -in harbor.ceamg.com.csr -out harbor.ceamg.com.crt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#转换成cert</span>
</span></span><span class="line"><span class="cl">openssl x509 -inform PEM -in harbor.ceamg.com.crt -out harbor.ceamg.com.cert
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#添加根证书让系统信任证书</span>
</span></span><span class="line"><span class="cl">root@harbor01:/data/cert# cp harbor.ceamg.com.crt /usr/local/share/ca-certificates/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@harbor01:/data/cert# update-ca-certificates 
</span></span><span class="line"><span class="cl">Updating certificates in /etc/ssl/certs...
</span></span><span class="line"><span class="cl">rehash: warning: skipping ca-certificates.crt,it does not contain exactly one certificate or CRL
</span></span><span class="line"><span class="cl"><span class="m">1</span> added, <span class="m">0</span> removed<span class="p">;</span> <span class="k">done</span>.
</span></span><span class="line"><span class="cl">Running hooks in /etc/ca-certificates/update.d...
</span></span><span class="line"><span class="cl"><span class="k">done</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#update-ca-certificates命令将PEM格式的根证书内容附加到/etc/ssl/certs/ca-certificates.crt ，而/etc/ssl/certs/ca-certificates.crt 包含了系统自带的各种可信根证书.</span></span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="22-修改harbor配置">2.2 修改harbor配置</h3>
<div class="highlight" id="id-13"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@harbor01:/apps/harbor/harbor# cp harbor.yml.tmpl harbor.yml</span></span></code></pre></div><div class="highlight" id="id-14"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@harbor01:/apps/harbor/harbor# grep -v <span class="s2">&#34;#&#34;</span> harbor.yml <span class="p">|</span> grep -v <span class="s2">&#34;^</span>$<span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">hostname: harbor.ceamg.com
</span></span><span class="line"><span class="cl">http:
</span></span><span class="line"><span class="cl">  port: <span class="m">80</span>
</span></span><span class="line"><span class="cl">https:
</span></span><span class="line"><span class="cl">  port: <span class="m">443</span>
</span></span><span class="line"><span class="cl">  certificate: /data/cert/harbor.ceamg.com.crt
</span></span><span class="line"><span class="cl">  private_key: /apps/harbor/certs/harbor.ceamg.com.key
</span></span><span class="line"><span class="cl">harbor_admin_password: ceamg.com
</span></span><span class="line"><span class="cl">database:
</span></span><span class="line"><span class="cl">  password: root123
</span></span><span class="line"><span class="cl">  max_idle_conns: <span class="m">100</span>
</span></span><span class="line"><span class="cl">  max_open_conns: <span class="m">900</span>
</span></span><span class="line"><span class="cl">  conn_max_lifetime: 5m
</span></span><span class="line"><span class="cl">  conn_max_idle_time: <span class="m">0</span>
</span></span><span class="line"><span class="cl">data_volume: /data
</span></span><span class="line"><span class="cl">trivy:
</span></span><span class="line"><span class="cl">  ignore_unfixed: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">  skip_update: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">  offline_scan: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">  security_check: vuln
</span></span><span class="line"><span class="cl">  insecure: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">jobservice:
</span></span><span class="line"><span class="cl">  max_job_workers: <span class="m">10</span>
</span></span><span class="line"><span class="cl">notification:
</span></span><span class="line"><span class="cl">  webhook_job_max_retry: <span class="m">10</span>
</span></span><span class="line"><span class="cl">chart:
</span></span><span class="line"><span class="cl">  absolute_url: disabled
</span></span><span class="line"><span class="cl">log:
</span></span><span class="line"><span class="cl">  level: info
</span></span><span class="line"><span class="cl">  local:
</span></span><span class="line"><span class="cl">    rotate_count: <span class="m">50</span>
</span></span><span class="line"><span class="cl">    rotate_size: 200M
</span></span><span class="line"><span class="cl">    location: /var/log/harbor
</span></span><span class="line"><span class="cl">_version: 2.7.0
</span></span><span class="line"><span class="cl">proxy:
</span></span><span class="line"><span class="cl">  http_proxy:
</span></span><span class="line"><span class="cl">  https_proxy:
</span></span><span class="line"><span class="cl">  no_proxy:
</span></span><span class="line"><span class="cl">  components:
</span></span><span class="line"><span class="cl">    - core
</span></span><span class="line"><span class="cl">    - jobservice
</span></span><span class="line"><span class="cl">    - trivy
</span></span><span class="line"><span class="cl">upload_purging:
</span></span><span class="line"><span class="cl">  enabled: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  age: 168h
</span></span><span class="line"><span class="cl">  interval: 24h
</span></span><span class="line"><span class="cl">  dryrun: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">cache:
</span></span><span class="line"><span class="cl">  enabled: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">  expire_hours: <span class="m">24</span></span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="23-安装harbor">2.3 安装harbor</h3>
<p><a href="https://goharbor.io/docs/2.3.0/install-config/reconfigure-manage-lifecycle/"target="_blank" rel="external nofollow noopener noreferrer">Harbor – Reconfigure Harbor and Manage the Harbor Lifecycle</a><!-- raw HTML omitted --> 有扫描<code>–with-trivy</code> ,有认证<code>–with-notary</code>，有helm charts 模块退出<code>–with-chartmuseum</code> 其中<code>–with-clair</code>已弃用</p>
<div class="highlight" id="id-15"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#更新配置文件</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@harbor01:/apps/harbor/harbor# ./prepare 
</span></span><span class="line"><span class="cl">root@harbor01:/apps/harbor/harbor# ./install.sh --with-notary --with-trivy --with-chartmuseum
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Step 0<span class="o">]</span>: checking <span class="k">if</span> docker is installed ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Note: docker version: 19.03.15
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Step 1<span class="o">]</span>: checking docker-compose is installed ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Note: docker-compose version: 1.24.1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Step 2<span class="o">]</span>: loading Harbor images ...
</span></span><span class="line"><span class="cl">8991ee7e1c66: Loading layer <span class="o">[==================================================</span>&gt;<span class="o">]</span>  37.72MB/37.72MB
</span></span><span class="line"><span class="cl">caef0c5d2fe0: Loading layer <span class="o">[==================================================</span>&gt;<span class="o">]</span>  43.84MB/43.84MB
</span></span><span class="line"><span class="cl">d0ae0913849c: Loading layer <span class="o">[==================================================</span>&gt;<span class="o">]</span>  66.03MB/66.03MB
</span></span><span class="line"><span class="cl">d6c3137fc4e6: Loading layer <span class="o">[==================================================</span>&gt;<span class="o">]</span>   18.2MB/18.2MB
</span></span><span class="line"><span class="cl">db156fb6962c: Loading layer <span class="o">[==================================================</span>&gt;<span class="o">]</span>  65.54kB/65.54kB
</span></span><span class="line"><span class="cl">578a990cf79f: Loading layer <span class="o">[==================================================</span>&gt;<span class="o">]</span>   2.56kB/2.56kB
</span></span><span class="line"><span class="cl">9415b3c8b317: Loading layer <span class="o">[==================================================</span>&gt;<span class="o">]</span>  1.536kB/1.536kB
</span></span><span class="line"><span class="cl">bdb2dfba8b17: Loading layer <span class="o">[==================================================</span>&gt;<span class="o">]</span>  12.29kB/12.29kB
</span></span><span class="line"><span class="cl">6a1b6c491cd2: Loading layer <span class="o">[==================================================</span>&gt;<span class="o">]</span>  2.613MB/2.613MB
</span></span><span class="line"><span class="cl">c35c2488b48b: Loading layer <span class="o">[==================================================</span>&gt;<span class="o">]</span>    407kB/407kB
</span></span><span class="line"><span class="cl">Loaded image: goharbor/prepare:v2.7.0
</span></span><span class="line"><span class="cl">Loaded image: goharbor/harbor-db:v2.7.0
</span></span><span class="line"><span class="cl">Loaded image: goharbor/harbor-core:v2.7.0
</span></span><span class="line"><span class="cl">Loaded image: goharbor/harbor-log:v2.7.0
</span></span><span class="line"><span class="cl">Loaded image: goharbor/harbor-exporter:v2.7.0
</span></span><span class="line"><span class="cl">Loaded image: goharbor/nginx-photon:v2.7.0
</span></span><span class="line"><span class="cl">Loaded image: goharbor/chartmuseum-photon:v2.7.0
</span></span><span class="line"><span class="cl">Loaded image: goharbor/harbor-portal:v2.7.0
</span></span><span class="line"><span class="cl">Loaded image: goharbor/harbor-jobservice:v2.7.0
</span></span><span class="line"><span class="cl">Loaded image: goharbor/harbor-registryctl:v2.7.0
</span></span><span class="line"><span class="cl">Loaded image: goharbor/registry-photon:v2.7.0
</span></span><span class="line"><span class="cl">Loaded image: goharbor/notary-server-photon:v2.7.0
</span></span><span class="line"><span class="cl">Loaded image: goharbor/redis-photon:v2.7.0
</span></span><span class="line"><span class="cl">Loaded image: goharbor/notary-signer-photon:v2.7.0
</span></span><span class="line"><span class="cl">Loaded image: goharbor/trivy-adapter-photon:v2.7.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Step 3<span class="o">]</span>: preparing environment ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Step 4<span class="o">]</span>: preparing harbor configs ...
</span></span><span class="line"><span class="cl">prepare base dir is <span class="nb">set</span> to /apps/harbor/harbor
</span></span><span class="line"><span class="cl">Generated configuration file: /config/portal/nginx.conf
</span></span><span class="line"><span class="cl">Generated configuration file: /config/log/logrotate.conf
</span></span><span class="line"><span class="cl">Generated configuration file: /config/log/rsyslog_docker.conf
</span></span><span class="line"><span class="cl">Generated configuration file: /config/nginx/nginx.conf
</span></span><span class="line"><span class="cl">Generated configuration file: /config/core/env
</span></span><span class="line"><span class="cl">Generated configuration file: /config/core/app.conf
</span></span><span class="line"><span class="cl">Generated configuration file: /config/registry/config.yml
</span></span><span class="line"><span class="cl">Generated configuration file: /config/registryctl/env
</span></span><span class="line"><span class="cl">Generated configuration file: /config/registryctl/config.yml
</span></span><span class="line"><span class="cl">Generated configuration file: /config/db/env
</span></span><span class="line"><span class="cl">Generated configuration file: /config/jobservice/env
</span></span><span class="line"><span class="cl">Generated configuration file: /config/jobservice/config.yml
</span></span><span class="line"><span class="cl">Generated and saved secret to file: /data/secret/keys/secretkey
</span></span><span class="line"><span class="cl">Successfully called func: create_root_cert
</span></span><span class="line"><span class="cl">Generated configuration file: /config/trivy-adapter/env
</span></span><span class="line"><span class="cl">Generated configuration file: /compose_location/docker-compose.yml
</span></span><span class="line"><span class="cl">Clean up the input dir
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Note: stopping existing Harbor instance ...
</span></span><span class="line"><span class="cl">Removing network harbor_harbor
</span></span><span class="line"><span class="cl">WARNING: Network harbor_harbor not found.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>Step 5<span class="o">]</span>: starting Harbor ...
</span></span><span class="line"><span class="cl">Creating network <span class="s2">&#34;harbor_harbor&#34;</span> with the default driver
</span></span><span class="line"><span class="cl">Creating harbor-log ... <span class="k">done</span>
</span></span><span class="line"><span class="cl">Creating redis         ... <span class="k">done</span>
</span></span><span class="line"><span class="cl">Creating harbor-portal ... <span class="k">done</span>
</span></span><span class="line"><span class="cl">Creating registry      ... <span class="k">done</span>
</span></span><span class="line"><span class="cl">Creating harbor-db     ... <span class="k">done</span>
</span></span><span class="line"><span class="cl">Creating registryctl   ... <span class="k">done</span>
</span></span><span class="line"><span class="cl">Creating trivy-adapter ... <span class="k">done</span>
</span></span><span class="line"><span class="cl">Creating harbor-core   ... <span class="k">done</span>
</span></span><span class="line"><span class="cl">Creating harbor-jobservice ... <span class="k">done</span>
</span></span><span class="line"><span class="cl">Creating nginx             ... <span class="k">done</span>
</span></span><span class="line"><span class="cl">✔ ----Harbor has been installed and started successfully.----</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="24-harbor-调试">2.4 harbor 调试</h3>
<div class="highlight" id="id-16"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#关闭 harbor</span>
</span></span><span class="line"><span class="cl">$~ sudo docker-compose down -v
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#更新配置</span>
</span></span><span class="line"><span class="cl">vim /apps/harbor.yml
</span></span><span class="line"><span class="cl">prepare 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#重新生成配置文件,增加上其他chart功能等</span>
</span></span><span class="line"><span class="cl">sudo prepare --with-notary --with-trivy --with-chartmuseum
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#启动 harbor</span>
</span></span><span class="line"><span class="cl">$~ sudo docker-compose up -d</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="3创建集群配置实例">3.创建集群配置实例</h2>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="31-成k8s集群-hosts件">3.1 ⽣成k8s集群 hosts⽂件</h3>
<div class="highlight" id="id-17"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/etc/kubeasz# ./ezctl new k8s-01
</span></span><span class="line"><span class="cl">2023-01-03 04:52:33 DEBUG generate custom cluster files in /etc/kubeasz/clusters/k8s-01
</span></span><span class="line"><span class="cl">2023-01-03 04:52:33 DEBUG <span class="nb">set</span> versions
</span></span><span class="line"><span class="cl">2023-01-03 04:52:33 DEBUG cluster k8s-01: files successfully created.
</span></span><span class="line"><span class="cl">2023-01-03 04:52:33 INFO next steps 1: to config <span class="s1">&#39;/etc/kubeasz/clusters/k8s-01/hosts&#39;</span>
</span></span><span class="line"><span class="cl">2023-01-03 04:52:33 INFO next steps 2: to config <span class="s1">&#39;/etc/kubeasz/clusters/k8s-01/config.yml&#39;</span></span></span></code></pre></div><div class="highlight" id="id-18"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># &#39;NEW_INSTALL&#39;: &#39;true&#39; to install a harbor server; &#39;false&#39; to integrate with existed one</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>harbor<span class="o">]</span>
</span></span><span class="line"><span class="cl">10.1.0.38 <span class="nv">NEW_INSTALL</span><span class="o">=</span><span class="nb">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [optional] loadbalance for accessing k8s from outside</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>ex_lb<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="c1">#192.168.1.6 LB_ROLE=backup EX_APISERVER_VIP=192.168.1.250 EX_APISERVER_PORT=8443</span>
</span></span><span class="line"><span class="cl"><span class="c1">#192.168.1.7 LB_ROLE=master EX_APISERVER_VIP=192.168.1.250 EX_APISERVER_PORT=8443</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [optional] ntp server for the cluster</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>chrony<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="c1">#192.168.1.1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>all:vars<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --------- Main Variables ---------------</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Secure port for apiservers</span>
</span></span><span class="line"><span class="cl"><span class="nv">SECURE_PORT</span><span class="o">=</span><span class="s2">&#34;6443&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Cluster container-runtime supported: docker, containerd</span>
</span></span><span class="line"><span class="cl"><span class="c1"># if k8s version &gt;= 1.24, docker is not supported</span>
</span></span><span class="line"><span class="cl"><span class="nv">CONTAINER_RUNTIME</span><span class="o">=</span><span class="s2">&#34;containerd&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Network plugins supported: calico, flannel, kube-router, cilium, kube-ovn</span>
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER_NETWORK</span><span class="o">=</span><span class="s2">&#34;calico&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Service proxy mode of kube-proxy: &#39;iptables&#39; or &#39;ipvs&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nv">PROXY_MODE</span><span class="o">=</span><span class="s2">&#34;ipvs&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># K8S Service CIDR, not overlap with node(host) networking</span>
</span></span><span class="line"><span class="cl"><span class="nv">SERVICE_CIDR</span><span class="o">=</span><span class="s2">&#34;10.10.0.0/16&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Cluster CIDR (Pod CIDR), not overlap with node(host) networking</span>
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER_CIDR</span><span class="o">=</span><span class="s2">&#34;10.20.0.0/16&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># NodePort Range</span>
</span></span><span class="line"><span class="cl"><span class="nv">NODE_PORT_RANGE</span><span class="o">=</span><span class="s2">&#34;30000-65535&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Cluster DNS Domain</span>
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER_DNS_DOMAIN</span><span class="o">=</span><span class="s2">&#34;ceamg.local&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># -------- Additional Variables (don&#39;t change the default value right now) ---</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Binaries Directory</span>
</span></span><span class="line"><span class="cl"><span class="nv">bin_dir</span><span class="o">=</span><span class="s2">&#34;/usr/local/bin&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Deploy Directory (kubeasz workspace)</span>
</span></span><span class="line"><span class="cl"><span class="nv">base_dir</span><span class="o">=</span><span class="s2">&#34;/etc/kubeasz&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Directory for a specific cluster</span>
</span></span><span class="line"><span class="cl"><span class="nv">cluster_dir</span><span class="o">=</span><span class="s2">&#34;{{ base_dir }}/clusters/k8s-01&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CA and other components cert/key Directory</span>
</span></span><span class="line"><span class="cl"><span class="nv">ca_dir</span><span class="o">=</span><span class="s2">&#34;/etc/kubernetes/ssl&#34;</span></span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="31-成k8s集群-config-件">3.1 ⽣成k8s集群 config ⽂件</h3>
<div class="highlight" id="id-19"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/etc/kubeasz# vim /etc/kubeasz/clusters/k8s-01/config.yml 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># prepare</span>
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 可选离线安装系统软件包 (offline|online)</span>
</span></span><span class="line"><span class="cl">INSTALL_SOURCE: <span class="s2">&#34;online&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 可选进行系统安全加固 github.com/dev-sec/ansible-collection-hardening</span>
</span></span><span class="line"><span class="cl">OS_HARDEN: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># role:deploy</span>
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># default: ca will expire in 100 years</span>
</span></span><span class="line"><span class="cl"><span class="c1"># default: certs issued by the ca will expire in 50 years</span>
</span></span><span class="line"><span class="cl">CA_EXPIRY: <span class="s2">&#34;876000h&#34;</span>
</span></span><span class="line"><span class="cl">CERT_EXPIRY: <span class="s2">&#34;438000h&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># kubeconfig 配置参数</span>
</span></span><span class="line"><span class="cl">CLUSTER_NAME: <span class="s2">&#34;cluster1&#34;</span>
</span></span><span class="line"><span class="cl">CONTEXT_NAME: <span class="s2">&#34;context-{{ CLUSTER_NAME }}&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># k8s version</span>
</span></span><span class="line"><span class="cl">K8S_VER: <span class="s2">&#34;1.24.2&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># role:etcd</span>
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 设置不同的wal目录，可以避免磁盘io竞争，提高性能</span>
</span></span><span class="line"><span class="cl">ETCD_DATA_DIR: <span class="s2">&#34;/var/lib/etcd&#34;</span>
</span></span><span class="line"><span class="cl">ETCD_WAL_DIR: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># role:runtime [containerd,docker]</span>
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ------------------------------------------- containerd</span>
</span></span><span class="line"><span class="cl"><span class="c1"># [.]启用容器仓库镜像</span>
</span></span><span class="line"><span class="cl">ENABLE_MIRROR_REGISTRY: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [containerd]基础容器镜像</span>
</span></span><span class="line"><span class="cl">SANDBOX_IMAGE: <span class="s2">&#34;easzlab.io.local:5000/easzlab/pause:3.7&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [containerd]容器持久化存储目录</span>
</span></span><span class="line"><span class="cl">CONTAINERD_STORAGE_DIR: <span class="s2">&#34;/var/lib/containerd&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ------------------------------------------- docker</span>
</span></span><span class="line"><span class="cl"><span class="c1"># [docker]容器存储目录</span>
</span></span><span class="line"><span class="cl">DOCKER_STORAGE_DIR: <span class="s2">&#34;/var/lib/docker&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [docker]开启Restful API</span>
</span></span><span class="line"><span class="cl">ENABLE_REMOTE_API: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [docker]信任的HTTP仓库</span>
</span></span><span class="line"><span class="cl">INSECURE_REG: <span class="s1">&#39;[&#34;http://easzlab.io.local:5000&#34;]&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># role:kube-master</span>
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># k8s 集群 master 节点证书配置，可以添加多个ip和域名（比如增加公网ip和域名）</span>
</span></span><span class="line"><span class="cl">MASTER_CERT_HOSTS:
</span></span><span class="line"><span class="cl">  - <span class="s2">&#34;10.1.1.1&#34;</span>
</span></span><span class="line"><span class="cl">  - <span class="s2">&#34;k8s.easzlab.io&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#- &#34;www.test.com&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># node 节点上 pod 网段掩码长度（决定每个节点最多能分配的pod ip地址）</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果flannel 使用 --kube-subnet-mgr 参数，那么它将读取该设置为每个节点分配pod网段</span>
</span></span><span class="line"><span class="cl"><span class="c1"># https://github.com/coreos/flannel/issues/847</span>
</span></span><span class="line"><span class="cl">NODE_CIDR_LEN: <span class="m">24</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># role:kube-node</span>
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Kubelet 根目录</span>
</span></span><span class="line"><span class="cl">KUBELET_ROOT_DIR: <span class="s2">&#34;/var/lib/kubelet&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># node节点最大pod 数</span>
</span></span><span class="line"><span class="cl">MAX_PODS: <span class="m">300</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 配置为kube组件（kubelet,kube-proxy,dockerd等）预留的资源量</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 数值设置详见templates/kubelet-config.yaml.j2</span>
</span></span><span class="line"><span class="cl">KUBE_RESERVED_ENABLED: <span class="s2">&#34;yes&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># k8s 官方不建议草率开启 system-reserved, 除非你基于长期监控，了解系统的资源占用状况；</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 并且随着系统运行时间，需要适当增加资源预留，数值设置详见templates/kubelet-config.yaml.j2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 系统预留设置基于 4c/8g 虚机，最小化安装系统服务，如果使用高性能物理机可以适当增加预留</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 另外，集群安装时候apiserver等资源占用会短时较大，建议至少预留1g内存</span>
</span></span><span class="line"><span class="cl">SYS_RESERVED_ENABLED: <span class="s2">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># role:network [flannel,calico,cilium,kube-ovn,kube-router]</span>
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ------------------------------------------- flannel</span>
</span></span><span class="line"><span class="cl"><span class="c1"># [flannel]设置flannel 后端&#34;host-gw&#34;,&#34;vxlan&#34;等</span>
</span></span><span class="line"><span class="cl">FLANNEL_BACKEND: <span class="s2">&#34;vxlan&#34;</span>
</span></span><span class="line"><span class="cl">DIRECT_ROUTING: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [flannel] flanneld_image: &#34;quay.io/coreos/flannel:v0.10.0-amd64&#34;</span>
</span></span><span class="line"><span class="cl">flannelVer: <span class="s2">&#34;v0.15.1&#34;</span>
</span></span><span class="line"><span class="cl">flanneld_image: <span class="s2">&#34;easzlab.io.local:5000/easzlab/flannel:{{ flannelVer }}&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ------------------------------------------- calico</span>
</span></span><span class="line"><span class="cl"><span class="c1"># [calico]设置 CALICO_IPV4POOL_IPIP=“off”,可以提高网络性能，条件限制详见 docs/setup/calico.md</span>
</span></span><span class="line"><span class="cl">CALICO_IPV4POOL_IPIP: <span class="s2">&#34;Always&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [calico]设置 calico-node使用的host IP，bgp邻居通过该地址建立，可手工指定也可以自动发现</span>
</span></span><span class="line"><span class="cl">IP_AUTODETECTION_METHOD: <span class="s2">&#34;can-reach={{ groups[&#39;kube_master&#39;][0] }}&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [calico]设置calico 网络 backend: brid, vxlan, none</span>
</span></span><span class="line"><span class="cl">CALICO_NETWORKING_BACKEND: <span class="s2">&#34;brid&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [calico]设置calico 是否使用route reflectors</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果集群规模超过50个节点，建议启用该特性</span>
</span></span><span class="line"><span class="cl">CALICO_RR_ENABLED: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CALICO_RR_NODES 配置route reflectors的节点，如果未设置默认使用集群master节点 </span>
</span></span><span class="line"><span class="cl"><span class="c1"># CALICO_RR_NODES: [&#34;192.168.1.1&#34;, &#34;192.168.1.2&#34;]</span>
</span></span><span class="line"><span class="cl">CALICO_RR_NODES: <span class="o">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [calico]更新支持calico 版本: [v3.3.x] [v3.4.x] [v3.8.x] [v3.15.x]</span>
</span></span><span class="line"><span class="cl">calico_ver: <span class="s2">&#34;v3.19.4&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [calico]calico 主版本</span>
</span></span><span class="line"><span class="cl">calico_ver_main: <span class="s2">&#34;{{ calico_ver.split(&#39;.&#39;)[0] }}.{{ calico_ver.split(&#39;.&#39;)[1] }}&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ------------------------------------------- cilium</span>
</span></span><span class="line"><span class="cl"><span class="c1"># [cilium]镜像版本</span>
</span></span><span class="line"><span class="cl">cilium_ver: <span class="s2">&#34;1.11.6&#34;</span>
</span></span><span class="line"><span class="cl">cilium_connectivity_check: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">cilium_hubble_enabled: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">cilium_hubble_ui_enabled: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ------------------------------------------- kube-ovn</span>
</span></span><span class="line"><span class="cl"><span class="c1"># [kube-ovn]选择 OVN DB and OVN Control Plane 节点，默认为第一个master节点</span>
</span></span><span class="line"><span class="cl">OVN_DB_NODE: <span class="s2">&#34;{{ groups[&#39;kube_master&#39;][0] }}&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [kube-ovn]离线镜像tar包</span>
</span></span><span class="line"><span class="cl">kube_ovn_ver: <span class="s2">&#34;v1.5.3&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ------------------------------------------- kube-router</span>
</span></span><span class="line"><span class="cl"><span class="c1"># [kube-router]公有云上存在限制，一般需要始终开启 ipinip；自有环境可以设置为 &#34;subnet&#34;</span>
</span></span><span class="line"><span class="cl">OVERLAY_TYPE: <span class="s2">&#34;full&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [kube-router]NetworkPolicy 支持开关</span>
</span></span><span class="line"><span class="cl">FIREWALL_ENABLE: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [kube-router]kube-router 镜像版本</span>
</span></span><span class="line"><span class="cl">kube_router_ver: <span class="s2">&#34;v0.3.1&#34;</span>
</span></span><span class="line"><span class="cl">busybox_ver: <span class="s2">&#34;1.28.4&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># role:cluster-addon</span>
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># coredns 自动安装</span>
</span></span><span class="line"><span class="cl">dns_install: <span class="s2">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl">corednsVer: <span class="s2">&#34;1.9.3&#34;</span>
</span></span><span class="line"><span class="cl">ENABLE_LOCAL_DNS_CACHE: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">dnsNodeCacheVer: <span class="s2">&#34;1.21.1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 设置 local dns cache 地址</span>
</span></span><span class="line"><span class="cl">LOCAL_DNS_CACHE: <span class="s2">&#34;169.254.20.10&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># metric server 自动安装</span>
</span></span><span class="line"><span class="cl">metricsserver_install: <span class="s2">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl">metricsVer: <span class="s2">&#34;v0.5.2&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># dashboard 自动安装</span>
</span></span><span class="line"><span class="cl">dashboard_install: <span class="s2">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl">dashboardVer: <span class="s2">&#34;v2.5.1&#34;</span>
</span></span><span class="line"><span class="cl">dashboardMetricsScraperVer: <span class="s2">&#34;v1.0.8&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># prometheus 自动安装</span>
</span></span><span class="line"><span class="cl">prom_install: <span class="s2">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl">prom_namespace: <span class="s2">&#34;monitor&#34;</span>
</span></span><span class="line"><span class="cl">prom_chart_ver: <span class="s2">&#34;35.5.1&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># nfs-provisioner 自动安装</span>
</span></span><span class="line"><span class="cl">nfs_provisioner_install: <span class="s2">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl">nfs_provisioner_namespace: <span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="cl">nfs_provisioner_ver: <span class="s2">&#34;v4.0.2&#34;</span>
</span></span><span class="line"><span class="cl">nfs_storage_class: <span class="s2">&#34;managed-nfs-storage&#34;</span>
</span></span><span class="line"><span class="cl">nfs_server: <span class="s2">&#34;192.168.1.10&#34;</span>
</span></span><span class="line"><span class="cl">nfs_path: <span class="s2">&#34;/data/nfs&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># network-check 自动安装</span>
</span></span><span class="line"><span class="cl">network_check_enabled: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">network_check_schedule: <span class="s2">&#34;*/5 * * * *&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># role:harbor</span>
</span></span><span class="line"><span class="cl"><span class="c1">############################</span>
</span></span><span class="line"><span class="cl"><span class="c1"># harbor version，完整版本号</span>
</span></span><span class="line"><span class="cl">HARBOR_VER: <span class="s2">&#34;v2.1.3&#34;</span>
</span></span><span class="line"><span class="cl">HARBOR_DOMAIN: <span class="s2">&#34;harbor.easzlab.io.local&#34;</span>
</span></span><span class="line"><span class="cl">HARBOR_TLS_PORT: <span class="m">8443</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># if set &#39;false&#39;, you need to put certs named harbor.pem and harbor-key.pem in directory &#39;down&#39;</span>
</span></span><span class="line"><span class="cl">HARBOR_SELF_SIGNED_CERT: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># install extra component</span>
</span></span><span class="line"><span class="cl">HARBOR_WITH_NOTARY: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">HARBOR_WITH_TRIVY: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">HARBOR_WITH_CLAIR: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">HARBOR_WITH_CHARTMUSEUM: true</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="4步骤1-基础环境初始化">4.步骤1-基础环境初始化</h2>
<div class="highlight" id="id-20"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/etc/kubeasz# ./ezctl <span class="nb">help</span> setup
</span></span><span class="line"><span class="cl">Usage: ezctl setup &lt;cluster&gt; &lt;step&gt;
</span></span><span class="line"><span class="cl">available steps:
</span></span><span class="line"><span class="cl">    <span class="m">01</span>  prepare            to prepare CA/certs <span class="p">&amp;</span> kubeconfig <span class="p">&amp;</span> other system settings 
</span></span><span class="line"><span class="cl">    <span class="m">02</span>  etcd               to setup the etcd cluster
</span></span><span class="line"><span class="cl">    <span class="m">03</span>  container-runtime  to setup the container runtime<span class="o">(</span>docker or containerd<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="m">04</span>  kube-master        to setup the master nodes
</span></span><span class="line"><span class="cl">    <span class="m">05</span>  kube-node          to setup the worker nodes
</span></span><span class="line"><span class="cl">    <span class="m">06</span>  network            to setup the network plugin
</span></span><span class="line"><span class="cl">    <span class="m">07</span>  cluster-addon      to setup other useful plugins
</span></span><span class="line"><span class="cl">    <span class="m">90</span>  all                to run 01~07 all at once
</span></span><span class="line"><span class="cl">    <span class="m">10</span>  ex-lb              to install external loadbalance <span class="k">for</span> accessing k8s from outside
</span></span><span class="line"><span class="cl">    <span class="m">11</span>  harbor             to install a new harbor server or to integrate with an existed one
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">examples: ./ezctl setup test-k8s <span class="m">01</span>  <span class="o">(</span>or ./ezctl setup test-k8s prepare<span class="o">)</span>
</span></span><span class="line"><span class="cl">	  ./ezctl setup test-k8s <span class="m">02</span>  <span class="o">(</span>or ./ezctl setup test-k8s etcd<span class="o">)</span>
</span></span><span class="line"><span class="cl">          ./ezctl setup test-k8s all
</span></span><span class="line"><span class="cl">          ./ezctl setup test-k8s <span class="m">04</span> -t restart_master
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vim playbooks/01.prepare.yml 
</span></span><span class="line"><span class="cl"><span class="c1">#系统基础初始化主机配置</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@master01:/etc/kubeasz# ./ezctl setup k8s-01 <span class="m">01</span>
</span></span><span class="line"><span class="cl"><span class="c1">#准备CA和基础系统设置</span></span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="5步骤2-部署etcd集群">5.步骤2-部署etcd集群</h2>
<p>可更改启动脚本路径及版本等⾃定义配置</p>
<div class="highlight" id="id-21"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/etc/kubeasz# ./ezctl setup k8s-01 <span class="m">02</span>
</span></span><span class="line"><span class="cl">ansible-playbook -i clusters/k8s-01/hosts -e @clusters/k8s-01/config.yml  playbooks/02.etcd.yml
</span></span><span class="line"><span class="cl">2023-01-03 13:39:13 INFO cluster:k8s-01 setup step:02 begins in 5s, press any key to abort</span></span></code></pre></div><p>健康检查</p>
<div class="highlight" id="id-22"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">NODE_IPS</span><span class="o">=</span><span class="s2">&#34;10.1.0.34 10.1.0.35&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@etcd01:~# <span class="k">for</span> ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span> <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> /usr/local/bin/etcdctl --endpoints<span class="o">=</span>https://<span class="si">${</span><span class="nv">ip</span><span class="si">}</span>:2379 --cacert<span class="o">=</span>/etc/kubernetes/ssl/ca.pem --cert<span class="o">=</span>/etc/kubernetes/ssl/etcd.pem --key<span class="o">=</span>/etc/kubernetes/ssl/etcd-key.pem endpoint health<span class="p">;</span> <span class="k">done</span>
</span></span><span class="line"><span class="cl">https://10.1.0.34:2379 is healthy: successfully committed proposal: <span class="nv">took</span> <span class="o">=</span> 14.95631ms
</span></span><span class="line"><span class="cl">https://10.1.0.35:2379 is healthy: successfully committed proposal: <span class="nv">took</span> <span class="o">=</span> 15.037491ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">注：以上返回信息表示etcd集群运⾏正常，否则异常！</span></span></code></pre></div><p>部署containerd</p>
<p>同步docker证书脚本：</p>
<div class="highlight" id="id-23"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">#⽬标主机列表</span>
</span></span><span class="line"><span class="cl"><span class="nv">IP</span><span class="o">=</span><span class="s2">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">10.1.0.32
</span></span></span><span class="line"><span class="cl"><span class="s2">10.1.0.33
</span></span></span><span class="line"><span class="cl"><span class="s2">10.1.0.34
</span></span></span><span class="line"><span class="cl"><span class="s2">10.1.0.35
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> node in <span class="si">${</span><span class="nv">IP</span><span class="si">}</span><span class="p">;</span><span class="k">do</span>
</span></span><span class="line"><span class="cl">  sshpass -p ceamg.com ssh-copy-id <span class="si">${</span><span class="nv">node</span><span class="si">}</span> -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">   <span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">node</span><span class="si">}</span><span class="s2"> 秘钥copy完成&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">node</span><span class="si">}</span><span class="s2"> 秘钥copy完成,准备环境初始化.....&#34;</span>
</span></span><span class="line"><span class="cl">   ssh <span class="si">${</span><span class="nv">node</span><span class="si">}</span> <span class="s2">&#34;mkdir /etc/containerd/certs.d/harbor.ceamg.com -p&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="nb">echo</span> <span class="s2">&#34;Harbor 证书创建成功!&#34;</span>
</span></span><span class="line"><span class="cl">   scp /etc/containerd/certs.d/harbor.ceamg.com/harbor.ceamg.com.cert  /etc/containerd/certs.d/harbor.ceamg.com/harbor.ceamg.com.crt /etc/containerd/certs.d/harbor.ceamg.com/harbor.ceamg.com.key /etc/containerd/certs.d/harbor.ceamg.com/ca.crt <span class="si">${</span><span class="nv">node</span><span class="si">}</span>:/etc/containerd/certs.d/harbor.ceamg.com/
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;Harbor 证书拷贝成功!&#34;</span>
</span></span><span class="line"><span class="cl">  ssh <span class="si">${</span><span class="nv">node</span><span class="si">}</span> <span class="s2">&#34;echo &#34;</span>10.1.0.38 harbor.ceamg.com<span class="s2">&#34; &gt;&gt; /etc/hosts&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;host 解析添加完成&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#scp -r /root/.docker ${node}:/root/</span>
</span></span><span class="line"><span class="cl"><span class="c1">#echo &#34;Harbor 认证件拷完成!&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">node</span><span class="si">}</span><span class="s2"> 秘钥copy失败&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="c1">#执⾏脚本进⾏证书分发</span>
</span></span><span class="line"><span class="cl">root@k8s-master1:/etc/kubeasz# bash /root/scp-key.sh</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="6步骤3-部署运行时环境">6.步骤3-部署运行时环境</h2>
<p>项目根据k8s版本提供不同的默认容器运行时：</p>
<ul>
<li>k8s 版本 &lt; 1.24 时，支持docker containerd 可选</li>
<li>k8s 版本 &gt;= 1.24 时，仅支持 containerd
<!-- raw HTML omitted --><!-- raw HTML omitted --></li>
</ul>
<h3 id="61-kubeasz-集成安装-containerd">6.1 kubeasz 集成安装 containerd</h3>
<p><!-- raw HTML omitted --> 注意：k8s 1.24以后，项目已经设置默认容器运行时为 containerd，无需手动修改</p>
<div class="highlight" id="id-24"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./ezctl setup k8s-01 <span class="m">05</span></span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="62-配置containerd-对接私有harbor仓库">6.2 配置containerd 对接私有harbor仓库</h3>
<p>修改role模板文件</p>
<div class="highlight" id="id-25"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vim roles/containerd/templates/config.toml.j2</span></span></code></pre></div><p>主要修改如下：</p>
<div class="highlight" id="id-26"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.auths<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs<span class="o">]</span>
</span></span><span class="line"><span class="cl">        <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs.<span class="s2">&#34;https://harbor.ceamg.com&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">           <span class="nv">username</span> <span class="o">=</span> <span class="s2">&#34;admin&#34;</span>
</span></span><span class="line"><span class="cl">           <span class="nv">password</span> <span class="o">=</span> <span class="s2">&#34;ceamg.com&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs.<span class="s2">&#34;easzlab.io.local:5000&#34;</span>.tls<span class="o">]</span>
</span></span><span class="line"><span class="cl">          <span class="nv">insecure_skip_verify</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs.<span class="s2">&#34;harbor.ceamg.com&#34;</span>.tls<span class="o">]</span>
</span></span><span class="line"><span class="cl">          <span class="nv">insecure_skip_verify</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">          <span class="nv">ca_file</span> <span class="o">=</span> <span class="s2">&#34;/etc/containerd/certs.d/harbor.ceamg.com/ca.crt&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="nv">cert_file</span> <span class="o">=</span> <span class="s2">&#34;/etc/containerd/certs.d/harbor.ceamg.com/harbor.ceamg.com.cert&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="nv">key_file</span> <span class="o">=</span> <span class="s2">&#34;/etc/containerd/certs.d/harbor.ceamg.com/harbor.ceamg.com.key&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.headers<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors<span class="o">]</span>
</span></span><span class="line"><span class="cl">        <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span class="s2">&#34;easzlab.io.local:5000&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">          <span class="nv">endpoint</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;http://easzlab.io.local:5000&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">        <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span class="s2">&#34;harbor.ceamg.com&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">          <span class="nv">endpoint</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;https://harbor.ceamg.com&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">        <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span class="s2">&#34;docker.io&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">          <span class="nv">endpoint</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;https://lc2kkql3.mirror.aliyuncs.com&#34;</span>,<span class="s2">&#34;https://docker.mirrors.ustc.edu.cn&#34;</span>, <span class="s2">&#34;http://hub-mirror.c.163.com&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">        <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span class="s2">&#34;gcr.io&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">          <span class="nv">endpoint</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;https://gcr.mirrors.ustc.edu.cn&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">        <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span class="s2">&#34;k8s.gcr.io&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">          <span class="nv">endpoint</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;https://gcr.mirrors.ustc.edu.cn/google-containers/&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">        <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span class="s2">&#34;quay.io&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">          <span class="nv">endpoint</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;https://quay.mirrors.ustc.edu.cn&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.auths.<span class="s2">&#34;https://harbor.ceamg.com&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">[</span>plugins.<span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span>.x509_key_pair_streaming<span class="o">]</span>
</span></span><span class="line"><span class="cl">      <span class="nv">tls_cert_file</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nv">tls_key_file</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span></span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="63-containerd-使用证书对接harbor实现上传下载">6.3 containerd 使用证书对接harbor实现上传下载</h3>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h4 id="631-使用脚本同步证书到客户端">6.3.1 使用脚本同步证书到客户端</h4>
<div class="highlight" id="id-27"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">#目标主机列表</span>
</span></span><span class="line"><span class="cl"><span class="nv">IP</span><span class="o">=</span><span class="s2">&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">10.1.0.32
</span></span></span><span class="line"><span class="cl"><span class="s2">10.1.0.33
</span></span></span><span class="line"><span class="cl"><span class="s2">10.1.0.34
</span></span></span><span class="line"><span class="cl"><span class="s2">10.1.0.35
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> node in <span class="si">${</span><span class="nv">IP</span><span class="si">}</span><span class="p">;</span><span class="k">do</span>
</span></span><span class="line"><span class="cl">  sshpass -p ceamg.com ssh-copy-id <span class="si">${</span><span class="nv">node</span><span class="si">}</span> -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">   <span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">node</span><span class="si">}</span><span class="s2"> 秘钥copy完成&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">node</span><span class="si">}</span><span class="s2"> 秘钥copy完成,准备环境初始化.....&#34;</span>
</span></span><span class="line"><span class="cl">   ssh <span class="si">${</span><span class="nv">node</span><span class="si">}</span> <span class="s2">&#34;mkdir /etc/containerd/certs.d/harbor.ceamg.com -p&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="nb">echo</span> <span class="s2">&#34;Harbor 证书创建成功!&#34;</span>
</span></span><span class="line"><span class="cl">   scp /etc/containerd/certs.d/harbor.ceamg.com/harbor.ceamg.com.cert  /etc/containerd/certs.d/harbor.ceamg.com/harbor.ceamg.com.crt /etc/containerd/certs.d/harbor.ceamg.com/harbor.ceamg.com.key /etc/containerd/certs.d/harbor.ceamg.com/ca.crt <span class="si">${</span><span class="nv">node</span><span class="si">}</span>:/etc/containerd/certs.d/harbor.ceamg.com/
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;Harbor 证书拷贝成功!&#34;</span>
</span></span><span class="line"><span class="cl">  ssh <span class="si">${</span><span class="nv">node</span><span class="si">}</span> <span class="s2">&#34;echo &#34;</span>10.1.0.38 harbor.ceamg.com<span class="s2">&#34; &gt;&gt; /etc/hosts&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;host 解析添加完成&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#scp -r /root/.docker ${node}:/root/</span>
</span></span><span class="line"><span class="cl"><span class="c1">#echo &#34;Harbor 认证件拷完成!&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">node</span><span class="si">}</span><span class="s2"> 秘钥copy失败&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span></span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h4 id="632-测试containerd-客户端使用证书登录harbor">6.3.2 测试containerd 客户端使用证书登录harbor</h4>
<p>推送镜像 <!-- raw HTML omitted --><a href="https://www.yuque.com/attachments/yuque/0/2023/pdf/33538388/1672731322660-c020aeef-2273-40b3-877c-c28089c7d7b0.pdf?_lake_card=%7B%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2023%2Fpdf%2F33538388%2F1672731322660-c020aeef-2273-40b3-877c-c28089c7d7b0.pdf%22%2C%22name%22%3A%22nerdctl.pdf%22%2C%22size%22%3A28536832%2C%22ext%22%3A%22pdf%22%2C%22source%22%3A%22%22%2C%22status%22%3A%22done%22%2C%22download%22%3Atrue%2C%22type%22%3A%22application%2Fpdf%22%2C%22mode%22%3A%22title%22%2C%22taskId%22%3A%22u2d812840-191c-45c4-aec0-85144ca300b%22%2C%22taskType%22%3A%22upload%22%2C%22__spacing%22%3A%22both%22%2C%22id%22%3A%22TItzJ%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22card%22%3A%22file%22%7D"target="_blank" rel="external nofollow noopener noreferrer">nerdctl.pdf</a></p>
<div class="highlight" id="id-28"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/etc/containerd/certs.d/harbor.ceamg.com# ls
</span></span><span class="line"><span class="cl">ca.crt  harbor.ceamg.com.cert  harbor.ceamg.com.crt  harbor.ceamg.com.key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@master01:/etc/containerd/certs.d/harbor.ceamg.com# nerdctl login harbor.ceamg.com
</span></span><span class="line"><span class="cl">WARNING: Your password will be stored unencrypted in /root/.docker/config.json.
</span></span><span class="line"><span class="cl">Configure a credential helper to remove this warning. See
</span></span><span class="line"><span class="cl">https://docs.docker.com/engine/reference/commandline/login/#credentials-store
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Login Succeeded
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@master01:/etc/containerd/certs.d/harbor.ceamg.com# nerdctl images
</span></span><span class="line"><span class="cl">REPOSITORY                        TAG       IMAGE ID        CREATED        PLATFORM       SIZE         BLOB SIZE
</span></span><span class="line"><span class="cl">nginx                             latest    0047b729188a    <span class="m">4</span> hours ago    linux/amd64    149.4 MiB    54.2 MiB
</span></span><span class="line"><span class="cl">harbor.ceamg.com/library/nginx    latest    0047b729188a    <span class="m">3</span> hours ago    linux/amd64    149.4 MiB    54.2 MiB
</span></span><span class="line"><span class="cl">root@master01:/etc/containerd/certs.d/harbor.ceamg.com# nerdctl push harbor.ceamg.com/library/nginx
</span></span><span class="line"><span class="cl">INFO<span class="o">[</span>0000<span class="o">]</span> pushing as a reduced-platform image <span class="o">(</span>application/vnd.docker.distribution.manifest.list.v2+json, sha256:3f727bfae5cee62f35f014637b350dbc1d0b416bdd1717b61c5ce5b036771aa0<span class="o">)</span> 
</span></span><span class="line"><span class="cl">index-sha256:3f727bfae5cee62f35f014637b350dbc1d0b416bdd1717b61c5ce5b036771aa0:    <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span> 
</span></span><span class="line"><span class="cl">manifest-sha256:9a821cadb1b13cb782ec66445325045b2213459008a41c72d8d87cde94b33c8c: <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span> 
</span></span><span class="line"><span class="cl">config-sha256:1403e55ab369cd1c8039c34e6b4d47ca40bbde39c371254c7cba14756f472f52:   <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span> 
</span></span><span class="line"><span class="cl">elapsed: 1.1 s                                                                    total:  9.3 Ki <span class="o">(</span>8.5 KiB/s<span class="o">)</span>          </span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="7步骤4-部署master">7.步骤4-部署master</h2>
<div class="highlight" id="id-29"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat playbooks/04.kube-master.yml
</span></span><span class="line"><span class="cl">- hosts: kube_master
</span></span><span class="line"><span class="cl">  roles:
</span></span><span class="line"><span class="cl">  - kube-lb        <span class="c1"># 四层负载均衡，监听在127.0.0.1:6443，转发到真实master节点apiserver服务</span>
</span></span><span class="line"><span class="cl">  - kube-master    <span class="c1">#</span>
</span></span><span class="line"><span class="cl">  - kube-node      <span class="c1"># 因为网络、监控等daemonset组件，master节点也推荐安装kubelet和kube-proxy服务</span>
</span></span><span class="line"><span class="cl">  ... </span></span></code></pre></div><div class="highlight" id="id-30"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/etc/kubeasz# ./ezctl setup k8s-01 <span class="m">04</span>
</span></span><span class="line"><span class="cl">ansible-playbook -i clusters/k8s-01/hosts -e @clusters/k8s-01/config.yml  playbooks/04.kube-master.yml
</span></span><span class="line"><span class="cl">2023-01-03 14:07:04 INFO cluster:k8s-01 setup step:04 begins in 5s, press any key to abort:</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<p><strong>验证 master 集群</strong></p>
<div class="highlight" id="id-31"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 查看进程状态</span>
</span></span><span class="line"><span class="cl">systemctl status kube-apiserver
</span></span><span class="line"><span class="cl">systemctl status kube-controller-manager
</span></span><span class="line"><span class="cl">systemctl status kube-scheduler
</span></span><span class="line"><span class="cl"><span class="c1"># 查看进程运行日志</span>
</span></span><span class="line"><span class="cl">journalctl -u kube-apiserver
</span></span><span class="line"><span class="cl">journalctl -u kube-controller-manager
</span></span><span class="line"><span class="cl">journalctl -u kube-scheduler</span></span></code></pre></div><p>执行 <code>kubectl get componentstatus</code> 可以看到</p>
<div class="highlight" id="id-32"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/etc/kubeasz# kubectl get componentstatus
</span></span><span class="line"><span class="cl">Warning: v1 ComponentStatus is deprecated in v1.19+
</span></span><span class="line"><span class="cl">NAME                 STATUS    MESSAGE                         ERROR
</span></span><span class="line"><span class="cl">scheduler            Healthy   ok                              
</span></span><span class="line"><span class="cl">controller-manager   Healthy   ok                              
</span></span><span class="line"><span class="cl">etcd-1               Healthy   <span class="o">{</span><span class="s2">&#34;health&#34;</span>:<span class="s2">&#34;true&#34;</span>,<span class="s2">&#34;reason&#34;</span>:<span class="s2">&#34;&#34;</span><span class="o">}</span>   
</span></span><span class="line"><span class="cl">etcd-0               Healthy   <span class="o">{</span><span class="s2">&#34;health&#34;</span>:<span class="s2">&#34;true&#34;</span>,<span class="s2">&#34;reason&#34;</span>:<span class="s2">&#34;&#34;</span><span class="o">}</span>   </span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="8步骤5-部署node节点">8.步骤5-部署node节点</h2>
<p><strong>kube_node</strong> 是集群中运行工作负载的节点，前置条件需要先部署好kube_master节点，它需要部署如下组件：</p>
<div class="highlight" id="id-33"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat playbooks/05.kube-node.yml
</span></span><span class="line"><span class="cl">- hosts: kube_node
</span></span><span class="line"><span class="cl">  roles:
</span></span><span class="line"><span class="cl">  - <span class="o">{</span> role: kube-lb, when: <span class="s2">&#34;inventory_hostname not in groups[&#39;kube_master&#39;]&#34;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">  - <span class="o">{</span> role: kube-node, when: <span class="s2">&#34;inventory_hostname not in groups[&#39;kube_master&#39;]&#34;</span> <span class="o">}</span></span></span></code></pre></div><ul>
<li>kube-lb：由nginx裁剪编译的四层负载均衡，用于将请求转发到主节点的 apiserver服务</li>
<li>kubelet：kube_node上最主要的组件</li>
<li>kube-proxy： 发布应用服务与负载均衡</li>
</ul>
<div class="highlight" id="id-34"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/etc/kubeasz# ./ezctl setup k8s-01 <span class="m">05</span>
</span></span><span class="line"><span class="cl">ansible-playbook -i clusters/k8s-01/hosts -e @clusters/k8s-01/config.yml  playbooks/05.kube-node.yml
</span></span><span class="line"><span class="cl">2023-01-04 09:06:25 INFO cluster:k8s-01 setup step:05 begins in 5s, press any key to abort:</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<p><strong>验证 node 状态</strong></p>
<div class="highlight" id="id-35"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">systemctl status kubelet	<span class="c1"># 查看状态</span>
</span></span><span class="line"><span class="cl">systemctl status kube-proxy
</span></span><span class="line"><span class="cl">journalctl -u kubelet		<span class="c1"># 查看日志</span>
</span></span><span class="line"><span class="cl">journalctl -u kube-proxy </span></span></code></pre></div><p>运行<code> kubectl get node</code> 可以看到类似</p>
<div class="highlight" id="id-36"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@worker01:/etc/containerd/certs.d/harbor.ceamg.com# kubectl get nodes
</span></span><span class="line"><span class="cl">NAME        STATUS                     ROLES    AGE   VERSION
</span></span><span class="line"><span class="cl">10.1.0.31   Ready,SchedulingDisabled   master   21h   v1.24.2
</span></span><span class="line"><span class="cl">10.1.0.32   Ready                      node     21h   v1.24.2
</span></span><span class="line"><span class="cl">10.1.0.33   Ready                      node     21h   v1.24.2</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="9步骤6-部署网络组件">9.步骤6-部署网络组件</h2>
<p>首先回顾下K8S网络设计原则，在配置集群网络插件或者实践K8S 应用/服务部署请牢记这些原则：</p>
<ul>
<li>1.每个Pod都拥有一个独立IP地址，Pod内所有容器共享一个网络命名空间</li>
<li>2.集群内所有Pod都在一个直接连通的扁平网络中，可通过IP直接访问
<ul>
<li>所有容器之间无需NAT就可以直接互相访问</li>
<li>所有Node和所有容器之间无需NAT就可以直接互相访问</li>
<li>容器自己看到的IP跟其他容器看到的一样</li>
</ul>
</li>
<li>3.Service cluster IP只可在集群内部访问，外部请求需要通过NodePort、LoadBalance或者Ingress来访问</li>
</ul>
<p>calico 是k8s社区最流行的网络插件之一，也是k8s-conformance test 默认使用的网络插件，功能丰富，支持network policy；是当前kubeasz项目的默认网络插件。  <!-- raw HTML omitted --> 如果需要安装calico，请在<strong>clusters/xxxx/hosts</strong>文件中设置变量 <code>CLUSTER_NETWORK=&quot;calico&quot;</code></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="91-使calico络组件">9.1 使⽤calico⽹络组件</h3>
<div class="highlight" id="id-37"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vim clusters/k8s-01/config.yml
</span></span><span class="line"><span class="cl"><span class="c1"># ------------------------------------------- calico</span>
</span></span><span class="line"><span class="cl"><span class="c1"># [calico]设置 CALICO_IPV4POOL_IPIP=“off”,可以提高网络性能，条件限制详见 docs/setup/calico.md</span>
</span></span><span class="line"><span class="cl">CALICO_IPV4POOL_IPIP: <span class="s2">&#34;Always&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [calico]设置 calico-node使用的host IP，bgp邻居通过该地址建立，可手工指定也可以自动发现</span>
</span></span><span class="line"><span class="cl">IP_AUTODETECTION_METHOD: <span class="s2">&#34;can-reach={{ groups[&#39;kube_master&#39;][0] }}&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [calico]设置calico 网络 backend: brid, vxlan, none</span>
</span></span><span class="line"><span class="cl">CALICO_NETWORKING_BACKEND: <span class="s2">&#34;brid&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [calico]设置calico 是否使用route reflectors</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果集群规模超过50个节点，建议启用该特性</span>
</span></span><span class="line"><span class="cl">CALICO_RR_ENABLED: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CALICO_RR_NODES 配置route reflectors的节点，如果未设置默认使用集群master节点 </span>
</span></span><span class="line"><span class="cl"><span class="c1"># CALICO_RR_NODES: [&#34;192.168.1.1&#34;, &#34;192.168.1.2&#34;]</span>
</span></span><span class="line"><span class="cl">CALICO_RR_NODES: <span class="o">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [calico]更新支持calico 版本: [v3.3.x] [v3.4.x] [v3.8.x] [v3.15.x]</span>
</span></span><span class="line"><span class="cl">calico_ver: <span class="s2">&#34;v3.19.4&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># [calico]calico 主版本</span>
</span></span><span class="line"><span class="cl">calico_ver_main: <span class="s2">&#34;{{ calico_ver.split(&#39;.&#39;)[0] }}.{{ calico_ver.split(&#39;.&#39;)[1] }}&#34;</span></span></span></code></pre></div><div class="highlight" id="id-38"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./ezctl setup k8s-01 <span class="m">06</span></span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="92-验证calico网络">9.2 验证calico网络</h3>
<p>执行calico安装成功后可以验证如下：(需要等待镜像下载完成，有时候即便上一步已经配置了docker国内加速，还是可能比较慢，请确认以下容器运行起来以后，再执行后续验证步骤)</p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="93-查看所有calico节点状态">9.3 查看所有calico节点状态</h3>
<div class="highlight" id="id-39"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/etc/kubeasz# kubectl get pod -A -o wide
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE     IP          NODE        NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">kube-system   calico-kube-controllers-5c8bb696bb-hf2cp   1/1     Running   <span class="m">0</span>          6m10s   10.1.0.33   10.1.0.33   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">kube-system   calico-node-6nlt6                          1/1     Running   <span class="m">0</span>          6m10s   10.1.0.32   10.1.0.32   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">kube-system   calico-node-fd6rj                          1/1     Running   <span class="m">0</span>          6m10s   10.1.0.33   10.1.0.33   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">kube-system   calico-node-lhgh4                          1/1     Running   <span class="m">0</span>          6m10s   10.1.0.31   10.1.0.31   &lt;none&gt;           &lt;none&gt;</span></span></code></pre></div><div class="highlight" id="id-40"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/etc/kubeasz# calicoctl node status
</span></span><span class="line"><span class="cl">Calico process is running.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">IPv4 BGP status
</span></span><span class="line"><span class="cl">+--------------+-------------------+-------+----------+-------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> PEER ADDRESS <span class="p">|</span>     PEER TYPE     <span class="p">|</span> STATE <span class="p">|</span>  SINCE   <span class="p">|</span>    INFO     <span class="p">|</span>
</span></span><span class="line"><span class="cl">+--------------+-------------------+-------+----------+-------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> 10.1.0.32    <span class="p">|</span> node-to-node mesh <span class="p">|</span> up    <span class="p">|</span> 04:16:44 <span class="p">|</span> Established <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> 10.1.0.33    <span class="p">|</span> node-to-node mesh <span class="p">|</span> up    <span class="p">|</span> 04:16:43 <span class="p">|</span> Established <span class="p">|</span>
</span></span><span class="line"><span class="cl">+--------------+-------------------+-------+----------+-------------+</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="94-创建容器测试网络通信">9.4 创建容器测试网络通信</h3>
<div class="highlight" id="id-41"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/etc/kubeasz# kubectl run net-test1 --image<span class="o">=</span>harbor.ceamg.com/library/alpine sleep <span class="m">360000</span>
</span></span><span class="line"><span class="cl">pod/net-test1 created
</span></span><span class="line"><span class="cl">root@master01:/etc/kubeasz# kubectl run net-test2 --image<span class="o">=</span>harbor.ceamg.com/library/alpine sleep <span class="m">360000</span>
</span></span><span class="line"><span class="cl">pod/net-test2 created
</span></span><span class="line"><span class="cl">root@master01:/etc/kubeasz# kubectl run net-test3 --image<span class="o">=</span>harbor.ceamg.com/library/alpine sleep <span class="m">360000</span>
</span></span><span class="line"><span class="cl">pod/net-test3 created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@master01:/etc/kubeasz# kubectl get pod -o wide
</span></span><span class="line"><span class="cl">NAME        READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">net-test1   1/1     Running   <span class="m">0</span>          19s   10.20.5.3     10.1.0.32   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">net-test2   1/1     Running   <span class="m">0</span>          15s   10.20.30.67   10.1.0.33   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">net-test3   1/1     Running   <span class="m">0</span>          12s   10.20.30.68   10.1.0.33   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl"><span class="nb">test</span>        1/1     Running   <span class="m">0</span>          16m   10.20.5.1     10.1.0.32   &lt;none&gt;           &lt;none&gt;</span></span></code></pre></div><div class="highlight" id="id-42"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/etc/kubeasz# kubectl <span class="nb">exec</span> -it net-test1 -- sh
</span></span><span class="line"><span class="cl">/ <span class="c1"># ping 10.20.30.67</span>
</span></span><span class="line"><span class="cl">PING 10.20.30.67 <span class="o">(</span>10.20.30.67<span class="o">)</span>: <span class="m">56</span> data bytes
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.20.30.67: <span class="nv">seq</span><span class="o">=</span><span class="m">0</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>0.481 ms
</span></span><span class="line"><span class="cl">^C
</span></span><span class="line"><span class="cl">--- 10.20.30.67 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">1</span> packets transmitted, <span class="m">1</span> packets received, 0% packet loss
</span></span><span class="line"><span class="cl">round-trip min/avg/max <span class="o">=</span> 0.481/0.481/0.481 ms
</span></span><span class="line"><span class="cl">/ <span class="c1"># ping 10.20.30.68</span>
</span></span><span class="line"><span class="cl">PING 10.20.30.68 <span class="o">(</span>10.20.30.68<span class="o">)</span>: <span class="m">56</span> data bytes
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.20.30.68: <span class="nv">seq</span><span class="o">=</span><span class="m">0</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>0.631 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.20.30.68: <span class="nv">seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>1.360 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.20.30.68: <span class="nv">seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">62</span> <span class="nv">time</span><span class="o">=</span>0.420 ms
</span></span><span class="line"><span class="cl">^C
</span></span><span class="line"><span class="cl">--- 10.20.30.68 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">3</span> packets transmitted, <span class="m">3</span> packets received, 0% packet loss
</span></span><span class="line"><span class="cl">round-trip min/avg/max <span class="o">=</span> 0.420/0.803/1.360 ms
</span></span><span class="line"><span class="cl">/ <span class="c1"># ping 223.5.5.5</span>
</span></span><span class="line"><span class="cl">PING 223.5.5.5 <span class="o">(</span>223.5.5.5<span class="o">)</span>: <span class="m">56</span> data bytes
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 223.5.5.5: <span class="nv">seq</span><span class="o">=</span><span class="m">0</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">114</span> <span class="nv">time</span><span class="o">=</span>7.597 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 223.5.5.5: <span class="nv">seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">114</span> <span class="nv">time</span><span class="o">=</span>7.072 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 223.5.5.5: <span class="nv">seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">114</span> <span class="nv">time</span><span class="o">=</span>7.583 ms
</span></span><span class="line"><span class="cl">^C
</span></span><span class="line"><span class="cl">--- 223.5.5.5 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">3</span> packets transmitted, <span class="m">3</span> packets received, 0% packet loss
</span></span><span class="line"><span class="cl">round-trip min/avg/max <span class="o">=</span> 7.072/7.417/7.597 ms</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="10步骤7-安装集群插件-coredns">10.步骤7-安装集群插件-coredns</h2>
<p>DNS 是 k8s 集群首要部署的组件，它为集群中的其他 pods 提供域名解析服务；主要可以解析 集群服务名 SVC 和 Pod hostname；目前建议部署 coredns。</p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="101-下载二进制包">10.1 下载二进制包</h3>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.24.md#downloads-for-v1249"target="_blank" rel="external nofollow noopener noreferrer">kubernetes/CHANGELOG-1.24.md at master · kubernetes/kubernetes</a></p>
<div class="highlight" id="id-43"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/usr/local/src# ll
</span></span><span class="line"><span class="cl">total <span class="m">489740</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root      <span class="m">4096</span> Jan  <span class="m">4</span> 13:09 ./
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">13</span> root root      <span class="m">4096</span> Jan  <span class="m">1</span> 13:20 ../
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root  <span class="m">30495559</span> Jan  <span class="m">4</span> 13:09 kubernetes-client-linux-amd64.tar.gz
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root <span class="m">123361203</span> Jan  <span class="m">4</span> 13:09 kubernetes-node-linux-amd64.tar.gz
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root <span class="m">347075448</span> Jan  <span class="m">4</span> 13:09 kubernetes-server-linux-amd64.tar.gz
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root    <span class="m">532769</span> Jan  <span class="m">4</span> 13:09 kubernetes.tar.gz
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#解压后</span>
</span></span><span class="line"><span class="cl">root@master01:/usr/local/src/kubernetes# ll
</span></span><span class="line"><span class="cl">total <span class="m">36996</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">10</span> root root     <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 ./
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root     <span class="m">4096</span> Jan  <span class="m">4</span> 13:11 ../
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root     <span class="m">4096</span> Dec  <span class="m">8</span> 18:26 addons/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root     <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 client/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">9</span> root root     <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 cluster/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root     <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 docs/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root     <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 hack/
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root <span class="m">37826576</span> Dec  <span class="m">8</span> 18:26 kubernetes-src.tar.gz
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">4</span> root root     <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 LICENSES/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root     <span class="m">4096</span> Dec  <span class="m">8</span> 18:25 node/
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root     <span class="m">4443</span> Dec  <span class="m">8</span> 18:31 README.md
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root     <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 server/
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root        <span class="m">8</span> Dec  <span class="m">8</span> 18:31 version
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#插件目录</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@master01:/usr/local/src/kubernetes/cluster/addons# ll
</span></span><span class="line"><span class="cl">total <span class="m">80</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">18</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 ./
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">9</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 ../
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 addon-manager/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 calico-policy-controller/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 cluster-loadbalancing/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 device-plugins/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">5</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 dns/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 dns-horizontal-autoscaler/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">4</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 fluentd-gcp/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 ip-masq-agent/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 kube-proxy/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 metadata-agent/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 metadata-proxy/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 metrics-server/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">5</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 node-problem-detector/
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root  <span class="m">104</span> Dec  <span class="m">8</span> 18:31 OWNERS
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">8</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 rbac/
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root <span class="m">1655</span> Dec  <span class="m">8</span> 18:31 README.md
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">8</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 storage-class/
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">4</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 volumesnapshots/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@master01:/usr/local/src/kubernetes/cluster/addons/dns/coredns# ll
</span></span><span class="line"><span class="cl">total <span class="m">44</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 ./
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">5</span> root root <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 ../
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root <span class="m">5060</span> Dec  <span class="m">8</span> 18:31 coredns.yaml.base
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root <span class="m">5110</span> Dec  <span class="m">8</span> 18:31 coredns.yaml.in
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root <span class="m">5112</span> Dec  <span class="m">8</span> 18:31 coredns.yaml.sed
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root <span class="m">1075</span> Dec  <span class="m">8</span> 18:31 Makefile
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root  <span class="m">344</span> Dec  <span class="m">8</span> 18:31 transforms2salt.sed
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root  <span class="m">287</span> Dec  <span class="m">8</span> 18:31 transforms2sed.sed
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cp coredns.yaml.base /root/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mv /root/coredns.yaml.base  /root/coredns-ceamg.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vim /root/coredns-ceamg.yaml</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="102-修改配置文件">10.2 修改配置文件</h3>
<p><strong>主要配置参数：</strong></p>
<div class="highlight" id="id-44"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">error: <span class="c1">#错误⽇志输出到stdout。</span>
</span></span><span class="line"><span class="cl">health： <span class="c1">#CoreDNS的运⾏状况报告为http://localhost:8080/health.</span>
</span></span><span class="line"><span class="cl">cache： <span class="c1">#启⽤coredns缓存。</span>
</span></span><span class="line"><span class="cl">reload：#配置⾃动重新加载配置⽂件，如果修改了ConfigMap的配置，会在两分钟后⽣效.
</span></span><span class="line"><span class="cl">loadbalance：#⼀个域名有多个记录会被轮询解析。
</span></span><span class="line"><span class="cl">cache <span class="m">30</span> <span class="c1">#缓存时间</span>
</span></span><span class="line"><span class="cl">kubernetes：#CoreDNS将根据指定的service domain名称在Kubernetes SVC中进⾏域名解析。
</span></span><span class="line"><span class="cl">forward： <span class="c1">#不是Kubernetes集群域内的域名查询都进⾏转发指定的服务器（/etc/resolv.conf）</span>
</span></span><span class="line"><span class="cl">prometheus：#CoreDNS的指标数据可以配置Prometheus 访问http://coredns svc:9153/metrics 进⾏收集。
</span></span><span class="line"><span class="cl">ready：#当coredns 服务启动完成后会进⾏在状态监测，会有个URL 路径为/ready返回200状态码，否则返回报错。</span></span></code></pre></div><p><code>kubernetes __DNS__DOMAIN_</code>是 <code>clusters/k8s-01/hosts</code> 中填写的内容<code>CLUSTER_DNS_DOMAIN</code></p>
<div class="highlight" id="id-45"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Cluster DNS Domain</span>
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER_DNS_DOMAIN</span><span class="o">=</span><span class="s2">&#34;ceamg.local&#34;</span></span></span></code></pre></div><p>212   <code>clusterIP: __DNS__SERVER__</code>是<code>clusters/k8s-01/hosts</code> 中填写的内容<code>SERVICE_CIDR</code> 第二个IP 也就是 10.10.0.2</p>
<div class="highlight" id="id-46"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># K8S Service CIDR, not overlap with node(host) networking</span>
</span></span><span class="line"><span class="cl"><span class="nv">SERVICE_CIDR</span><span class="o">=</span><span class="s2">&#34;10.10.0.0/16
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">/ # cat /etc/resolv.conf 
</span></span></span><span class="line"><span class="cl"><span class="s2">search default.svc.ceamg.local svc.ceamg.local ceamg.local
</span></span></span><span class="line"><span class="cl"><span class="s2">nameserver 10.10.0.2</span></span></span></code></pre></div><p>修改如下行内容：</p>
<div class="highlight" id="id-47"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="m">77</span>         kubernetes ceamg.local in-addr.arpa ip6.arpa <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="m">83</span>         forward . 192.168.0.15 <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="m">142</span>         image: harbor.ceamg.com/baseimages/coredns:v1.8.6
</span></span><span class="line"><span class="cl"><span class="m">145</span>           limits:
</span></span><span class="line"><span class="cl"><span class="m">146</span>             memory: 2048Mi
</span></span><span class="line"><span class="cl"><span class="m">147</span>           requests:
</span></span><span class="line"><span class="cl"><span class="m">148</span>             cpu: 1000m
</span></span><span class="line"><span class="cl"><span class="m">149</span>             memory: 1024Mi
</span></span><span class="line"><span class="cl"><span class="m">212</span>   clusterIP: 10.10.0.2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">209</span> spec:
</span></span><span class="line"><span class="cl"><span class="m">210</span>   type: NodePort
</span></span><span class="line"><span class="cl"><span class="m">211</span>   selector:
</span></span><span class="line"><span class="cl"><span class="m">212</span>     k8s-app: kube-dns
</span></span><span class="line"><span class="cl"><span class="m">213</span>   clusterIP: 10.10.0.2
</span></span><span class="line"><span class="cl"><span class="m">214</span>   ports:
</span></span><span class="line"><span class="cl"><span class="m">215</span>   - name: dns
</span></span><span class="line"><span class="cl"><span class="m">216</span>     port: <span class="m">53</span>
</span></span><span class="line"><span class="cl"><span class="m">217</span>     protocol: UDP
</span></span><span class="line"><span class="cl"><span class="m">218</span>   - name: dns-tcp
</span></span><span class="line"><span class="cl"><span class="m">219</span>     port: <span class="m">53</span>
</span></span><span class="line"><span class="cl"><span class="m">220</span>     protocol: TCP
</span></span><span class="line"><span class="cl"><span class="m">221</span>   - name: metrics
</span></span><span class="line"><span class="cl"><span class="m">222</span>     port: <span class="m">9153</span>
</span></span><span class="line"><span class="cl"><span class="m">223</span>     protocol: TCP
</span></span><span class="line"><span class="cl"><span class="m">224</span>     targetPort: <span class="m">9153</span>
</span></span><span class="line"><span class="cl"><span class="m">225</span>     nodePort: <span class="m">30009</span></span></span></code></pre></div><blockquote>
<p>查看资源格式：
kubectl explain</p>
</blockquote>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="103-下载镜像并推送到harbor">10.3 下载镜像并推送到harbor</h3>
<div class="highlight" id="id-48"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/usr/local/src/kubernetes/cluster/addons/dns/coredns# nerdctl pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.6
</span></span><span class="line"><span class="cl">root@master01:/usr/local/src/kubernetes/cluster/addons/dns/coredns# nerdctl tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.6 harbor.ceamg.com/baseimages/coredns:v1.8.6
</span></span><span class="line"><span class="cl">root@master01:/usr/local/src/kubernetes/cluster/addons/dns/coredns# nerdctl push harbor.ceamg.com/baseimages/coredns:v1.8.6
</span></span><span class="line"><span class="cl">INFO<span class="o">[</span>0000<span class="o">]</span> pushing as a reduced-platform image <span class="o">(</span>application/vnd.docker.distribution.manifest.list.v2+json, sha256:53011ff05d62cd740ae785a98f646ace63374073b0e564a35d4cea008f040940<span class="o">)</span> </span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="104-安装coredns">10.4 安装coredns</h3>
<div class="highlight" id="id-49"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/usr/local/src/kubernetes/cluster/addons/dns/coredns# kubectl apply -f /root/coredns-ceamg.yaml 
</span></span><span class="line"><span class="cl">serviceaccount/coredns created
</span></span><span class="line"><span class="cl">clusterrole.rbac.authorization.k8s.io/system:coredns created
</span></span><span class="line"><span class="cl">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created
</span></span><span class="line"><span class="cl">configmap/coredns created
</span></span><span class="line"><span class="cl">deployment.apps/coredns created
</span></span><span class="line"><span class="cl">service/kube-dns created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@master01:~# kubectl get pod -A
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                       READY   STATUS    RESTARTS      AGE
</span></span><span class="line"><span class="cl">default       net-test1                                  1/1     Running   <span class="m">0</span>             25m
</span></span><span class="line"><span class="cl">default       net-test2                                  1/1     Running   <span class="m">0</span>             25m
</span></span><span class="line"><span class="cl">default       net-test3                                  1/1     Running   <span class="m">0</span>             25m
</span></span><span class="line"><span class="cl">default       net-test4                                  1/1     Running   <span class="m">0</span>             49m
</span></span><span class="line"><span class="cl">kube-system   calico-kube-controllers-5c8bb696bb-hf2cp   1/1     Running   <span class="m">1</span> <span class="o">(</span>57m ago<span class="o">)</span>   151m
</span></span><span class="line"><span class="cl">kube-system   calico-node-6nlt6                          1/1     Running   <span class="m">0</span>             151m
</span></span><span class="line"><span class="cl">kube-system   calico-node-fd6rj                          1/1     Running   <span class="m">0</span>             151m
</span></span><span class="line"><span class="cl">kube-system   calico-node-lhgh4                          1/1     Running   <span class="m">0</span>             151m
</span></span><span class="line"><span class="cl">kube-system   coredns-6c496b89f6-hd8vf                   1/1     Running   <span class="m">0</span>             3s</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="105-启动容器测试域名解析">10.5 启动容器测试域名解析</h3>
<div class="highlight" id="id-50"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:~# kubectl <span class="nb">exec</span> -it net-test1 
</span></span><span class="line"><span class="cl">error: you must specify at least one <span class="nb">command</span> <span class="k">for</span> the container
</span></span><span class="line"><span class="cl">root@master01:~# kubectl <span class="nb">exec</span> -it net-test1  -- sh
</span></span><span class="line"><span class="cl">/ <span class="c1"># </span>
</span></span><span class="line"><span class="cl">/ <span class="c1"># ping www.baidu.com</span>
</span></span><span class="line"><span class="cl">PING www.baidu.com <span class="o">(</span>110.242.68.3<span class="o">)</span>: <span class="m">56</span> data bytes
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 110.242.68.3: <span class="nv">seq</span><span class="o">=</span><span class="m">0</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">49</span> <span class="nv">time</span><span class="o">=</span>9.778 ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--- www.baidu.com ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">1</span> packets transmitted, <span class="m">1</span> packets received, 0% packet loss
</span></span><span class="line"><span class="cl">round-trip min/avg/max <span class="o">=</span> 9.778/9.778/9.778 ms
</span></span><span class="line"><span class="cl">/ <span class="c1"># </span>
</span></span><span class="line"><span class="cl">/ <span class="c1"># cat /etc/resolv.conf </span>
</span></span><span class="line"><span class="cl">search default.svc.ceamg.local svc.ceamg.local ceamg.local
</span></span><span class="line"><span class="cl">nameserver 10.10.0.2
</span></span><span class="line"><span class="cl">options ndots:5</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="106-测试-prometheus-监控项">10.6 测试 prometheus 监控项</h3>
<p><a href="http://10.1.0.31:30009/metrics"target="_blank" rel="external nofollow noopener noreferrer">http://10.1.0.31:30009/metrics</a><!-- raw HTML omitted --><img loading="lazy" src="http://cdn1.ryanxin.live/1672815227326-157edf5d-ca34-48af-be12-9e8c529e0271.png" srcset="http://cdn1.ryanxin.live/1672815227326-157edf5d-ca34-48af-be12-9e8c529e0271.png, http://cdn1.ryanxin.live/1672815227326-157edf5d-ca34-48af-be12-9e8c529e0271.png 1.5x, http://cdn1.ryanxin.live/1672815227326-157edf5d-ca34-48af-be12-9e8c529e0271.png 2x" sizes="auto" data-title="prometheus监控项接口访问" data-alt="prometheus监控项接口访问" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="11-步骤8-安装集群插件-dashboard">11. 步骤8-安装集群插件-dashboard</h2>
<p><a href="https://github.com/kubernetes/dashboard"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/kubernetes/dashboard</a>
<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="111-下载对应kubernetes版本的dashboard">11.1 下载对应kubernetes版本的dashboard</h3>
<p><strong>Compatibility</strong></p>
<table>
<thead>
<tr>
<th>Kubernetes version</th>
<th>1.21</th>
<th>1.22</th>
<th>1.23</th>
<th>1.24</th>
</tr>
</thead>
<tbody>
<tr>
<td>Compatibility</td>
<td>?</td>
<td>?</td>
<td>?</td>
<td>✓</td>
</tr>
</tbody>
</table>
<ul>
<li>✓ Fully supported version range.</li>
<li>? Due to breaking changes between Kubernetes API versions, some features might not work correctly in the Dashboard.</li>
</ul>
<p><img loading="lazy" src="http://cdn1.ryanxin.live/1672820696762-d1dfdf70-772d-43c6-9047-43d17459f886.png" srcset="http://cdn1.ryanxin.live/1672820696762-d1dfdf70-772d-43c6-9047-43d17459f886.png, http://cdn1.ryanxin.live/1672820696762-d1dfdf70-772d-43c6-9047-43d17459f886.png 1.5x, http://cdn1.ryanxin.live/1672820696762-d1dfdf70-772d-43c6-9047-43d17459f886.png 2x" sizes="auto" data-title="2.6.1版本" data-alt="2.6.1版本" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<div class="highlight" id="id-51"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># Copyright 2017 The Kubernetes Authors.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># you may not use this file except in compliance with the License.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># You may obtain a copy of the License at</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#     http://www.apache.org/licenses/LICENSE-2.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Unless required by applicable law or agreed to in writing, software</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># See the License for the specific language governing permissions and</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># limitations under the License.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard-certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard-csrf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">csrf</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard-key-holder</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard-settings</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Allow Dashboard to get, update and delete Dashboard exclusive secrets.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;secrets&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resourceNames</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;kubernetes-dashboard-key-holder&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;kubernetes-dashboard-certs&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;kubernetes-dashboard-csrf&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;update&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;delete&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Allow Dashboard to get and update &#39;kubernetes-dashboard-settings&#39; config map.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;configmaps&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resourceNames</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;kubernetes-dashboard-settings&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;update&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Allow Dashboard to get metrics.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;services&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resourceNames</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;heapster&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;dashboard-metrics-scraper&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;proxy&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;services/proxy&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resourceNames</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;heapster&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;http:heapster:&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;https:heapster:&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;dashboard-metrics-scraper&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;http:dashboard-metrics-scraper&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Allow Metrics Scraper to get metrics from the Metrics server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;metrics.k8s.io&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;pods&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;nodes&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">seccompProfile</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RuntimeDefault</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetesui/dashboard:v2.6.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- --<span class="l">auto-generate-certificates</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- --<span class="l">namespace=kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># Uncomment the following line to manually specify Kubernetes API server Host</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># If not specified, Dashboard will attempt to auto discover the API server and connect</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># to it. Uncomment only if the default does not work.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># - --apiserver-host=http://my-address:port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard-certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="c"># Create on-disk volume to store exec logs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">HTTPS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">allowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">readOnlyRootFilesystem</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">1001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="m">2001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard-certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard-certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;kubernetes.io/os&#34;: </span><span class="l">linux</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Comment the following tolerations if Dashboard must not be deployed on master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node-role.kubernetes.io/master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">NoSchedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">dashboard-metrics-scraper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dashboard-metrics-scraper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">dashboard-metrics-scraper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">dashboard-metrics-scraper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dashboard-metrics-scraper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">dashboard-metrics-scraper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">dashboard-metrics-scraper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">seccompProfile</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RuntimeDefault</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dashboard-metrics-scraper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetesui/metrics-scraper:v1.0.8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">allowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">readOnlyRootFilesystem</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">1001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">runAsGroup</span><span class="p">:</span><span class="w"> </span><span class="m">2001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">&#34;kubernetes.io/os&#34;: </span><span class="l">linux</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Comment the following tolerations if Dashboard must not be deployed on master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node-role.kubernetes.io/master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">NoSchedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="112-修改service暴露方式">11.2 修改service暴露方式</h3>
<div class="highlight" id="id-52"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">32 kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">33 apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">34 metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">35   labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">36     k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">37   name</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">38   namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">39 spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">40   type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">41   ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">42     - port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">43       targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">44       nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">30010</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">45   selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">46     k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span></span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="113-下载镜像推送到harbor">11.3 下载镜像推送到harbor</h3>
<div class="highlight" id="id-53"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">root@master01:~# cat k8s-dashboard-ceamg.yml | grep image</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetesui/dashboard:v2.6.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetesui/metrics-scraper:v1.0.8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">root@master01:~#nerdctl pull kubernetesui/dashboard:v2.6.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">root@master01:~# nerdctl pull kubernetesui/metrics-scraper:v1.0.8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">root@master01:~# nerdctl tag kubernetesui/dashboard:v2.6.1 harbor.ceamg.com/baseimages/dashboard:v2.6.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">root@master01:~# nerdctl push harbor.ceamg.com/baseimages/dashboard:v2.6.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">INFO[0000] pushing as a reduced-platform image (application/vnd.docker.distribution.manifest.list.v2+json, sha256:f12df071f8bad3e1965b5246095bd3f78df0eb76ceabcc0878d42849d33e4a10) </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">index-sha256:f12df071f8bad3e1965b5246095bd3f78df0eb76ceabcc0878d42849d33e4a10</span><span class="p">:</span><span class="w">    </span><span class="l">done           |++++++++++++++++++++++++++++++++++++++| </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">manifest-sha256:d95e1adbe846450bf9451f9c95ab33865115909cf3962960af5983bb916cf320</span><span class="p">:</span><span class="w"> </span><span class="l">done           |++++++++++++++++++++++++++++++++++++++| </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">config-sha256:783e2b6d87ed93a9f9fee34e84c2b029b7a9572b2f41f761437e58af9c26827f</span><span class="p">:</span><span class="w">   </span><span class="l">done           |++++++++++++++++++++++++++++++++++++++| </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">elapsed: 3.2 s                                                                    total</span><span class="p">:</span><span class="w">  </span><span class="m">2.5</span><span class="w"> </span><span class="l">Ki (814.0 B/s)                                       </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">root@master01:~# </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">root@master01:~# nerdctl tag kubernetesui/metrics-scraper:v1.0.8 harbor.ceamg.com/baseimages/metrics-scraper:v1.0.8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">root@master01:~# nerdctl push harbor.ceamg.com/baseimages/metrics-scraper:v1.0.8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">INFO[0000] pushing as a reduced-platform image (application/vnd.docker.distribution.manifest.list.v2+json, sha256:9fdef455b4f9a8ee315a0aa3bd71787cfd929e759da3b4d7e65aaa56510d747b) </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">index-sha256:9fdef455b4f9a8ee315a0aa3bd71787cfd929e759da3b4d7e65aaa56510d747b</span><span class="p">:</span><span class="w">    </span><span class="l">done           |++++++++++++++++++++++++++++++++++++++| </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">manifest-sha256:43227e8286fd379ee0415a5e2156a9439c4056807e3caa38e1dd413b0644807a</span><span class="p">:</span><span class="w"> </span><span class="l">done           |++++++++++++++++++++++++++++++++++++++| </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">config-sha256:115053965e86b2df4d78af78d7951b8644839d20a03820c6df59a261103315f7</span><span class="p">:</span><span class="w">   </span><span class="l">done           |++++++++++++++++++++++++++++++++++++++| </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">elapsed: 0.8 s        total</span><span class="p">:</span><span class="w">  </span><span class="m">2.2</span><span class="w"> </span><span class="l">Ki (2.7 KiB/s)                                   </span></span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="114-修改镜像地址">11.4 修改镜像地址</h3>
<div class="highlight" id="id-54"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">195           image</span><span class="p">:</span><span class="w"> </span><span class="l">harbor.ceamg.com/baseimages/dashboard:v2.6.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">280           image</span><span class="p">:</span><span class="w"> </span><span class="l">harbor.ceamg.com/baseimages/metrics-scraper:v1.0.8</span></span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="115-安装dashboard组件">11.5 安装dashboard组件</h3>
<div class="highlight" id="id-55"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl apply -f k8s-dashboard-ceamg.yml</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="116-查看组件运行状态">11.6 查看组件运行状态</h3>
<div class="highlight" id="id-56"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">root@master01:~# kubectl get pod -A</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">NAMESPACE              NAME                                        READY   STATUS    RESTARTS       AGE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">default                net-test1                                   1/1     Running   0              99m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">default                net-test2                                   1/1     Running   0              99m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">default                net-test3                                   1/1     Running   0              99m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">default                net-test4                                   1/1     Running   0              123m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">kube-system            calico-kube-controllers-5c8bb696bb-hf2cp    1/1     Running   1 (131m ago)   3h45m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">kube-system            calico-node-6nlt6                           1/1     Running   0              3h45m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">kube-system            calico-node-fd6rj                           1/1     Running   0              3h45m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">kube-system            calico-node-lhgh4                           1/1     Running   0              3h45m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">kube-system            coredns-6c496b89f6-hd8vf                    1/1     Running   0              73m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">kubernetes-dashboard   dashboard-metrics-scraper-8b9c56ffb-tjjc4   1/1     Running   0              14s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">kubernetes-dashboard   kubernetes-dashboard-6f9f585c48-vv2pz       1/1     Running   0              14s</span></span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="117-获取登陆-token">11.7 获取登陆 token</h3>
<div class="highlight" id="id-57"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin-user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin-user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster-admin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin-user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">root@master01:~# kubectl apply -f admin-user.yml </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">serviceaccount/admin-user created</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">clusterrolebinding.rbac.authorization.k8s.io/admin-user created</span></span></span></code></pre></div><p>:::warning
<strong>注意</strong>：v1.24.0 更新之后进行创建 ServiceAccount 不会自动生成 Secret 需要对其手动创建
:::</p>
<div class="highlight" id="id-58"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 创建token</span>
</span></span><span class="line"><span class="cl">root@master01:~# kubectl -n kubernetes-dashboard create token admin-user --duration 604800s
</span></span><span class="line"><span class="cl">eyJhbGciOiJSUzI1NiIsImtpZCI6ImptTldRRDRZZVVSdXRhaU1RNUtyQmJUSmVTbW55VThqNHhLU1l6U3B4R28ifQ.eyJhdWQiOlsiYXBpIiwiaXN0aW8tY2EiXSwiZXhwIjoxNjczNDI1MDI3LCJpYXQiOjE2NzI4MjAyMjcsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2YyIsImt1YmVybmV0ZXMuaW8iOnsibmFtZXNwYWNlIjoia3ViZXJuZXRlcy1kYXNoYm9hcmQiLCJzZXJ2aWNlYWNjb3VudCI6eyJuYW1lIjoiYWRtaW4tdXNlciIsInVpZCI6IjdhNTAzN2E4LTQ2MGEtNGM3YS05NWQ5LTNjM2JkNGQ0YTUyZSJ9fSwibmJmIjoxNjcyODIwMjI3LCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.ciX6c6hUe8NqPHWp7GteAecZ75L50sKL0l0jk6hETJM9xUVkE-knhm-wQWogOCq1vJMWtg_qeYqsyxfFAMbXdnGgXUXH3tuLVe0NcSHfGVa0BBfjUqODODoAcKdEWJJqdTO_QCfzHTTGkBDZoPgqjALBFzMVh_anlUdeSehRtTh6y2L0dsMRbWuEp1YI8phXumRGIbsrRDOenCycfyPh2AUEChMhD_uYS85z2tDVbno-1y4sSoSiPPn-awUEAxo-ly7zIOUz_b6ZiMhM6nGTuJ-7Jyxq4A8f2pj-iyXA_ve3g1Y4AaInd1aaZhCQ_82rOpmHP0Idyzg_lqEneltBaw</span></span></code></pre></div><p>方式二<!-- raw HTML omitted -->手动创建secrit</p>
<div class="highlight" id="id-59"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/zookeeper# kubectl apply -f secrit 
</span></span><span class="line"><span class="cl">secret/admin-user created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Secret
</span></span><span class="line"><span class="cl">type: kubernetes.io/service-account-token
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: admin-user
</span></span><span class="line"><span class="cl">  namespace: kubernetes-dashboard
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    kubernetes.io/service-account.name: <span class="s2">&#34;admin-user&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@master01:/zookeeper# kubectl -n kubernetes-dashboard describe sa admin-user
</span></span><span class="line"><span class="cl">Name:                admin-user
</span></span><span class="line"><span class="cl">Namespace:           kubernetes-dashboard
</span></span><span class="line"><span class="cl">Labels:              &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:         &lt;none&gt;
</span></span><span class="line"><span class="cl">Image pull secrets:  &lt;none&gt;
</span></span><span class="line"><span class="cl">Mountable secrets:   &lt;none&gt;
</span></span><span class="line"><span class="cl">Tokens:              admin-user
</span></span><span class="line"><span class="cl">Events:              &lt;none&gt;
</span></span><span class="line"><span class="cl">root@master01:/zookeeper# kubectl -n kubernetes-dashboard describe secrets admin-user
</span></span><span class="line"><span class="cl">Name:         admin-user
</span></span><span class="line"><span class="cl">Namespace:    kubernetes-dashboard
</span></span><span class="line"><span class="cl">Labels:       &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:  kubernetes.io/service-account.name: admin-user
</span></span><span class="line"><span class="cl">              kubernetes.io/service-account.uid: 7a5037a8-460a-4c7a-95d9-3c3bd4d4a52e
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Type:  kubernetes.io/service-account-token
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">Data</span>
</span></span><span class="line"><span class="cl"><span class="o">====</span>
</span></span><span class="line"><span class="cl">namespace:  <span class="m">20</span> bytes
</span></span><span class="line"><span class="cl">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImptTldRRDRZZVVSdXRhaU1RNUtyQmJUSmVTbW55VThqNHhLU1l6U3B4R28ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI3YTUwMzdhOC00NjBhLTRjN2EtOTVkOS0zYzNiZDRkNGE1MmUiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.YIZ1UepKs7WzebxKMOVIPkmz0KLkIyV59S7D0x4sBpefqseX6lSfV_YbhDjQv0dm6ne9HJ85dHzF1-qmSJEO_EW3m-aNOfmem7jkqr8XDUIgHceeKZimauTodKvApsWWD_Flsk7r2nin-MoNkOJ5mi6g5Pu3iQuKhQINl3G9Wwch5c-5FV0l-RBWR1rw9rVby6fh1jfkAhMWGL7lWKJeAA6fE2dTJVSJ-ZhW_bzwPTTDKNhIlpRsyKEnFXwWmK9Jqoxq8y5H0iJIhbvkYCxwUG2Gjjfi6jIWhJvWo20_kTq5Cy-7BNXafBI5D6VKmFwHFyOLBQcvkntN2IpVRNcfbA
</span></span><span class="line"><span class="cl">ca.crt:     <span class="m">1302</span> bytes</span></span></code></pre></div><p><a href="https://blog.csdn.net/qq_41619571/article/details/127217339"target="_blank" rel="external nofollow noopener noreferrer">https://blog.csdn.net/qq_41619571/article/details/127217339</a></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="118-登录测试">11.8 登录测试</h3>
<p><img loading="lazy" src="http://cdn1.ryanxin.live/1672820370137-de794fe7-65da-418b-85a4-b92f3b8b3e42.png" srcset="http://cdn1.ryanxin.live/1672820370137-de794fe7-65da-418b-85a4-b92f3b8b3e42.png, http://cdn1.ryanxin.live/1672820370137-de794fe7-65da-418b-85a4-b92f3b8b3e42.png 1.5x, http://cdn1.ryanxin.live/1672820370137-de794fe7-65da-418b-85a4-b92f3b8b3e42.png 2x" sizes="auto" data-title="输入token" data-alt="输入token" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p><img loading="lazy" src="http://cdn1.ryanxin.live/1672820388726-cab07cf9-cbb9-4db3-bb1d-ef6ecfab21ff.png" srcset="http://cdn1.ryanxin.live/1672820388726-cab07cf9-cbb9-4db3-bb1d-ef6ecfab21ff.png, http://cdn1.ryanxin.live/1672820388726-cab07cf9-cbb9-4db3-bb1d-ef6ecfab21ff.png 1.5x, http://cdn1.ryanxin.live/1672820388726-cab07cf9-cbb9-4db3-bb1d-ef6ecfab21ff.png 2x" sizes="auto" data-title="界面展示" data-alt="界面展示" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="12-集群管理">12. 集群管理</h2>
<p>集群管理主要是添加master、添加node、删除master与删除node等节点管理及监控</p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="121-添加node节点">12.1 添加node节点</h3>
<div class="highlight" id="id-60"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./ezctl add-node k8s-01 10.1.0.39</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="122-添加master-节点">12.2 添加master 节点</h3>
<div class="highlight" id="id-61"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/etc/kubeasz# ./ezctl add-master k8s-01 10.1.0.30</span></span></code></pre></div><p>master 节点添加后会向 node节点 <code>/etc/kube-lb/conf/kube-lb.conf</code> 中添加反向代理节点</p>
<div class="highlight" id="id-62"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">user root<span class="p">;</span>
</span></span><span class="line"><span class="cl">worker_processes 1<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">error_log  /etc/kube-lb/logs/error.log warn<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">events <span class="o">{</span>
</span></span><span class="line"><span class="cl">    worker_connections  3000<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">stream <span class="o">{</span>
</span></span><span class="line"><span class="cl">    upstream backend <span class="o">{</span>
</span></span><span class="line"><span class="cl">        server 10.1.0.30:6443    <span class="nv">max_fails</span><span class="o">=</span><span class="m">2</span> <span class="nv">fail_timeout</span><span class="o">=</span>3s<span class="p">;</span>
</span></span><span class="line"><span class="cl">        server 10.1.0.31:6443    <span class="nv">max_fails</span><span class="o">=</span><span class="m">2</span> <span class="nv">fail_timeout</span><span class="o">=</span>3s<span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    server <span class="o">{</span>
</span></span><span class="line"><span class="cl">        listen 127.0.0.1:6443<span class="p">;</span>
</span></span><span class="line"><span class="cl">        proxy_connect_timeout 1s<span class="p">;</span>
</span></span><span class="line"><span class="cl">        proxy_pass backend<span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="123-验证当前节点">12.3 验证当前节点</h3>
<div class="highlight" id="id-63"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master02:~# kubectl get nodes
</span></span><span class="line"><span class="cl">NAME        STATUS                     ROLES    AGE   VERSION
</span></span><span class="line"><span class="cl">10.1.0.30   Ready,SchedulingDisabled   master   15m   v1.24.2
</span></span><span class="line"><span class="cl">10.1.0.31   Ready,SchedulingDisabled   master   44h   v1.24.2
</span></span><span class="line"><span class="cl">10.1.0.32   Ready                      node     44h   v1.24.2
</span></span><span class="line"><span class="cl">10.1.0.33   Ready                      node     44h   v1.24.2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@master02:~# calicoctl node status
</span></span><span class="line"><span class="cl">Calico process is running.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">IPv4 BGP status
</span></span><span class="line"><span class="cl">+--------------+-------------------+-------+----------+-------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> PEER ADDRESS <span class="p">|</span>     PEER TYPE     <span class="p">|</span> STATE <span class="p">|</span>  SINCE   <span class="p">|</span>    INFO     <span class="p">|</span>
</span></span><span class="line"><span class="cl">+--------------+-------------------+-------+----------+-------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> 10.1.0.31    <span class="p">|</span> node-to-node mesh <span class="p">|</span> up    <span class="p">|</span> 02:47:43 <span class="p">|</span> Established <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> 10.1.0.32    <span class="p">|</span> node-to-node mesh <span class="p">|</span> up    <span class="p">|</span> 02:47:12 <span class="p">|</span> Established <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> 10.1.0.33    <span class="p">|</span> node-to-node mesh <span class="p">|</span> up    <span class="p">|</span> 02:47:31 <span class="p">|</span> Established <span class="p">|</span>
</span></span><span class="line"><span class="cl">+--------------+-------------------+-------+----------+-------------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">IPv6 BGP status
</span></span><span class="line"><span class="cl">No IPv6 peers found.</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="13-集群升级">13. 集群升级</h2>
<p>先升级master 保证集群中至少有一个master节点可用 ，在node节点nginx反向代理中注释掉要升级的master节点。</p>
<p><img loading="lazy" src="http://cdn1.ryanxin.live/1672892592550-0602394c-6d2e-4912-b773-459e3460253a.jpg" srcset="http://cdn1.ryanxin.live/1672892592550-0602394c-6d2e-4912-b773-459e3460253a.jpg, http://cdn1.ryanxin.live/1672892592550-0602394c-6d2e-4912-b773-459e3460253a.jpg 1.5x, http://cdn1.ryanxin.live/1672892592550-0602394c-6d2e-4912-b773-459e3460253a.jpg 2x" sizes="auto" data-title="1672892592550-0602394c-6d2e-4912-b773-459e3460253a" data-alt="1672892592550-0602394c-6d2e-4912-b773-459e3460253a" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="131-升级master节点">13.1 升级master节点</h3>
<p>在各个node节点反向代理配置中注释掉要升级的master节点</p>
<div class="highlight" id="id-64"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vim /etc/kube-lb/conf/kube-lb.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">user root<span class="p">;</span>
</span></span><span class="line"><span class="cl">worker_processes 1<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">error_log  /etc/kube-lb/logs/error.log warn<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">events <span class="o">{</span>
</span></span><span class="line"><span class="cl">    worker_connections  3000<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">stream <span class="o">{</span>
</span></span><span class="line"><span class="cl">    upstream backend <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#server 10.1.0.30:6443    max_fails=2 fail_timeout=3s;</span>
</span></span><span class="line"><span class="cl">        server 10.1.0.31:6443    <span class="nv">max_fails</span><span class="o">=</span><span class="m">2</span> <span class="nv">fail_timeout</span><span class="o">=</span>3s<span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    server <span class="o">{</span>
</span></span><span class="line"><span class="cl">        listen 127.0.0.1:6443<span class="p">;</span>
</span></span><span class="line"><span class="cl">        proxy_connect_timeout 1s<span class="p">;</span>
</span></span><span class="line"><span class="cl">        proxy_pass backend<span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#重启服务</span>
</span></span><span class="line"><span class="cl">root@worker01:~# systemctl restart kube-lb.service</span></span></code></pre></div><p>node节点升级需要停服务，需要关闭kubelet 和 kube-proxy服务替换二进制文件</p>
<ul>
<li>kube-apiserver</li>
<li>kube-controller-manager</li>
<li>kubectl</li>
<li>kubelet</li>
<li>kube-proxy</li>
<li>kube-scheduler</li>
</ul>
<p>去github找到想要升级的版本下载二进制文件：</p>
<p><a href="https://github.com/kubernetes/kubernetes/releases"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/kubernetes/kubernetes/releases</a></p>
<div class="highlight" id="id-65"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/usr/local/src# ll
</span></span><span class="line"><span class="cl">total <span class="m">489744</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root      <span class="m">4096</span> Jan  <span class="m">4</span> 13:11 ./
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">13</span> root root      <span class="m">4096</span> Jan  <span class="m">1</span> 13:20 ../
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">10</span> root root      <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 kubernetes/
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root  <span class="m">30495559</span> Jan  <span class="m">4</span> 13:09 kubernetes-client-linux-amd64.tar.gz
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root <span class="m">123361203</span> Jan  <span class="m">4</span> 13:09 kubernetes-node-linux-amd64.tar.gz
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root <span class="m">347075448</span> Jan  <span class="m">4</span> 13:09 kubernetes-server-linux-amd64.tar.gz
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root    <span class="m">532769</span> Jan  <span class="m">4</span> 13:09 kubernetes.tar.gz</span></span></code></pre></div><p>二进制文件在/server/bin目录下面</p>
<div class="highlight" id="id-66"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/usr/local/src/kubernetes/server/bin# ll -ls
</span></span><span class="line"><span class="cl">total <span class="m">1090008</span>
</span></span><span class="line"><span class="cl">     <span class="m">4</span> drwxr-xr-x <span class="m">2</span> root root      <span class="m">4096</span> Dec  <span class="m">8</span> 18:26 ./
</span></span><span class="line"><span class="cl">     <span class="m">4</span> drwxr-xr-x <span class="m">3</span> root root      <span class="m">4096</span> Dec  <span class="m">8</span> 18:31 ../
</span></span><span class="line"><span class="cl"> <span class="m">54176</span> -rwxr-xr-x <span class="m">1</span> root root  <span class="m">55476224</span> Dec  <span class="m">8</span> 18:26 apiextensions-apiserver*
</span></span><span class="line"><span class="cl"> <span class="m">43380</span> -rwxr-xr-x <span class="m">1</span> root root  <span class="m">44421120</span> Dec  <span class="m">8</span> 18:26 kubeadm*
</span></span><span class="line"><span class="cl"> <span class="m">48408</span> -rwxr-xr-x <span class="m">1</span> root root  <span class="m">49569792</span> Dec  <span class="m">8</span> 18:26 kube-aggregator*
</span></span><span class="line"><span class="cl"><span class="m">123032</span> -rwxr-xr-x <span class="m">1</span> root root <span class="m">125980672</span> Dec  <span class="m">8</span> 18:26 kube-apiserver*
</span></span><span class="line"><span class="cl">     <span class="m">4</span> -rw-r--r-- <span class="m">1</span> root root         <span class="m">8</span> Dec  <span class="m">8</span> 18:25 kube-apiserver.docker_tag
</span></span><span class="line"><span class="cl"><span class="m">128092</span> -rw------- <span class="m">1</span> root root <span class="m">131165184</span> Dec  <span class="m">8</span> 18:25 kube-apiserver.tar
</span></span><span class="line"><span class="cl"><span class="m">112896</span> -rwxr-xr-x <span class="m">1</span> root root <span class="m">115605504</span> Dec  <span class="m">8</span> 18:26 kube-controller-manager*
</span></span><span class="line"><span class="cl">     <span class="m">4</span> -rw-r--r-- <span class="m">1</span> root root         <span class="m">8</span> Dec  <span class="m">8</span> 18:25 kube-controller-manager.docker_tag
</span></span><span class="line"><span class="cl"><span class="m">117960</span> -rw------- <span class="m">1</span> root root <span class="m">120790016</span> Dec  <span class="m">8</span> 18:25 kube-controller-manager.tar
</span></span><span class="line"><span class="cl"> <span class="m">44680</span> -rwxr-xr-x <span class="m">1</span> root root  <span class="m">45752320</span> Dec  <span class="m">8</span> 18:26 kubectl*
</span></span><span class="line"><span class="cl"> <span class="m">53796</span> -rwxr-xr-x <span class="m">1</span> root root  <span class="m">55085992</span> Dec  <span class="m">8</span> 18:26 kubectl-convert*
</span></span><span class="line"><span class="cl"><span class="m">113376</span> -rwxr-xr-x <span class="m">1</span> root root <span class="m">116095704</span> Dec  <span class="m">8</span> 18:26 kubelet*
</span></span><span class="line"><span class="cl">  <span class="m">1452</span> -rwxr-xr-x <span class="m">1</span> root root   <span class="m">1486848</span> Dec  <span class="m">8</span> 18:26 kube-log-runner*
</span></span><span class="line"><span class="cl"> <span class="m">40820</span> -rwxr-xr-x <span class="m">1</span> root root  <span class="m">41799680</span> Dec  <span class="m">8</span> 18:26 kube-proxy*
</span></span><span class="line"><span class="cl">     <span class="m">4</span> -rw-r--r-- <span class="m">1</span> root root         <span class="m">8</span> Dec  <span class="m">8</span> 18:25 kube-proxy.docker_tag
</span></span><span class="line"><span class="cl"><span class="m">109280</span> -rw------- <span class="m">1</span> root root <span class="m">111901184</span> Dec  <span class="m">8</span> 18:25 kube-proxy.tar
</span></span><span class="line"><span class="cl"> <span class="m">46096</span> -rwxr-xr-x <span class="m">1</span> root root  <span class="m">47202304</span> Dec  <span class="m">8</span> 18:26 kube-scheduler*
</span></span><span class="line"><span class="cl">     <span class="m">4</span> -rw-r--r-- <span class="m">1</span> root root         <span class="m">8</span> Dec  <span class="m">8</span> 18:25 kube-scheduler.docker_tag
</span></span><span class="line"><span class="cl"> <span class="m">51160</span> -rw------- <span class="m">1</span> root root  <span class="m">52386816</span> Dec  <span class="m">8</span> 18:25 kube-scheduler.tar
</span></span><span class="line"><span class="cl">  <span class="m">1380</span> -rwxr-xr-x <span class="m">1</span> root root   <span class="m">1413120</span> Dec  <span class="m">8</span> 18:26 mounter*</span></span></code></pre></div><div class="highlight" id="id-67"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/usr/local/src/kubernetes/server/bin# ./kube-apiserver --version
</span></span><span class="line"><span class="cl">Kubernetes v1.24.9
</span></span><span class="line"><span class="cl"><span class="c1">#当前版本</span>
</span></span><span class="line"><span class="cl">root@master01:/usr/local/src/kubernetes/server/bin# /etc/kubeasz/bin/kube-apiserver --version
</span></span><span class="line"><span class="cl">Kubernetes v1.24.2</span></span></code></pre></div><p>停止服务</p>
<div class="highlight" id="id-68"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">systemctl stop kube-proxy kube-controller-manager kubelet kube-scheduler kube-apiserver</span></span></code></pre></div><p>替换二进制文件</p>
<div class="highlight" id="id-69"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/usr/local/src/kubernetes/server/bin# scp kube-apiserver kube-controller-manager kubelet kube-scheduler kube-proxy 10.1.0.30:/usr/local/bin
</span></span><span class="line"><span class="cl">kube-apiserver                                                                                                                                                                              100%  120MB 129.5MB/s   00:00    
</span></span><span class="line"><span class="cl">kube-controller-manager                                                                                                                                                                     100%  110MB 128.8MB/s   00:00    
</span></span><span class="line"><span class="cl">kubelet                                                                                                                                                                                     100%  111MB 137.1MB/s   00:00    
</span></span><span class="line"><span class="cl">kube-scheduler                                                                                                                                                                              100%   45MB 128.5MB/s   00:00    
</span></span><span class="line"><span class="cl">kube-proxy                                                                                                                                                                                  100%   40MB 132.0MB/s   00:00</span></span></code></pre></div><p>启动服务</p>
<div class="highlight" id="id-70"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">systemctl start kube-proxy kube-controller-manager kubelet kube-scheduler kube-apiserver</span></span></code></pre></div><p>验证版本</p>
<div class="highlight" id="id-71"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master02:~# kubectl get nodes
</span></span><span class="line"><span class="cl">NAME        STATUS                     ROLES    AGE    VERSION
</span></span><span class="line"><span class="cl">10.1.0.30   Ready,SchedulingDisabled   master   136m   v1.24.9
</span></span><span class="line"><span class="cl">10.1.0.31   Ready,SchedulingDisabled   master   46h    v1.24.2
</span></span><span class="line"><span class="cl">10.1.0.32   Ready                      node     46h    v1.24.2
</span></span><span class="line"><span class="cl">10.1.0.33   Ready                      node     46h    v1.24.2</span></span></code></pre></div><p>在另外的master节点上重复以上操作</p>
<div class="highlight" id="id-72"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/usr/local/src/kubernetes/server/bin# systemctl stop kube-proxy kube-controller-manager kubelet kube-scheduler kube-apiserver
</span></span><span class="line"><span class="cl">root@master01:/usr/local/src/kubernetes/server/bin# <span class="se">\c</span>p kube-apiserver kube-controller-manager kubelet kube-scheduler kube-proxy /usr/local/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@master01:/usr/local/src/kubernetes/server/bin# kubectl get nodes
</span></span><span class="line"><span class="cl">NAME        STATUS                     ROLES    AGE    VERSION
</span></span><span class="line"><span class="cl">10.1.0.30   Ready,SchedulingDisabled   master   142m   v1.24.9
</span></span><span class="line"><span class="cl">10.1.0.31   Ready,SchedulingDisabled   master   47h    v1.24.9
</span></span><span class="line"><span class="cl">10.1.0.32   Ready                      node     46h    v1.24.2
</span></span><span class="line"><span class="cl">10.1.0.33   Ready                      node     46h    v1.24.2</span></span></code></pre></div><p>各node节点kube-lb取消upstream注释</p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="132-升级node节点">13.2 升级node节点</h3>
<p>node节点只需要替换kubelet 和 kube-proxy 两个</p>
<p>关闭服务</p>
<div class="highlight" id="id-73"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@worker01:~# systemctl stop kubelet.service kube-proxy.service</span></span></code></pre></div><p>替换二进制文件</p>
<div class="highlight" id="id-74"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master01:/usr/local/src/kubernetes/server/bin# scp kubelet kube-proxy 10.1.0.32:/usr/local/bin
</span></span><span class="line"><span class="cl">kubelet                                                                                                                                                                                     100%  111MB 134.8MB/s   00:00    
</span></span><span class="line"><span class="cl">kube-proxy      100%   40MB 139.3MB/s   00:00
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@master01:/usr/local/src/kubernetes/server/bin# scp kubelet kube-proxy 10.1.0.33:/usr/local/bin</span></span></code></pre></div><p>启动服务</p>
<div class="highlight" id="id-75"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@worker01:~# systemctl start kubelet.service kube-proxy.service</span></span></code></pre></div><p>验证版本</p>
<div class="highlight" id="id-76"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@master02:~# kubectl get nodes
</span></span><span class="line"><span class="cl">NAME        STATUS                     ROLES    AGE    VERSION
</span></span><span class="line"><span class="cl">10.1.0.30   Ready,SchedulingDisabled   master   157m   v1.24.9
</span></span><span class="line"><span class="cl">10.1.0.31   Ready,SchedulingDisabled   master   47h    v1.24.9
</span></span><span class="line"><span class="cl">10.1.0.32   Ready                      node     46h    v1.24.9
</span></span><span class="line"><span class="cl">10.1.0.33   Ready                      node     46h    v1.24.9</span></span></code></pre></div></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2023-08-14 00:00:00">更新于 2023-08-14&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"><span><a href="/posts/kubernetes-1/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://hg-xnlog.github.io/posts/kubernetes-1/" data-title="Kubernetes 二进制部署" data-hashtags="k8s进阶训练营"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://hg-xnlog.github.io/posts/kubernetes-1/" data-hashtag="k8s进阶训练营"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="https://hg-xnlog.github.io/posts/kubernetes-1/" data-title="Kubernetes 二进制部署" data-web><i class="fa-brands fa-whatsapp fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://hg-xnlog.github.io/posts/kubernetes-1/" data-title="Kubernetes 二进制部署"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://hg-xnlog.github.io/posts/kubernetes-1/" data-title="Kubernetes 二进制部署"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Myspace" data-sharer="myspace" data-url="https://hg-xnlog.github.io/posts/kubernetes-1/" data-title="Kubernetes 二进制部署" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Blogger" data-sharer="blogger" data-url="https://hg-xnlog.github.io/posts/kubernetes-1/" data-title="Kubernetes 二进制部署" data-description=""><i class="fa-brands fa-blogger fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://hg-xnlog.github.io/posts/kubernetes-1/" data-title="Kubernetes 二进制部署"><i class="fa-brands fa-evernote fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/k8s%E8%BF%9B%E9%98%B6%E8%AE%AD%E7%BB%83%E8%90%A5/' class="post-tag">k8s进阶训练营</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/1.kubernetes%E5%9F%BA%E7%A1%80/" class="post-nav-item" rel="prev" title="Kubernetes 基础"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Kubernetes 基础</a>
      <a href="/posts/%E4%BD%BF%E7%94%A8algolia%E5%AE%9E%E7%8E%B0hugo%E6%9C%AC%E5%9C%B0%E6%99%BA%E8%83%BD%E6%90%9C%E7%B4%A2/" class="post-nav-item" rel="next" title="使用Algolia实现Hugo本地智能搜索">使用Algolia实现Hugo本地智能搜索<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2021 - 2023</span><span class="author" itemprop="copyrightHolder">
              <a href="https://github.com/ryanxin7"target="_blank" rel="external nofollow noopener noreferrer">Ryan</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"><span class="site-time" title='网站运行中……'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden="true"></i><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><a href="https://github.com/ryanxin7" title="在 GitHub 上查看源代码"target="_blank" rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/algoliasearch/algoliasearch-lite.umd.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"enablePWA":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"HFAFNY4NX2","algoliaIndex":"xn-log","algoliaSearchKey":"bd08388586b2f88b20753c17c60ba92f","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"siteTime":"2021-09-09T09:09:09+09:00"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
