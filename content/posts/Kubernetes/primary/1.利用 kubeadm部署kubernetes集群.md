---
author: Ryan
title: 利用kubeadm部署kubernetes集群
date: 2023-02-24 21:23:22
lastmod: 2023-09-15
tags:
  - kubeadm
categories:
  - Kubernetes
expirationReminder:
  enable: true
---




## 1.kubeadm 部署工具



kubeadm 是kubernetes 集群全生命周期管理工具，可用于实现集群的部署、升级/降级及卸载等。

kubeadm 的核心工具是 **kubeadm init** 和 **kubeadm join** ，前者用于创建新的控制平面节点，后者则用于将节点快速连接到指定的控制平面。



{{< admonition tip "kubeadm init" true>}}



`kubeadm init`: 这个命令用于初始化一个新的 Kubernetes  集群的控制平面节点。

在运行这个命令后，它将自动生成一个初始的控制平面配置，创建必要的证书和密钥，以及启动必要的核心组件，如 etcd、API  Server、Controller Manager 和 Scheduler。



`kubeadm join`: 这个命令用于将工作节点快速连接到已经初始化的 Kubernetes 控制平面。

当你运行 `kubeadm init` 后，它会生成一个令牌 (token) 和一个哈希 (hash)，你可以将它们用于通过 `kubeadm join` 命令将其他节点加入到集群中。

这些节点将会成为集群的工作节点，与控制平面节点协同工作。



{{< /admonition >}}



Kubernetes 中的令牌 (**token**) 在集群中用于节点加入过程的身份认证和安全通信。这些令牌由 `kubeadm` 或管理员生成，并用于在新节点首次联系 Kubernetes API Server 时进行身份验证。



{{< admonition success "Kubernetes Token" true>}}



Kubernetes 令牌是集群加入过程中的关键组成部分，它们帮助确保新节点的身份得到验证，并确保集群的安全性。

1. **加入令牌 (Join Token)**: 在使用 `kubeadm init` 初始化控制平面节点后，它会生成一个加入令牌 (Join Token)。这个令牌包括一个令牌字符串和一个哈希值。新节点需要提供这个令牌和哈希值，以便加入到集群中。通过运行 `kubeadm join` 命令并提供正确的令牌，新节点可以成功加入集群。

   

2. **预共享密钥 (Pre-shared Key)**: 加入令牌的哈希值是通过使用预共享密钥计算生成的。这个密钥存储在控制平面节点上，新节点通过令牌中的哈希值和控制平面节点上的密钥进行匹配，从而实现身份验证。这确保了只有具有有效令牌和正确密钥的节点才能加入集群。

   

3. **有效期**: 令牌通常具有一定的有效期，过期后将无法使用。这是为了安全考虑，以确保令牌不会永久存在，从而降低潜在的风险。

   

4. **令牌轮换**: 在一些情况下，管理员可能需要轮换令牌，以提高集群的安全性。`kubeadm` 提供了命令来生成新的令牌并轮换现有令牌。

{{< /admonition >}}



**其他几个可用的工具包括：**

**kubeadm config**: 这个命令用于生成和修改 `kubeadm` 的配置文件，这些配置文件包括初始化集群和加入节点时使用的配置。通过 `kubeadm config` 命令，你可以生成初始化或加入节点所需的配置文件，然后对其进行自定义修改。这使得在不同的部署环境中更容易地配置 Kubernetes 集群。

例如，你可以使用 `kubeadm config print init-defaults` 命令来生成初始化集群所需的默认配置文件，并在需要时进行修改。

**kubeadm upgrade**: 这个命令用于执行 Kubernetes 集群的升级操作。Kubernetes 的升级通常涉及到控制平面组件 (Control Plane) 和工作节点 (Worker Node) 的升级。`kubeadm upgrade` 命令提供了一种升级路径，可用于在不中断生产工作负载的情况下将集群升级到新版本。

升级过程通常包括以下步骤：

- 升级控制平面组件。
- 升级 `kubeadm` 工具本身。
- 升级工作节点。

`kubeadm upgrade` 命令可用于管理这些升级步骤，使升级过程更加平滑。

**kubeadm reset**: 这个命令用于将节点恢复到初始状态，即将节点上的 Kubernetes 组件和配置删除，从而卸载 Kubernetes。这在需要重新部署或卸载节点时非常有用。运行 `kubeadm reset` 将清除节点上的所有 Kubernetes 配置和数据。

请注意，`kubeadm reset` 只用于卸载 Kubernetes，并不会卸载容器运行时、操作系统组件或其他可能在节点上存在的软件。







## 2.集群组件运行模式

Kubernetes 集群可部署为三种部署模式或运行方式。


- **独立组件模式**：Master各组件和Node各组件直接以守护进程方式运行于节点之上，以二进制程序部署的集群隶属于此种模式。

- **静态pod模式**：控制平面的各组件以静态Pod对象形式运行在Master主机之上，而Node主机上的kubelet 和Docker 运行为系统级守护进程，Kube-proxy托管于集群上的DaemonSet控制器。

{{< admonition success "Kubernetes Token" true>}}

以下是静态 Pod 的一些关键特点和用途：

 由 kubelet 管理：静态 Pod 是由 kubelet 直接管理的，而不是通过 Kubernetes API Server 和控制器来管理。kubelet 会定期检查节点上特定目录中的静态 Pod 配置文件，并启动/停止相应的容器来维护这些 Pod。

节点级别的应用程序：静态 Pod 通常用于运行与节点相关的应用程序，例如容器化的监控代理、网络插件、日志收集器等。这些应用程序对整个节点的性能和资源利用具有重要影响，因此它们通常以静态 Pod 的方式运行。

配置文件位置：静态 Pod 的配置文件通常存储在节点上的 /etc/kubernetes/manifests 目录下。kubelet 会监视该目录并启动 Pod。每个配置文件对应一个静态 Pod。

不受控制器管理：与常规 Pod 不同，静态 Pod 不受 ReplicationController、Deployment 或其他控制器的管理。这意味着它们不会受到控制器的自动伸缩或滚动升级的影响。

用途示例：一些常见的静态 Pod 用途包括运行网络插件（如 Flannel、Calico）、容器运行时（如 Docker 或 Containerd）、kube-proxy（用于服务代理）等。

{{< /admonition >}}

- **自托管 self-hosted模式**：类型于第二种模式，但控制平面的各组件运行为Pod对象非静态，并且这些Pod 对象同样托管运行在集群之上，同样受控于DaemonSet类型控制器。


使用Kubeadm部署Kubernetes 集群可运行为第二种或第三种模式，默认为静态Pod 对象模式，当需要使用自托管模式时，可使用Kubeadm init 命令的 ``--features-gates=selfHosting`` 选项激活。

 ``--feature-gates=selfHosting`` 是Kubernetes 中的一个特性门标志（Feature Gate），用于启用或禁用特定的实验性或高级功能。特性门标志允许用户在 Kubernetes 中启用或禁用不同的功能，并且这些功能可能还没有被广泛测试或稳定。


## 3.kubeadm inti 工作流程

kubeadm 快速部署一个新的 Kubernetes 集群通常需要两个主要步骤: 在Master节点上运行Kubeadm join命令初始化控制平面,在其他节点上运行kubeadm join 命令逐一加入控制平面，进而成为集群成员。

kubeadm init 命令在内部分为多个阶段，每个阶段执行不同的任务，以确保集群的顺利初始化。

各阶段的简要说明如下：



|      阶段名称      | 阶段任务                                                     |
| :----------------: | ------------------------------------------------------------ |
|     preflight      | 初始化前的环境检查，在这个阶段，`kubeadm` 将检查主机上的一系列预定义条件，以确保它们满足 Kubernetes 的最低要求。<br />这些条件包括操作系统、内核参数、容器运行时等。 |
|   kubelet-start    | 生成kubelet 配置，其中包含了与控制平面的通信信息，如 API Server 的地址和端口，以及与其它 kubelet 节点的通信信息。kubelet 配置文件通常存储在 `/etc/kubernetes/` 目录下。 接下来启动或重启kubelet以便于静态Pod运行各服务组件。`kubeadm` 还会等待初始化 Token 的生成，初始化 Token 是用于后续节点加入集群的凭据。 |
|       certs        | 生成各种数字证书，用于确保集群通信的安全性和认证；<br />1.**CA 证书（Certificate Authority Certificate）**CA 证书是整个证书链的根证书，用于签发其他数字证书。`kubeadm` 在初始化集群时会生成一个根 CA 证书，用于签发后续组件的证书。<br />2.**API Server 证书**：API Server 证书用于加密和认证 Kubernetes 控制平面组件的通信。它通常由根 CA 证书签发，控制平面组件使用该证书来与客户端（如 `kubectl`、`kubelet`、应用程序）进行安全通信。<br />3.**Front Proxy 证书**：Front Proxy 证书用于加密和认证前端代理（front proxy）的通信。在 Kubernetes 中，前端代理是一个反向代理，用于处理集群中的控制平面请求。<br />4.**etcd 证书**：etcd 证书用于加密和认证 etcd 集群的通信。etcd 是 Kubernetes 集群的数据存储后端，用于存储集群状态和配置信息。<br />`kubeadm` 在初始化集群时会生成这些证书，并将它们分发给各个组件，以便它们能够在安全的环境中运行。 |
|     kubeconfig     | kubeconfig 阶段用于生成与集群和控制平面组件相关的 kubeconfig 文件。<br />1.**kube-apiserver kubeconfig**: 该文件包含 API Server 的地址和端口，以及与授权和身份验证相关的配置信息。<br />2.**kube-controller-manager kubeconfig**：该文件包括控制器管理器的监听地址以及与 API Server 进行身份验证所需的信息。<br />3.**kube-scheduler kubeconfig**： 该文件包括调度器的监听地址以及与 API Server 进行身份验证所需的信息。<br />4.**kubelet kubeconfig**： 该文件包含 kubelet 与 API Server 通信所需的配置信息，包括 API Server 的地址和与之通信的证书和密钥。<br />5.**admin kubeconfig**： 该文件包括 API Server 的地址和端口，以及用于身份验证的客户端证书和密钥。<br />这些 kubeconfig 文件是控制平面组件和管理员连接到集群的关键。`kubeadm` 在 kubeconfig 阶段生成这些文件，并通常将它们存储在 `/etc/kubernetes/` 目录中。管理员可以使用这些 kubeconfig 文件配置 `kubectl` 命令行工具，以便与集群进行通信和管理。 |
|   control-plane    | 该阶段会生成控制平面组件（kube-apiserver、kube-controller-manager 和 kube-scheduler）的静态 Pod 配置清单。这个配置清单包括了 kube-controller-manager 的命令行参数、监听地址、证书文件路径等信息，以及其他与控制器相关的配置。 |
|        etcd        | `etcd` 阶段用于生成本地 `etcd` 的静态 Pod 配置清单。这个配置清单用于将 `etcd` 作为一个静态 Pod 运行在控制平面节点上，负责存储集群的状态和配置信息。其中包括 `etcd` 的监听地址、证书和密钥文件路径、数据存储目录等信息。配置文件通常位于 `/etc/kubernetes/manifests/` 目录下，命名为 `etcd.yaml` 或类似的文件名。一旦静态 Pod 清单被生成并存储在正确的位置，kubelet 将检测到它，并自动启动。`etcd` 静态 Pod 运行后，它会将集群的状态和配置信息存储在指定的数据存储目录中，通常默认情况下是 `/var/lib/etcd`。 |
|   upload-config    | 该阶段的关键目标是将 `kubeadm` 和 `kubelet` 配置信息以一种集中化的方式存储在集群中，以便各个组件和节点能够共享和使用这些配置。这些配置在集群初始化过程中至关重要，因为它们决定了控制平面组件和节点如何连接和交互。通常情况下，这些 ConfigMap 资源存储在 `kube-system` 命名空间中，并具有特定的命名约定，以便其他组件能够轻松找到和使用它们。`kubeadm` 会生成的 ConfigMap，中包含了与初始化集群相关的配置信息，如 API Server 的地址和端口、证书和密钥的路径、初始化 Token 等。`kubelete` 也会生成一个 ConfigMap，其中包含了与 kubelet 相关的配置信息，如 kubelet 的 kubeconfig 文件内容、Pod 网络的配置信息等。 |
|    upload-certs    | 该阶段是初始化 Kubernetes 集群过程中的一个关键步骤，它负责将与集群安全性相关的证书文件上传到集群中，并创建一个名为 `kubeadm-certs` 的 ConfigMap 资源对象来存储这些证书，证书通常存储在 `kube-system` 命名空间中，以确保集群中的其他组件和后续加入的其他Master节点可以访问这些证书，用于控制平面组件和节点之间的安全通信和身份验证。 |
| mark-control-plane | 该阶段的主要目的是将节点标记为控制平面节点，并确保节点具备运行控制平面组件的能力。标记的节点将被集群认可为 Master 节点，这个标记告诉 Kubernetes 集群，当前节点具有控制平面组件的角色，可以运行 API Server、Controller Manager、Scheduler 等控制平面组件。并为该节点设置`node-role.kubernetes.io/master:NoSchedule  `  污点，防止其他工作负载Pod运行在当前节点上。`kubeadm` 会将控制平面节点的信息存储在 `/etc/kubernetes/cloud-config` 目录下的 `kube-controller-manager` 和 `kube-scheduler` 配置文件中，以便这些组件可以识别和管理控制平面节点。 |
|  bootstrap-token   | 该阶段用于生成引导令牌（bootstrap token），这些令牌允许新的节点加入 Kubernetes 集群的控制平面。引导令牌包含一些重要信息，如令牌的密钥、有效期限、用途等，它们允许新节点基于预共享的密钥与集群中的控制平面节点建立连接并获得身份认证。<br /><br />`bootstrap-token` 阶段的主要功能和操作：<br />1.**生成引导令牌**：会生成引导令牌，这是一个用于授权新节点加入集群的令牌。令牌通常包括一个密钥和一些元数据，以便集群可以识别和验证该令牌。<br />2.**设置令牌有效期**：引导令牌通常具有一个有效期，`kubeadm` 可以配置这个有效期，以限制令牌的使用时间。一旦令牌过期，它将不再被接受。<br />3.**指定令牌用途**：引导令牌可以配置为特定用途，例如用于加入节点、重置集群等。不同的令牌用途可能具有不同的权限和限制<br />4.**保存令牌信息**:`kubeadm` 会保存生成的令牌信息，通常在节点上的某个文件中，以便新节点可以访问这些信息。<br />5.**提供令牌给新节点**:   新节点需要具有生成的引导令牌信息才能加入集群。这些信息通常包括令牌字符串、CA 证书等。 新节点可以使用这些信息来与集群中的控制平面节点建立连接，完成节点加入过程。 |
|  kubelet-finalize  | `kubelet-finalize` 阶段的目标是确保 `kubelet` 在初始化后能够正确配置，以便它可以安全地连接到集群的控制平面，并开始管理节点上的容器和 Pod。在 TLS 引导阶段，`kubelet` 被配置为使用安全的连接与集群的控制平面通信。而在 `kubelet-finalize` 阶段，进一步更新 `kubelet` 的配置，确保其与集群的其他部分协同工作。这个更新会包括与控制平面的安全连接所需的信息，如 API Server 的地址和证书信息。除了更新 kubeconfig 文件之外，`kubelet` 的启动参数也可能需要调整。这些参数通常包括 API Server 地址、证书文件路径、密钥文件路径等。在配置更新完成后，通常需要重启 kubelet 服务，以使新的配置生效。<br /> |
|       addon        | 该阶段的主要任务是确保核心附加组件在集群中正确安装、配置和运行。这些组件对于集群的网络功能和 DNS 解析功能至关重要，它们允许 Pod 之间进行通信和发现，并提供了 Kubernetes 服务的负载均衡功能。安装和配置这些组件是 Kubernetes 初始化过程的重要一部分，确保集群的网络和 DNS 服务正常工作。 |



4.kubeadm join 工作流程